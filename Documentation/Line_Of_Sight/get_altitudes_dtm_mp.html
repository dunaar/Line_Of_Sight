<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>Line_Of_Sight.get_altitudes_dtm_mp API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../Line_Of_Sight.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;Line_Of_Sight</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#get_altitudes_vect_nb">get_altitudes_vect_nb</a>
            </li>
            <li>
                    <a class="class" href="#SharedMemoryArray">SharedMemoryArray</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SharedMemoryArray.__init__">SharedMemoryArray</a>
                        </li>
                        <li>
                                <a class="variable" href="#SharedMemoryArray.shm">shm</a>
                        </li>
                        <li>
                                <a class="variable" href="#SharedMemoryArray.array">array</a>
                        </li>
                        <li>
                                <a class="variable" href="#SharedMemoryArray.create">create</a>
                        </li>
                        <li>
                                <a class="variable" href="#SharedMemoryArray.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#SharedMemoryArray.shape">shape</a>
                        </li>
                        <li>
                                <a class="variable" href="#SharedMemoryArray.dtype">dtype</a>
                        </li>
                        <li>
                                <a class="function" href="#SharedMemoryArray.close">close</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Shm_Dtm_Loader">Shm_Dtm_Loader</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Shm_Dtm_Loader.__init__">Shm_Dtm_Loader</a>
                        </li>
                        <li>
                                <a class="variable" href="#Shm_Dtm_Loader.filename">filename</a>
                        </li>
                        <li>
                                <a class="variable" href="#Shm_Dtm_Loader.tiles_data">tiles_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#Shm_Dtm_Loader.shm_names">shm_names</a>
                        </li>
                        <li>
                                <a class="function" href="#Shm_Dtm_Loader.load_dtm_file">load_dtm_file</a>
                        </li>
                        <li>
                                <a class="function" href="#Shm_Dtm_Loader.close">close</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Shm_Dtm_User">Shm_Dtm_User</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Shm_Dtm_User.__init__">Shm_Dtm_User</a>
                        </li>
                        <li>
                                <a class="variable" href="#Shm_Dtm_User.shm_names">shm_names</a>
                        </li>
                        <li>
                                <a class="variable" href="#Shm_Dtm_User.shm_instances">shm_instances</a>
                        </li>
                        <li>
                                <a class="function" href="#Shm_Dtm_User.get_altitude">get_altitude</a>
                        </li>
                        <li>
                                <a class="function" href="#Shm_Dtm_User.get_altitudes">get_altitudes</a>
                        </li>
                        <li>
                                <a class="function" href="#Shm_Dtm_User.close">close</a>
                        </li>
                        <li>
                                <a class="variable" href="#Shm_Dtm_User.tiles_1d_array">tiles_1d_array</a>
                        </li>
                        <li>
                                <a class="variable" href="#Shm_Dtm_User.tiles_indices_array">tiles_indices_array</a>
                        </li>
                        <li>
                                <a class="variable" href="#Shm_Dtm_User.tiles_nrows_array">tiles_nrows_array</a>
                        </li>
                        <li>
                                <a class="variable" href="#Shm_Dtm_User.tiles_ncols_array">tiles_ncols_array</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#main">main</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../Line_Of_Sight.html">Line_Of_Sight</a><wbr>.get_altitudes_dtm_mp    </h1>

                        <div class="docstring"><p>Project: Line_Of_Sight
File   : get_altitudes_dtm_mp.py</p>

<p>Author: Pessel Arnaud
Date: 2025-07
Version: 1.1
GitHub: <a href="https://github.com/dunaar/Line_Of_Sight">https://github.com/dunaar/Line_Of_Sight</a>
License: MIT</p>

<p>Description:
    This script loads preprocessed SRTM15 tiles from a ZIP archive and retrieves altitudes
    for specified coordinates using shared memory for efficient data sharing between processes.
    It provides three main modes of operation:
    - loader: Loads elevation data into shared memory using SharedMemoryArray
    - user: Retrieves altitudes using existing shared memory blocks
    - standalone: Combines both functionalities and generates visualizations</p>

<pre><code>The script uses Numba for performance optimization and SharedMemoryArray with struct
for efficient shared memory management, storing metadata (dtype and shape) directly
in the shared memory blocks.
</code></pre>

<p>Examples:</p>

<p><strong>Loader</strong> mode: load data, keep shared memory available and provide shared memory block names for user mode:</p>

<p><pre><code>  python -m <a href="">Line_Of_Sight.get_altitudes_dtm_mp</a> loader srtm15_tiles_compressed.zip
</code></pre></p>

<p><strong>User</strong> mode: Get altitude using shared memory blocks:</p>

<p><pre><code>  python -m <a href="">Line_Of_Sight.get_altitudes_dtm_mp</a> user --tiles_1d_array tiles_1d_array_1234 --tiles_indices tiles_indices_1234 --tiles_nrows tiles_nrows_1234 --tiles_ncols tiles_ncols_1234 --grid-size 1000 55.22 -21.40 55.83 -20.86
</code></pre></p>

<p><strong>Standalone</strong> mode with visualization:</p>

<p><pre><code>  python -m <a href="">Line_Of_Sight.get_altitudes_dtm_mp</a> standalone srtm15_tiles_compressed.zip --grid-size 1000 55.22 -21.40 55.83 -20.86
</code></pre></p>

<p>Note:
  In user mode, only shared memory block names are required, as metadata (shape and dtype) are stored within the shared memory blocks using struct.</p>
</div>

                        <input id="mod-get_altitudes_dtm_mp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-get_altitudes_dtm_mp-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="ch">#!/usr/bin/env python3</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">Project: Line_Of_Sight</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">File   : get_altitudes_dtm_mp.py</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">Author: Pessel Arnaud</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">Date: 2025-07</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">Version: 1.1</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">GitHub: https://github.com/dunaar/Line_Of_Sight</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">License: MIT</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">Description:</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">    This script loads preprocessed SRTM15 tiles from a ZIP archive and retrieves altitudes</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">    for specified coordinates using shared memory for efficient data sharing between processes.</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">    It provides three main modes of operation:</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">    - loader: Loads elevation data into shared memory using SharedMemoryArray</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">    - user: Retrieves altitudes using existing shared memory blocks</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">    - standalone: Combines both functionalities and generates visualizations</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">    The script uses Numba for performance optimization and SharedMemoryArray with struct</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">    for efficient shared memory management, storing metadata (dtype and shape) directly</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">    in the shared memory blocks.</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">Examples:</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">  **Loader** mode: load data, keep shared memory available and provide shared memory block names for user mode:</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">  ```</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">    python -m Line_Of_Sight.get_altitudes_dtm_mp loader srtm15_tiles_compressed.zip</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">  ```</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">  **User** mode: Get altitude using shared memory blocks:</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">  ```</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">    python -m Line_Of_Sight.get_altitudes_dtm_mp user --tiles_1d_array tiles_1d_array_1234 --tiles_indices tiles_indices_1234 --tiles_nrows tiles_nrows_1234 --tiles_ncols tiles_ncols_1234 --grid-size 1000 55.22 -21.40 55.83 -20.86</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">  ```</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">  **Standalone** mode with visualization:</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">  ```</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">    python -m Line_Of_Sight.get_altitudes_dtm_mp standalone srtm15_tiles_compressed.zip --grid-size 1000 55.22 -21.40 55.83 -20.86</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">  ```</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">Note:</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">  In user mode, only shared memory block names are required, as metadata (shape and dtype) are stored within the shared memory blocks using struct.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;1.1&quot;</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="c1"># === Built-in ===</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">mmap</span><span class="w"> </span><span class="kn">import</span> <span class="n">ALLOCATIONGRANULARITY</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">shared_memory</span> <span class="k">as</span> <span class="n">shm</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="c1"># === Third-party ===</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">jit</span><span class="p">,</span> <span class="n">prange</span><span class="p">,</span> <span class="n">uint16</span><span class="p">,</span> <span class="n">uint32</span><span class="p">,</span> <span class="n">uint64</span><span class="p">,</span> <span class="n">float32</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="c1"># === Local modules ===</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.np_msgspec_msgpack_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">dec</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="nd">@jit</span><span class="p">(</span><span class="n">uint16</span><span class="p">(</span><span class="n">uint16</span><span class="p">[:],</span> <span class="n">uint64</span><span class="p">[:,:],</span> <span class="n">uint32</span><span class="p">[:,:],</span> <span class="n">uint32</span><span class="p">[:,:],</span> <span class="n">float32</span><span class="p">,</span> <span class="n">float32</span><span class="p">),</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>     <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_get_altitude_nb</span><span class="p">(</span><span class="n">tiles_1d_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tiles_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>                    <span class="n">tiles_nrows</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tiles_ncols</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>                    <span class="n">lon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lat</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">    Get altitude at a given latitude and longitude using Numba optimization.</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">    This function calculates the altitude for a single coordinate point by:</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">    1. Validating and adjusting the latitude bounds</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">    2. Converting coordinates to absolute values</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">    3. Calculating tile indices and in-tile positions</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">    4. Retrieving the altitude from the preprocessed tile data</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">    Args:</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">        tiles_1d_array (uint16[:]): 1D array containing all tile data concatenated</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">        tiles_indices (uint64[:,:]): Array mapping tile coordinates to positions in tiles_1d_array</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">        tiles_nrows (uint32[:,:]): Array containing number of rows for each tile</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">        tiles_ncols (uint32[:,:]): Array containing number of columns for each tile</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">        lon (float32): Longitude coordinate in decimal degrees</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">        lat (float32): Latitude coordinate in decimal degrees</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">    Returns:</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">        uint16: Altitude value at the specified coordinates</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>    <span class="c1"># Convert to absolute coordinates (0-360 for longitude, 0-180 for latitude)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>    <span class="n">lon_abs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">+</span> <span class="mf">180.</span><span class="p">)</span> <span class="o">%</span> <span class="mf">360.</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>    
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>    <span class="c1"># Ensure latitude is within valid bounds</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>    <span class="n">lat_abs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>    <span class="k">if</span>   <span class="n">lat_abs</span> <span class="o">&lt;</span>    <span class="mf">0.</span><span class="p">:</span> <span class="n">lat_abs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>    <span class="k">elif</span> <span class="n">lat_abs</span> <span class="o">&gt;=</span> <span class="mf">180.</span><span class="p">:</span> <span class="n">lat_abs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="o">=</span> <span class="mf">179.99998</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>    <span class="n">tile_idx_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">(</span><span class="n">lon_abs</span><span class="p">)</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>    <span class="n">tile_idx_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">(</span><span class="n">lat_abs</span><span class="p">)</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>    <span class="n">nrows</span> <span class="o">=</span> <span class="n">tiles_nrows</span><span class="p">[</span><span class="n">tile_idx_lat</span><span class="p">,</span> <span class="n">tile_idx_lon</span><span class="p">]</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>    <span class="n">ncols</span> <span class="o">=</span> <span class="n">tiles_ncols</span><span class="p">[</span><span class="n">tile_idx_lat</span><span class="p">,</span> <span class="n">tile_idx_lon</span><span class="p">]</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>    <span class="n">size</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span> <span class="o">=</span> <span class="n">nrows</span> <span class="o">*</span> <span class="n">ncols</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>    <span class="n">tile_idx_beg</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span> <span class="o">=</span> <span class="n">tiles_indices</span><span class="p">[</span><span class="n">tile_idx_lat</span><span class="p">,</span> <span class="n">tile_idx_lon</span><span class="p">]</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>    <span class="c1"># Handle special case for single-value tiles</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>    <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="k">return</span> <span class="n">tiles_1d_array</span><span class="p">[</span><span class="n">tile_idx_beg</span><span class="p">]</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>    <span class="c1"># Calculate position within the tile</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>    <span class="n">intile_idx_lon</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">(</span><span class="n">ncols</span> <span class="o">*</span> <span class="p">(</span><span class="n">lon_abs</span> <span class="o">-</span> <span class="n">tile_idx_lon</span><span class="p">))</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>    <span class="n">intile_idx_lat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">(</span><span class="n">nrows</span> <span class="o">*</span> <span class="p">(</span><span class="n">lat_abs</span> <span class="o">-</span> <span class="n">tile_idx_lat</span><span class="p">))</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>    <span class="n">intile_idx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span> <span class="o">=</span> <span class="n">intile_idx_lat</span> <span class="o">*</span> <span class="n">ncols</span> <span class="o">+</span> <span class="n">intile_idx_lon</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>    <span class="k">return</span> <span class="n">tiles_1d_array</span><span class="p">[</span><span class="n">tile_idx_beg</span> <span class="o">+</span> <span class="n">intile_idx</span><span class="p">]</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="nd">@jit</span><span class="p">(</span><span class="n">uint16</span><span class="p">[:](</span><span class="n">uint16</span><span class="p">[:],</span> <span class="n">uint64</span><span class="p">[:,:],</span> <span class="n">uint32</span><span class="p">[:,:],</span> <span class="n">uint32</span><span class="p">[:,:],</span> <span class="n">float32</span><span class="p">[:],</span> <span class="n">float32</span><span class="p">[:]),</span> <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_altitudes_vect_nb</span><span class="p">(</span><span class="n">tiles_1d_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tiles_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>                          <span class="n">tiles_nrows</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tiles_ncols</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>                          <span class="n">lons</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">lats</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">    Vectorized retrieval of altitudes for multiple coordinates.</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">    This function processes multiple coordinate pairs efficiently by:</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">    1. Creating an output array to store results</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">    2. Using parallel processing (prange) to calculate altitudes for all coordinates</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">    3. Reshaping the results to match the input dimensions</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">    Args:</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">        tiles_1d_array (uint16[:]): 1D array containing all tile data concatenated</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">        tiles_indices (uint64[:,:]): Array mapping tile coordinates to positions in tiles_1d_array</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">        tiles_nrows (uint32[:,:]): Array containing number of rows for each tile</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">        tiles_ncols (uint32[:,:]): Array containing number of columns for each tile</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">        lons (float32[:]): Array of longitude coordinates</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">        lats (float32[:]): Array of latitude coordinates</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">    Returns:</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">        uint16[:]: Array of altitude values with same shape as input coordinates</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>    <span class="c1"># Initialize output array</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>    <span class="n">alts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>    <span class="c1"># Process coordinates in parallel</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>    <span class="k">for</span> <span class="n">idx_coord</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)):</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="n">alts</span><span class="p">[</span><span class="n">idx_coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_altitude_nb</span><span class="p">(</span><span class="n">tiles_1d_array</span><span class="p">,</span> <span class="n">tiles_indices</span><span class="p">,</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>                                         <span class="n">tiles_nrows</span><span class="p">,</span> <span class="n">tiles_ncols</span><span class="p">,</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>                                         <span class="n">lons</span><span class="p">[</span><span class="n">idx_coord</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="n">idx_coord</span><span class="p">])</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>    <span class="c1"># Reshape to match input dimensions</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>    <span class="k">return</span> <span class="n">alts</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SharedMemoryArray</span><span class="p">:</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="sd">    Class for managing a shared memory array.</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="sd">    This class provides an interface for creating and accessing a shared memory array,</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="sd">    allowing multiple processes to read and write data concurrently. Uses struct for metadata</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="sd">    serialization in the format: dtype_len (uint32), dtype_str (str), shape_ndim (uint32),</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">    shape_size_dim1 (uint32), ..., shape_size_dimN (uint32).</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a><span class="sd">    Attributes:</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="sd">        shm (multiprocessing.shared_memory.SharedMemory): Shared memory block</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">        array (numpy.ndarray): Numpy array backed by shared memory</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a><span class="sd">        Initialize the SharedMemoryArray.</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="sd">        Args:</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a><span class="sd">            name (str, optional): Name of an existing shared memory block to map.</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">            shape (tuple, optional): Shape of the array for new shared memory.</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="sd">            dtype (numpy.dtype, optional): Data type of the array for new shared memory.</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="sd">        If name is provided, maps an existing shared memory block.</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">        If shape and dtype are provided, creates a new shared memory block.</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm</span>    <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">array</span>  <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>        <span class="n">metadata_struct_size</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>            <span class="c1"># Map an existing shared memory block</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_map_existing</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="k">elif</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>            <span class="c1"># Create a new shared memory block</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_create_new</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide either &#39;name&#39; or both &#39;shape&#39; and &#39;dtype&#39;&quot;</span><span class="p">)</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="sd">        Create a new shared memory block.</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="sd">        Args:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">            shape (tuple): Shape of the array.</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">            dtype (numpy.dtype): Data type of the array.</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">        Metadata struct:</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="sd">        - dtype_len (uint32)  : length of the string dtype_str.</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="sd">        - dtype_str (str)     : string representation of the dtype encoded in UTF-8.</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="sd">        - shape_ndim (uint32) : number of dimensions.</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="sd">        - shape_size_dim1, ..., shape_size_dimN (uint32) : sizes of the dimensions.</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="sd">        - Format struct : &lt;I s{MAX_DIMS} I I{shape_ndim}&gt;, where dtype_len is determined dynamically.</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>        <span class="c1"># Prepare metadata</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        <span class="n">dtype_bytes</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="n">dtype_len</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtype_bytes</span><span class="p">)</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>        <span class="n">shape_ndim</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>        <span class="c1"># Calculate metadata size</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>        <span class="c1"># I for dtype_len, I for shape_ndim, I*MAX_DIMS for shape dimensions</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>        <span class="n">metadata_struct_format</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;= I </span><span class="si">{</span><span class="n">dtype_len</span><span class="si">}</span><span class="s1">s I </span><span class="si">{</span><span class="n">shape_ndim</span><span class="si">}</span><span class="s1">I&#39;</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="n">metadata_struct_size</span>   <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">metadata_struct_format</span><span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="n">metadata_bytes</span>         <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">metadata_struct_format</span><span class="p">,</span> <span class="n">dtype_len</span><span class="p">,</span> <span class="n">dtype_bytes</span><span class="p">,</span> <span class="n">shape_ndim</span><span class="p">,</span> <span class="o">*</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>        <span class="c1"># Create shared memory</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>        <span class="n">data_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span> <span class="c1"># cast for windows compatibility</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm</span>  <span class="o">=</span> <span class="n">shm</span><span class="o">.</span><span class="n">SharedMemory</span><span class="p">(</span><span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">metadata_struct_size</span> <span class="o">+</span> <span class="n">data_size</span><span class="p">)</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>        <span class="c1"># Write metadata</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">[:</span><span class="n">metadata_struct_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_bytes</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>        <span class="c1"># Create NumPy array (initialized to zero)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">metadata_struct_size</span><span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_map_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a><span class="sd">        Map an existing shared memory block.</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="sd">        Args:</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a><span class="sd">            name (str): Name of the shared memory block.</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="c1"># Access shared memory</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading shared memory &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt;...&#39;</span><span class="p">)</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shm</span> <span class="o">=</span> <span class="n">shm</span><span class="o">.</span><span class="n">SharedMemory</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error loading shared memory &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading shared memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>        
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shared memory &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt; loaded !&#39;</span><span class="p">)</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="c1"># Read metadata</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>            <span class="c1"># Read dtype_len and shape_ndim</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>            <span class="n">dtype_len</span>  <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;=I&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>            <span class="n">offset</span>     <span class="o">=</span> <span class="mi">4</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>            <span class="n">dtype_str</span>  <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="n">dtype_len</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>            <span class="n">dtype</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype_str</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>            <span class="n">offset</span>    <span class="o">+=</span> <span class="n">dtype_len</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>            <span class="n">shape_ndim</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;=I&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>            <span class="n">offset</span>    <span class="o">+=</span> <span class="mi">4</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>            <span class="n">shape</span>      <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;=</span><span class="si">{</span><span class="n">shape_ndim</span><span class="si">}</span><span class="s1">I&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">shape_ndim</span><span class="p">])</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>            <span class="n">offset</span>    <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">shape_ndim</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error loading metadata: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read metadata: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>        
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shared memory &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt;, array parmeters: dtype = </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">, shape = </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>        <span class="n">total_size</span>   <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>        <span class="n">aligned_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_size</span> <span class="o">/</span> <span class="n">ALLOCATIONGRANULARITY</span><span class="p">))</span> <span class="o">*</span> <span class="n">ALLOCATIONGRANULARITY</span> <span class="c1"># alignment according sys page padding</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">total_size</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">&lt;=</span> <span class="n">aligned_size</span><span class="p">:</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shared memory &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt;: size mismatch! Expected </span><span class="si">{</span><span class="n">total_size</span><span class="si">}</span><span class="s1"> bytes, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">nbytes</span><span class="si">}</span><span class="s1"> bytes&#39;</span><span class="p">)</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shared memory size mismatch: expected </span><span class="si">{</span><span class="n">total_size</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">nbytes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="c1"># Create NumPy array</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>        
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shared memory &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt;: array mapped !&#39;</span><span class="p">)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>    <span class="nd">@property</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the name of the shared memory block.&quot;&quot;&quot;</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>    <span class="nd">@property</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the shape of the array.&quot;&quot;&quot;</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>    <span class="nd">@property</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the dtype of the array.&quot;&quot;&quot;</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Unlink (delete) the shared memory block.&quot;&quot;&quot;</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="p">:</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span>  <span class="c1"># Ensure the array is deleted before closing</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">:</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>                
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shm</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure the shared memory is closed when the object is deleted.&quot;&quot;&quot;</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Shm_Dtm_Loader</span><span class="p">:</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a><span class="sd">    Class for loading Digital Terrain Model (DTM) data into shared memory.</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a><span class="sd">    This class handles the loading of elevation data from ZIP archives into shared memory blocks</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a><span class="sd">    using SharedMemoryArray, making the data accessible to other processes. It manages the lifecycle</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a><span class="sd">    of shared memory, including creation, population, and cleanup.</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a><span class="sd">    Attributes:</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a><span class="sd">        filename (str): Path to the ZIP file containing elevation data</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a><span class="sd">        tiles_data (dict): Dictionary containing SharedMemoryArray instances</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a><span class="sd">        shm_names (dict): Dictionary containing shared memory block names</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a><span class="sd">        Initialize the Shm_Dtm_Loader with a filename.</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a><span class="sd">        Args:</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="sd">            filename (str): Path to the ZIP file containing elevation data</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_dtm_file</span><span class="p">()</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_dtm_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a><span class="sd">        Load tiles and metadata from a zip archive containing MessagePack-encoded data.</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="sd">        This method:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="sd">        1. Validates the input filename</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="sd">        2. Reads and decodes metadata from the ZIP archive</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="sd">        3. Creates SharedMemoryArray instances for different data components</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a><span class="sd">        4. Populates the shared memory with data from the ZIP archive</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="sd">        5. Stores names of the created shared memory blocks</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="sd">        Args:</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a><span class="sd">            filename (str, optional): Path to the ZIP file. If provided, updates the instance filename.</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="sd">        Raises:</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="sd">            ValueError: If filename is not provided</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">            FileNotFoundError: If the ZIP file is not found</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a><span class="sd">            Exception: For other errors during loading</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Filename not provided.&quot;</span><span class="p">)</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>                <span class="c1"># Load and decode metadata</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>                <span class="n">metadata</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;metadata.packed&#39;</span><span class="p">))</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>                <span class="n">tiles_lon_indices_in_bands</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_lon_indices_in_bands&#39;</span><span class="p">]</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                <span class="c1"># Create SharedMemoryArray instances for different data components</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>                <span class="n">shm_tiles_indices</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">tiles_lon_indices_in_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>                                                      <span class="n">dtype</span><span class="o">=</span><span class="n">tiles_lon_indices_in_bands</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>                <span class="n">shm_tiles_nrows</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>                                                    <span class="n">dtype</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">])</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                <span class="n">shm_tiles_ncols</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>                                                    <span class="n">dtype</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">shm_tiles_ncols</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">])</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>                <span class="c1"># Calculate cumulative indices for tiles</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>                <span class="n">idx_cumul</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>                <span class="k">for</span> <span class="n">lat_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">array</span><span class="p">)):</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                    <span class="n">band_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">shm_tiles_ncols</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                    <span class="n">shm_tiles_indices</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tiles_lon_indices_in_bands</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">idx_cumul</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                    <span class="n">idx_cumul</span> <span class="o">+=</span> <span class="n">band_size</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>                <span class="n">expected_total_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx_cumul</span><span class="p">)</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>                <span class="c1"># Process latitude bands</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>                <span class="n">lat_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>                    <span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;lat_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.packed&#39;</span><span class="p">)),</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>                <span class="p">)</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                <span class="n">band_array</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">lat_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                <span class="n">band_dtype</span> <span class="o">=</span> <span class="n">band_array</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                <span class="n">band_word_nbytes</span> <span class="o">=</span> <span class="n">band_array</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">//</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                <span class="c1"># Create SharedMemoryArray for the main tile data</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                <span class="n">shm_tiles_1d_array</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">expected_total_size</span><span class="p">,),</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                                                       <span class="n">dtype</span><span class="o">=</span><span class="n">band_dtype</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>                <span class="c1"># Load data from each latitude band</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>                <span class="n">idx_cumul</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">lat_keys</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lat_keys</span><span class="p">),</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>                               <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Loading tiles from file &lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">):</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>                    <span class="n">lat_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>                    <span class="n">band_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">shm_tiles_ncols</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>                    <span class="n">band_array</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>                    <span class="k">if</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">band_size</span><span class="p">:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Size mismatch for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">band_array</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">band_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>                    <span class="k">if</span> <span class="n">idx_cumul</span> <span class="o">+</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">shm_tiles_1d_array</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Exceeded tiles_1d_array size while loading band arrays&#39;</span><span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">shm_tiles_1d_array</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">idx_cumul</span><span class="p">:</span><span class="n">idx_cumul</span> <span class="o">+</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span><span class="p">],</span> <span class="n">band_array</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>                    <span class="n">idx_cumul</span> <span class="o">+=</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>                    <span class="k">del</span> <span class="n">band_array</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>            <span class="c1"># Store SharedMemoryArray instances</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;shm_tiles_1d_array&#39;</span><span class="p">:</span> <span class="n">shm_tiles_1d_array</span><span class="p">,</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>                               <span class="s1">&#39;shm_tiles_indices&#39;</span> <span class="p">:</span> <span class="n">shm_tiles_indices</span><span class="p">,</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>                               <span class="s1">&#39;shm_tiles_nrows&#39;</span>   <span class="p">:</span> <span class="n">shm_tiles_nrows</span><span class="p">,</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>                               <span class="s1">&#39;shm_tiles_ncols&#39;</span>   <span class="p">:</span> <span class="n">shm_tiles_ncols</span><span class="p">}</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>            <span class="c1"># Store names of shared memory blocks</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">:</span> <span class="n">shm_tiles_1d_array</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>                              <span class="s1">&#39;tiles_indices&#39;</span> <span class="p">:</span> <span class="n">shm_tiles_indices</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>                              <span class="s1">&#39;tiles_nrows&#39;</span>   <span class="p">:</span> <span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>                              <span class="s1">&#39;tiles_ncols&#39;</span>   <span class="p">:</span> <span class="n">shm_tiles_ncols</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Zip file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading DTM file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a><span class="sd">        Clean up shared memory blocks.</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a><span class="sd">        This method safely closes and unlinks all SharedMemoryArray instances that were created.</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="sd">        It handles potential errors during cleanup to ensure the process doesn&#39;t fail.</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>            <span class="k">return</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;shm_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">):</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>                <span class="n">obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> closed&quot;</span><span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Shm_Dtm_User</span><span class="p">:</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a><span class="sd">    Class for retrieving altitudes using shared memory blocks.</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a><span class="sd">    This class connects to existing shared memory blocks created by Shm_Dtm_Loader</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a><span class="sd">    using SharedMemoryArray and provides methods to retrieve altitude data for single</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a><span class="sd">    coordinates or arrays of coordinates.</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a><span class="sd">    Attributes:</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a><span class="sd">        shm_names (dict): Dictionary containing shared memory block names</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a><span class="sd">        shm_instances (dict): Dictionary containing SharedMemoryArray instances</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shm_names</span><span class="p">):</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a><span class="sd">        Initialize the Shm_Dtm_User with shared memory block names.</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a><span class="sd">        Args:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a><span class="sd">            shm_names (dict): Dictionary containing shared memory block names</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span> <span class="o">=</span> <span class="n">shm_names</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_indices&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_nrows&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_ncols&#39;</span><span class="p">):</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading shared memory </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error accessing shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_altitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">):</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a><span class="sd">        Get altitude for a single coordinate.</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a><span class="sd">        Args:</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a><span class="sd">            lon (float): Longitude in decimal degrees (-180 to 180)</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a><span class="sd">            lat (float): Latitude in decimal degrees (-90 to 90)</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a><span class="sd">        Returns:</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a><span class="sd">            uint16: Altitude value at the specified coordinates</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a><span class="sd">        Raises:</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a><span class="sd">            ValueError: If coordinates are out of valid ranges</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">180</span> <span class="o">&lt;=</span> <span class="n">lon</span> <span class="o">&lt;=</span> <span class="mi">180</span><span class="p">):</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Longitude must be between -180 and 180 degrees.&quot;</span><span class="p">)</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">lat</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">):</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Latitude must be between -90 and 90 degrees.&quot;</span><span class="p">)</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>        <span class="k">return</span> <span class="n">_get_altitude_nb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>                                <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_altitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">):</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a><span class="sd">        Get altitudes for multiple coordinates.</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a><span class="sd">        Args:</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a><span class="sd">            lons (numpy.ndarray): Array of longitude coordinates</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a><span class="sd">            lats (numpy.ndarray): Array of latitude coordinates</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a><span class="sd">        Returns:</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a><span class="sd">            numpy.ndarray: Array of altitude values with same shape as input coordinates</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a><span class="sd">        Raises:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a><span class="sd">            ValueError: If input arrays have different shapes</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="k">if</span> <span class="n">lons</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">lats</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;lons and lats must have the same shape.&quot;</span><span class="p">)</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>        <span class="k">return</span> <span class="n">get_altitudes_vect_nb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>                                      <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>                                      <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>                                      <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>                                      <span class="n">lons</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">lats</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">lons</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a><span class="sd">        Close shared memory blocks.</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a><span class="sd">        This method safely closes all SharedMemoryArray instances.</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a><span class="sd">        It handles potential errors during cleanup to ensure the process doesn&#39;t fail.</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>                    <span class="n">obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> closed&quot;</span><span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>    <span class="nd">@property</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tiles_1d_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">if</span> <span class="s1">&#39;tiles_1d_array&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>    <span class="nd">@property</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tiles_indices_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">if</span> <span class="s1">&#39;tiles_indices&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>    <span class="nd">@property</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tiles_nrows_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">if</span> <span class="s1">&#39;tiles_nrows&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>    <span class="nd">@property</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tiles_ncols_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">if</span> <span class="s1">&#39;tiles_ncols&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a><span class="c1"># %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a><span class="c1"># Main execution block</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main function handling command line arguments and execution.&quot;&quot;&quot;</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>    <span class="c1"># Configure logging only when running as main script</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(module)s</span><span class="s1"> - </span><span class="si">%(funcName)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>        <span class="n">handlers</span><span class="o">=</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()]</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>    <span class="p">)</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>    <span class="c1"># Create main argument parser</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Load preprocessed SRTM15 tiles and retrieve altitudes for specified coordinates using shared memory.&#39;</span><span class="p">,</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>        <span class="n">epilog</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a><span class="s1">Examples:</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a><span class="s1">  Load data and keep shared memory available:</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a><span class="s1">    python -m Line_Of_Sight.get_altitudes_dtm_mp loader input.zip</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a><span class="s1">  Get altitude using shared memory blocks:</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a><span class="s1">    python -m Line_Of_Sight.get_altitudes_dtm_mp user --tiles_1d_array tiles_1d_array_1234 --tiles_indices tiles_indices_1234 --tiles_nrows tiles_nrows_1234 --tiles_ncols tiles_ncols_1234 --grid-size 1000 55.22 -21.40 55.83 -20.86</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a><span class="s1">  Standalone mode with visualization:</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a><span class="s1">    python -m Line_Of_Sight.get_altitudes_dtm_mp standalone input.zip --grid-size 1000 55.22 -21.40 55.83 -20.86</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a><span class="s1">Note:</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a><span class="s1">  In user mode, only shared memory block names are required, as metadata (shape and dtype)</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a><span class="s1">  are stored within the shared memory blocks using struct.</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a><span class="s1">        &#39;&#39;&#39;</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>    <span class="p">)</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>    <span class="c1"># Create subparsers for different modes</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>    <span class="n">subparsers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Mode to run in&#39;</span><span class="p">)</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>    <span class="n">parser_load</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;loader&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run in loader mode. Loads the elevation data from a ZIP file into shared memory.&#39;</span><span class="p">)</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>    <span class="n">parser_stnd</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;standalone&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run in standalone mode. Combines the functionality of both loader and user modes and generates a heatmap.&#39;</span><span class="p">)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>    <span class="n">parser_user</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run in user mode. Uses the shared memory blocks to retrieve altitude for a single coordinate pair.&#39;</span><span class="p">)</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>    <span class="c1"># Parser for loader mode and standalone mode</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>    <span class="n">parser_load</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Input ZIP file name containing the elevation data.&#39;</span><span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>    <span class="n">parser_stnd</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Input ZIP file name containing the elevation data.&#39;</span><span class="p">)</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>    <span class="c1"># Parser for user mode and standalone mode</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>    <span class="n">parser_user</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;lonlat1&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;corner1: Longitude in decimal degrees (-180 to 180), Latitude in decimal degrees (-90 to 90)&#39;</span><span class="p">)</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>    <span class="n">parser_stnd</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;lonlat1&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;corner1: Longitude in decimal degrees (-180 to 180), Latitude in decimal degrees (-90 to 90)&#39;</span><span class="p">)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>    
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>    <span class="n">parser_user</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;lonlat2&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;corner2: Longitude in decimal degrees (-180 to 180), Latitude in decimal degrees (-90 to 90)&#39;</span><span class="p">)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>    <span class="n">parser_stnd</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;lonlat2&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;corner2: Longitude in decimal degrees (-180 to 180), Latitude in decimal degrees (-90 to 90)&#39;</span><span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>    
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>    <span class="n">parser_user</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--grid-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of points per axis for heatmap (default: 1000)&#39;</span><span class="p">)</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>    <span class="n">parser_stnd</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--grid-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of points per axis for heatmap (default: 1000)&#39;</span><span class="p">)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>    
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>    <span class="c1"># Parser for user mode</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_indices&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_nrows&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_ncols&#39;</span><span class="p">):</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>        <span class="n">parser_user</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Name of the shared memory block for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">. Example: &quot;tiles_1d_array_1234&quot;&#39;</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>    
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>    <span class="c1"># Standalone mode &amp; Loader mode: Load data into shared memory and display connection info</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;loader&#39;</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;standalone&#39;</span><span class="p">:</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading DTM file: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>        <span class="n">shm_dtm_loader</span> <span class="o">=</span> <span class="n">Shm_Dtm_Loader</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DTM file loaded successfully.&quot;</span><span class="p">)</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>    <span class="c1"># Loader mode: print information and wait for interruption then exit </span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;loader&#39;</span><span class="p">:</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>        <span class="c1"># Generate example command for user mode</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>        <span class="n">cmd_shm_params</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">shm_dtm_loader</span><span class="o">.</span><span class="n">shm_names</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Examples command for user mode:&#39;</span> <span class="o">+</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>        <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a><span class="s1">```</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a><span class="s1">python -m Line_Of_Sight.get_altitudes_dtm_mp user </span><span class="si">{</span><span class="n">cmd_shm_params</span><span class="si">}</span><span class="s1"> -5.20 48.20 -4.60 48.60 --grid-size 100</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a><span class="s1">python -m Line_Of_Sight.get_altitudes_dtm_mp user </span><span class="si">{</span><span class="n">cmd_shm_params</span><span class="si">}</span><span class="s1"> -17.00 27.90 -16.11 28.61</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a><span class="s1">python -m Line_Of_Sight.get_altitudes_dtm_mp user </span><span class="si">{</span><span class="n">cmd_shm_params</span><span class="si">}</span><span class="s1"> 55.22 -21.40 55.83 -20.86</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a><span class="s1">python -m Line_Of_Sight.get_altitudes_dtm_mp user </span><span class="si">{</span><span class="n">cmd_shm_params</span><span class="si">}</span><span class="s1"> -180 -90 180 90 --grid-size 3000</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a><span class="s1">python -m Line_Of_Sight.line_of_sight </span><span class="si">{</span><span class="n">cmd_shm_params</span><span class="si">}</span><span class="s1"> --origin -3.2 47.5 30 --target -3.3 47.6 60</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a><span class="s1">```&#39;&#39;&#39;</span><span class="p">)</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- Mode: loader --&#39;</span><span class="p">)</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loader mode completed. Shared memory blocks are ready for use: Press Ctrl+C to exit...&quot;</span><span class="p">)</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Received keyboard interrupt.&quot;</span><span class="p">)</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>    
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>    <span class="c1"># Standalone mode &amp; User mode: Retrieve shared memory names, Connect to shared memory and Retrieve altitudes</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;standalone&#39;</span><span class="p">:</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>        <span class="n">shm_names</span> <span class="o">=</span> <span class="n">shm_dtm_loader</span><span class="o">.</span><span class="n">shm_names</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span><span class="p">:</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">resource_tracker</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>        <span class="n">resource_tracker</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span> <span class="n">rtype</span><span class="p">:</span> <span class="kc">None</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>        <span class="c1"># User mode: Connect to shared memory and retrieve altitude</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>        <span class="n">shm_names</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">tiles_1d_array</span><span class="p">,</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>                     <span class="s1">&#39;tiles_indices&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">tiles_indices</span><span class="p">,</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>                     <span class="s1">&#39;tiles_nrows&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">tiles_nrows</span><span class="p">,</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>                     <span class="s1">&#39;tiles_ncols&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">tiles_ncols</span><span class="p">}</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>    <span class="c1"># Standalone mode &amp; User mode: Connect to shared memory and retrieve altitude</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;standalone&#39;</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span><span class="p">:</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>        <span class="c1"># Import matplotlib only when needed for standalone and user mode</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearSegmentedColormap</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>            <span class="n">shm_dtm_user</span> <span class="o">=</span> <span class="n">Shm_Dtm_User</span><span class="p">(</span><span class="n">shm_names</span><span class="p">)</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Shared memory blocks loaded successfully.&quot;</span><span class="p">)</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in mode: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>        
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>        <span class="k">class</span><span class="w"> </span><span class="nc">FormatCoord</span><span class="p">:</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">extent</span><span class="p">):</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">data</span>   <span class="o">=</span> <span class="n">data</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">extent</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nrows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>            <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>                <span class="n">col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">))</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>                <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrows</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">))</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrows</span><span class="p">:</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>                    <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;x=</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y=</span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, value=</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, col=</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, row=</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;x=</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y=</span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, value=NaN, col=</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, row=</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>        <span class="k">for</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="ow">in</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lonlat1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat2</span><span class="p">):</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Long: </span><span class="si">{</span><span class="n">lon</span><span class="si">:</span><span class="s1">11.6f</span><span class="si">}</span><span class="s1">, Lat: </span><span class="si">{</span><span class="n">lat</span><span class="si">:</span><span class="s1">10.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>            <span class="n">alt</span> <span class="o">=</span> <span class="n">shm_dtm_user</span><span class="o">.</span><span class="n">get_altitude</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;alt: </span><span class="si">{</span><span class="n">alt</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">m&#39;</span><span class="p">)</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>        
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>        <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lonlat1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lonlat2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>        <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lonlat1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lonlat2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>        <span class="n">lon_stp</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_max</span> <span class="o">-</span> <span class="n">lon_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">grid_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>        <span class="n">lat_stp</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_max</span> <span class="o">-</span> <span class="n">lat_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">grid_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>        <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>        <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>        <span class="n">lons_mesh</span><span class="p">,</span> <span class="n">lats_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>        
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;shm_dtm_user.get_altitudes(lons_mesh, lats_mesh)&#39;</span><span class="p">)</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>        <span class="n">alts</span> <span class="o">=</span> <span class="n">shm_dtm_user</span><span class="o">.</span><span class="n">get_altitudes</span><span class="p">(</span><span class="n">lons_mesh</span><span class="p">,</span> <span class="n">lats_mesh</span><span class="p">)</span> <span class="c1"># Numba warmpup</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>        <span class="n">alts</span> <span class="o">=</span> <span class="n">shm_dtm_user</span><span class="o">.</span><span class="n">get_altitudes</span><span class="p">(</span><span class="n">lons_mesh</span><span class="p">,</span> <span class="n">lats_mesh</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># Get altitudes for the grid</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time to get altitudes: </span><span class="si">{</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>        <span class="c1">#relief_colors = [&quot;aquamarine&quot;, &quot;darkgreen&quot;, &quot;palegreen&quot;, &quot;green&quot;, &quot;bisque&quot;, &quot;darkgoldenrod&quot;, &quot;burlywood&quot;, &quot;saddlebrown&quot;, &quot;palegoldenrod&quot;, &quot;crimson&quot;, &quot;salmon&quot;, &quot;red&quot;]</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>        <span class="n">color_sea_level</span> <span class="o">=</span> <span class="s2">&quot;#2B7BBA&quot;</span>  <span class="c1"># Deep blue for sea level</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>        <span class="n">relief_colors</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>            <span class="s2">&quot;#007000&quot;</span><span class="p">,</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>            <span class="s2">&quot;#6B8E00&quot;</span><span class="p">,</span>  
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>            <span class="s2">&quot;#00FF00&quot;</span><span class="p">,</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>            <span class="s2">&quot;#FFFF00&quot;</span><span class="p">,</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>            <span class="s2">&quot;#CD853F&quot;</span><span class="p">,</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>            <span class="s2">&quot;#A0522D&quot;</span><span class="p">,</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>            <span class="s2">&quot;#703810&quot;</span><span class="p">,</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>            <span class="s2">&quot;#404040&quot;</span><span class="p">,</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>            <span class="s2">&quot;#808080&quot;</span><span class="p">,</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>            <span class="s2">&quot;#FFFFFF&quot;</span><span class="p">,</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>            <span class="p">]</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>        <span class="n">alt_gran</span> <span class="o">=</span> <span class="mf">20.</span>  <span class="c1"># Granularity of altitude intervals in meters</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>        <span class="n">alt_min</span>  <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>        <span class="n">nb_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">relief_colors</span><span class="p">)</span> <span class="c1"># One node for each color, to be used in LinearSegmentedColormap</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>        <span class="n">nb_steps</span> <span class="o">=</span> <span class="n">nb_nodes</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Exclude water deep blue and one boundary color</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>        <span class="n">alt_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">alts</span><span class="p">)</span><span class="o">-</span><span class="n">alt_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nb_steps</span><span class="p">)</span> <span class="o">/</span> <span class="n">alt_gran</span><span class="p">)</span> <span class="o">*</span> <span class="n">alt_gran</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>        <span class="n">alt_max</span>  <span class="o">=</span> <span class="n">alt_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">nb_steps</span><span class="p">)</span> <span class="o">*</span> <span class="n">alt_step</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Altitude range        : </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">alts</span><span class="p">)</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">m to </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">alts</span><span class="p">)</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">m&#39;</span><span class="p">)</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Working altitude range: </span><span class="si">{</span><span class="n">alt_min</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">m to </span><span class="si">{</span><span class="n">alt_max</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">m&#39;</span><span class="p">)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>        <span class="c1"># Contour_levels from 0. to max altitude corresponding to each color (except water deep blue) and each interval in relief_colors</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>        <span class="n">contour_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">alt_min</span><span class="p">,</span> <span class="n">alt_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">nb_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Contour levels: </span><span class="si">{</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">level</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">contour_levels</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>        <span class="n">nodes</span>      <span class="o">=</span> <span class="n">contour_levels</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Use every second level for the colormap nodes</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Nodes: </span><span class="si">{</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">node</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">nodes</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>        <span class="n">nodes_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">nodes</span><span class="o">-</span><span class="n">nodes</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">nodes</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>  <span class="c1"># Shift nodes to start from 0</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Nodes (normalized): </span><span class="si">{</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">nodes_norm</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes_norm</span><span class="p">)</span> <span class="o">==</span> <span class="n">nb_nodes</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Number of nodes </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes_norm</span><span class="p">)</span><span class="si">}</span><span class="s1"> does not match number of colors </span><span class="si">{</span><span class="n">nb_nodes</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>        <span class="n">cmap</span>   <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;relief_cmap&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">nodes_norm</span><span class="p">,</span> <span class="n">relief_colors</span><span class="p">)))</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>        <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color_sea_level</span><span class="p">)</span>  <span class="c1"># Set color for NaN values</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a>        <span class="c1">#alts[alts &lt;= 0.0] = np.nan  # Set invalid altitudes to NaN for better visualization</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>        <span class="c1">#alts_masked = np.ma.masked_array(alts, mask=(alts &lt;= 0.), fill_value=-20)</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>        <span class="n">alts_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alts</span><span class="p">)</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>        <span class="n">alts_masked</span><span class="p">[</span><span class="n">alts_masked</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># Set</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="s1">&#39;Relief&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">alts_masked</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">lon_min</span><span class="o">-</span><span class="n">lon_stp</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">lon_max</span><span class="o">+</span><span class="n">lon_stp</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">lat_min</span><span class="o">-</span><span class="n">lat_stp</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">lat_max</span><span class="o">+</span><span class="n">lat_stp</span><span class="o">/</span><span class="mf">2.</span><span class="p">],</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a>                       <span class="n">vmin</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>  <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,)</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">format_coord</span> <span class="o">=</span> <span class="n">FormatCoord</span><span class="p">(</span><span class="n">alts</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">])</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>        <span class="c1"># Plot contour lines (black lines, linewidth 0.8)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>        <span class="n">contours</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">lons_mesh</span><span class="p">,</span> <span class="n">lats_mesh</span><span class="p">,</span> <span class="n">alts</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">contour_levels</span><span class="p">,</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>                              <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;#DDDDDD&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>        <span class="c1">#contourfs = ax.contourf(lons_mesh, lats_mesh, alts, levels=contour_levels[::2],</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>        <span class="c1">#                      linewidths=0.2, cmap=cmap, alpha=0.5)</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>        <span class="c1"># Optionally add labels to contours</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">contours</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.0f</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>        
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">contour_levels</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Altitude (m)&#39;</span><span class="p">)</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;figure_Relief_</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">grid_size</span><span class="si">}</span><span class="s1">x</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">grid_size</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>        
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a>        <span class="n">shm_dtm_user</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>    <span class="c1"># Standalone mode &amp; Loader mode: Close loader shared memory</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;loader&#39;</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;standalone&#39;</span><span class="p">:</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>        <span class="n">shm_dtm_loader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>    <span class="n">main</span><span class="p">()</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a><span class="c1"># ======================================================================</span>
</span></pre></div>


            </section>
                <section id="get_altitudes_vect_nb">
                            <input id="get_altitudes_vect_nb-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-jit">@jit(uint16[:](uint16[:], uint64[:, :], uint32[:, :], uint32[:, :], float32[:], float32[:]), nopython=True, cache=True)</div>

        <span class="def">def</span>
        <span class="name">get_altitudes_vect_nb</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">tiles_1d_array</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">tiles_indices</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">tiles_nrows</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">tiles_ncols</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">lons</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">lats</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_altitudes_vect_nb-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_altitudes_vect_nb"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_altitudes_vect_nb-120"><a href="#get_altitudes_vect_nb-120"><span class="linenos">120</span></a><span class="nd">@jit</span><span class="p">(</span><span class="n">uint16</span><span class="p">[:](</span><span class="n">uint16</span><span class="p">[:],</span> <span class="n">uint64</span><span class="p">[:,:],</span> <span class="n">uint32</span><span class="p">[:,:],</span> <span class="n">uint32</span><span class="p">[:,:],</span> <span class="n">float32</span><span class="p">[:],</span> <span class="n">float32</span><span class="p">[:]),</span> <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="get_altitudes_vect_nb-121"><a href="#get_altitudes_vect_nb-121"><span class="linenos">121</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_altitudes_vect_nb</span><span class="p">(</span><span class="n">tiles_1d_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tiles_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="get_altitudes_vect_nb-122"><a href="#get_altitudes_vect_nb-122"><span class="linenos">122</span></a>                          <span class="n">tiles_nrows</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tiles_ncols</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="get_altitudes_vect_nb-123"><a href="#get_altitudes_vect_nb-123"><span class="linenos">123</span></a>                          <span class="n">lons</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">lats</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="get_altitudes_vect_nb-124"><a href="#get_altitudes_vect_nb-124"><span class="linenos">124</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_altitudes_vect_nb-125"><a href="#get_altitudes_vect_nb-125"><span class="linenos">125</span></a><span class="sd">    Vectorized retrieval of altitudes for multiple coordinates.</span>
</span><span id="get_altitudes_vect_nb-126"><a href="#get_altitudes_vect_nb-126"><span class="linenos">126</span></a>
</span><span id="get_altitudes_vect_nb-127"><a href="#get_altitudes_vect_nb-127"><span class="linenos">127</span></a><span class="sd">    This function processes multiple coordinate pairs efficiently by:</span>
</span><span id="get_altitudes_vect_nb-128"><a href="#get_altitudes_vect_nb-128"><span class="linenos">128</span></a><span class="sd">    1. Creating an output array to store results</span>
</span><span id="get_altitudes_vect_nb-129"><a href="#get_altitudes_vect_nb-129"><span class="linenos">129</span></a><span class="sd">    2. Using parallel processing (prange) to calculate altitudes for all coordinates</span>
</span><span id="get_altitudes_vect_nb-130"><a href="#get_altitudes_vect_nb-130"><span class="linenos">130</span></a><span class="sd">    3. Reshaping the results to match the input dimensions</span>
</span><span id="get_altitudes_vect_nb-131"><a href="#get_altitudes_vect_nb-131"><span class="linenos">131</span></a>
</span><span id="get_altitudes_vect_nb-132"><a href="#get_altitudes_vect_nb-132"><span class="linenos">132</span></a><span class="sd">    Args:</span>
</span><span id="get_altitudes_vect_nb-133"><a href="#get_altitudes_vect_nb-133"><span class="linenos">133</span></a><span class="sd">        tiles_1d_array (uint16[:]): 1D array containing all tile data concatenated</span>
</span><span id="get_altitudes_vect_nb-134"><a href="#get_altitudes_vect_nb-134"><span class="linenos">134</span></a><span class="sd">        tiles_indices (uint64[:,:]): Array mapping tile coordinates to positions in tiles_1d_array</span>
</span><span id="get_altitudes_vect_nb-135"><a href="#get_altitudes_vect_nb-135"><span class="linenos">135</span></a><span class="sd">        tiles_nrows (uint32[:,:]): Array containing number of rows for each tile</span>
</span><span id="get_altitudes_vect_nb-136"><a href="#get_altitudes_vect_nb-136"><span class="linenos">136</span></a><span class="sd">        tiles_ncols (uint32[:,:]): Array containing number of columns for each tile</span>
</span><span id="get_altitudes_vect_nb-137"><a href="#get_altitudes_vect_nb-137"><span class="linenos">137</span></a><span class="sd">        lons (float32[:]): Array of longitude coordinates</span>
</span><span id="get_altitudes_vect_nb-138"><a href="#get_altitudes_vect_nb-138"><span class="linenos">138</span></a><span class="sd">        lats (float32[:]): Array of latitude coordinates</span>
</span><span id="get_altitudes_vect_nb-139"><a href="#get_altitudes_vect_nb-139"><span class="linenos">139</span></a>
</span><span id="get_altitudes_vect_nb-140"><a href="#get_altitudes_vect_nb-140"><span class="linenos">140</span></a><span class="sd">    Returns:</span>
</span><span id="get_altitudes_vect_nb-141"><a href="#get_altitudes_vect_nb-141"><span class="linenos">141</span></a><span class="sd">        uint16[:]: Array of altitude values with same shape as input coordinates</span>
</span><span id="get_altitudes_vect_nb-142"><a href="#get_altitudes_vect_nb-142"><span class="linenos">142</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_altitudes_vect_nb-143"><a href="#get_altitudes_vect_nb-143"><span class="linenos">143</span></a>    <span class="c1"># Initialize output array</span>
</span><span id="get_altitudes_vect_nb-144"><a href="#get_altitudes_vect_nb-144"><span class="linenos">144</span></a>    <span class="n">alts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="get_altitudes_vect_nb-145"><a href="#get_altitudes_vect_nb-145"><span class="linenos">145</span></a>
</span><span id="get_altitudes_vect_nb-146"><a href="#get_altitudes_vect_nb-146"><span class="linenos">146</span></a>    <span class="c1"># Process coordinates in parallel</span>
</span><span id="get_altitudes_vect_nb-147"><a href="#get_altitudes_vect_nb-147"><span class="linenos">147</span></a>    <span class="k">for</span> <span class="n">idx_coord</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)):</span>
</span><span id="get_altitudes_vect_nb-148"><a href="#get_altitudes_vect_nb-148"><span class="linenos">148</span></a>        <span class="n">alts</span><span class="p">[</span><span class="n">idx_coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_altitude_nb</span><span class="p">(</span><span class="n">tiles_1d_array</span><span class="p">,</span> <span class="n">tiles_indices</span><span class="p">,</span>
</span><span id="get_altitudes_vect_nb-149"><a href="#get_altitudes_vect_nb-149"><span class="linenos">149</span></a>                                         <span class="n">tiles_nrows</span><span class="p">,</span> <span class="n">tiles_ncols</span><span class="p">,</span>
</span><span id="get_altitudes_vect_nb-150"><a href="#get_altitudes_vect_nb-150"><span class="linenos">150</span></a>                                         <span class="n">lons</span><span class="p">[</span><span class="n">idx_coord</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="n">idx_coord</span><span class="p">])</span>
</span><span id="get_altitudes_vect_nb-151"><a href="#get_altitudes_vect_nb-151"><span class="linenos">151</span></a>
</span><span id="get_altitudes_vect_nb-152"><a href="#get_altitudes_vect_nb-152"><span class="linenos">152</span></a>    <span class="c1"># Reshape to match input dimensions</span>
</span><span id="get_altitudes_vect_nb-153"><a href="#get_altitudes_vect_nb-153"><span class="linenos">153</span></a>    <span class="k">return</span> <span class="n">alts</span>
</span></pre></div>


            <div class="docstring"><p>Vectorized retrieval of altitudes for multiple coordinates.</p>

<p>This function processes multiple coordinate pairs efficiently by:</p>

<ol>
<li>Creating an output array to store results</li>
<li>Using parallel processing (prange) to calculate altitudes for all coordinates</li>
<li>Reshaping the results to match the input dimensions</li>
</ol>

<p>Args:
    tiles_1d_array (uint16[:]): 1D array containing all tile data concatenated
    tiles_indices (uint64[:,:]): Array mapping tile coordinates to positions in tiles_1d_array
    tiles_nrows (uint32[:,:]): Array containing number of rows for each tile
    tiles_ncols (uint32[:,:]): Array containing number of columns for each tile
    lons (float32[:]): Array of longitude coordinates
    lats (float32[:]): Array of latitude coordinates</p>

<p>Returns:
    uint16[:]: Array of altitude values with same shape as input coordinates</p>
</div>


                </section>
                <section id="SharedMemoryArray">
                            <input id="SharedMemoryArray-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SharedMemoryArray</span>:

                <label class="view-source-button" for="SharedMemoryArray-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SharedMemoryArray"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SharedMemoryArray-155"><a href="#SharedMemoryArray-155"><span class="linenos">155</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SharedMemoryArray</span><span class="p">:</span>
</span><span id="SharedMemoryArray-156"><a href="#SharedMemoryArray-156"><span class="linenos">156</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-157"><a href="#SharedMemoryArray-157"><span class="linenos">157</span></a><span class="sd">    Class for managing a shared memory array.</span>
</span><span id="SharedMemoryArray-158"><a href="#SharedMemoryArray-158"><span class="linenos">158</span></a>
</span><span id="SharedMemoryArray-159"><a href="#SharedMemoryArray-159"><span class="linenos">159</span></a><span class="sd">    This class provides an interface for creating and accessing a shared memory array,</span>
</span><span id="SharedMemoryArray-160"><a href="#SharedMemoryArray-160"><span class="linenos">160</span></a><span class="sd">    allowing multiple processes to read and write data concurrently. Uses struct for metadata</span>
</span><span id="SharedMemoryArray-161"><a href="#SharedMemoryArray-161"><span class="linenos">161</span></a><span class="sd">    serialization in the format: dtype_len (uint32), dtype_str (str), shape_ndim (uint32),</span>
</span><span id="SharedMemoryArray-162"><a href="#SharedMemoryArray-162"><span class="linenos">162</span></a><span class="sd">    shape_size_dim1 (uint32), ..., shape_size_dimN (uint32).</span>
</span><span id="SharedMemoryArray-163"><a href="#SharedMemoryArray-163"><span class="linenos">163</span></a>
</span><span id="SharedMemoryArray-164"><a href="#SharedMemoryArray-164"><span class="linenos">164</span></a><span class="sd">    Attributes:</span>
</span><span id="SharedMemoryArray-165"><a href="#SharedMemoryArray-165"><span class="linenos">165</span></a><span class="sd">        shm (multiprocessing.shared_memory.SharedMemory): Shared memory block</span>
</span><span id="SharedMemoryArray-166"><a href="#SharedMemoryArray-166"><span class="linenos">166</span></a><span class="sd">        array (numpy.ndarray): Numpy array backed by shared memory</span>
</span><span id="SharedMemoryArray-167"><a href="#SharedMemoryArray-167"><span class="linenos">167</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-168"><a href="#SharedMemoryArray-168"><span class="linenos">168</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SharedMemoryArray-169"><a href="#SharedMemoryArray-169"><span class="linenos">169</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-170"><a href="#SharedMemoryArray-170"><span class="linenos">170</span></a><span class="sd">        Initialize the SharedMemoryArray.</span>
</span><span id="SharedMemoryArray-171"><a href="#SharedMemoryArray-171"><span class="linenos">171</span></a>
</span><span id="SharedMemoryArray-172"><a href="#SharedMemoryArray-172"><span class="linenos">172</span></a><span class="sd">        Args:</span>
</span><span id="SharedMemoryArray-173"><a href="#SharedMemoryArray-173"><span class="linenos">173</span></a><span class="sd">            name (str, optional): Name of an existing shared memory block to map.</span>
</span><span id="SharedMemoryArray-174"><a href="#SharedMemoryArray-174"><span class="linenos">174</span></a><span class="sd">            shape (tuple, optional): Shape of the array for new shared memory.</span>
</span><span id="SharedMemoryArray-175"><a href="#SharedMemoryArray-175"><span class="linenos">175</span></a><span class="sd">            dtype (numpy.dtype, optional): Data type of the array for new shared memory.</span>
</span><span id="SharedMemoryArray-176"><a href="#SharedMemoryArray-176"><span class="linenos">176</span></a>
</span><span id="SharedMemoryArray-177"><a href="#SharedMemoryArray-177"><span class="linenos">177</span></a><span class="sd">        If name is provided, maps an existing shared memory block.</span>
</span><span id="SharedMemoryArray-178"><a href="#SharedMemoryArray-178"><span class="linenos">178</span></a><span class="sd">        If shape and dtype are provided, creates a new shared memory block.</span>
</span><span id="SharedMemoryArray-179"><a href="#SharedMemoryArray-179"><span class="linenos">179</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-180"><a href="#SharedMemoryArray-180"><span class="linenos">180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm</span>    <span class="o">=</span> <span class="kc">None</span>
</span><span id="SharedMemoryArray-181"><a href="#SharedMemoryArray-181"><span class="linenos">181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">array</span>  <span class="o">=</span> <span class="kc">None</span>
</span><span id="SharedMemoryArray-182"><a href="#SharedMemoryArray-182"><span class="linenos">182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SharedMemoryArray-183"><a href="#SharedMemoryArray-183"><span class="linenos">183</span></a>        <span class="n">metadata_struct_size</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SharedMemoryArray-184"><a href="#SharedMemoryArray-184"><span class="linenos">184</span></a>
</span><span id="SharedMemoryArray-185"><a href="#SharedMemoryArray-185"><span class="linenos">185</span></a>        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SharedMemoryArray-186"><a href="#SharedMemoryArray-186"><span class="linenos">186</span></a>            <span class="c1"># Map an existing shared memory block</span>
</span><span id="SharedMemoryArray-187"><a href="#SharedMemoryArray-187"><span class="linenos">187</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_map_existing</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="SharedMemoryArray-188"><a href="#SharedMemoryArray-188"><span class="linenos">188</span></a>        <span class="k">elif</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SharedMemoryArray-189"><a href="#SharedMemoryArray-189"><span class="linenos">189</span></a>            <span class="c1"># Create a new shared memory block</span>
</span><span id="SharedMemoryArray-190"><a href="#SharedMemoryArray-190"><span class="linenos">190</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_create_new</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="SharedMemoryArray-191"><a href="#SharedMemoryArray-191"><span class="linenos">191</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SharedMemoryArray-192"><a href="#SharedMemoryArray-192"><span class="linenos">192</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide either &#39;name&#39; or both &#39;shape&#39; and &#39;dtype&#39;&quot;</span><span class="p">)</span>
</span><span id="SharedMemoryArray-193"><a href="#SharedMemoryArray-193"><span class="linenos">193</span></a>
</span><span id="SharedMemoryArray-194"><a href="#SharedMemoryArray-194"><span class="linenos">194</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
</span><span id="SharedMemoryArray-195"><a href="#SharedMemoryArray-195"><span class="linenos">195</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-196"><a href="#SharedMemoryArray-196"><span class="linenos">196</span></a><span class="sd">        Create a new shared memory block.</span>
</span><span id="SharedMemoryArray-197"><a href="#SharedMemoryArray-197"><span class="linenos">197</span></a>
</span><span id="SharedMemoryArray-198"><a href="#SharedMemoryArray-198"><span class="linenos">198</span></a><span class="sd">        Args:</span>
</span><span id="SharedMemoryArray-199"><a href="#SharedMemoryArray-199"><span class="linenos">199</span></a><span class="sd">            shape (tuple): Shape of the array.</span>
</span><span id="SharedMemoryArray-200"><a href="#SharedMemoryArray-200"><span class="linenos">200</span></a><span class="sd">            dtype (numpy.dtype): Data type of the array.</span>
</span><span id="SharedMemoryArray-201"><a href="#SharedMemoryArray-201"><span class="linenos">201</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-202"><a href="#SharedMemoryArray-202"><span class="linenos">202</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-203"><a href="#SharedMemoryArray-203"><span class="linenos">203</span></a><span class="sd">        Metadata struct:</span>
</span><span id="SharedMemoryArray-204"><a href="#SharedMemoryArray-204"><span class="linenos">204</span></a><span class="sd">        - dtype_len (uint32)  : length of the string dtype_str.</span>
</span><span id="SharedMemoryArray-205"><a href="#SharedMemoryArray-205"><span class="linenos">205</span></a><span class="sd">        - dtype_str (str)     : string representation of the dtype encoded in UTF-8.</span>
</span><span id="SharedMemoryArray-206"><a href="#SharedMemoryArray-206"><span class="linenos">206</span></a><span class="sd">        - shape_ndim (uint32) : number of dimensions.</span>
</span><span id="SharedMemoryArray-207"><a href="#SharedMemoryArray-207"><span class="linenos">207</span></a><span class="sd">        - shape_size_dim1, ..., shape_size_dimN (uint32) : sizes of the dimensions.</span>
</span><span id="SharedMemoryArray-208"><a href="#SharedMemoryArray-208"><span class="linenos">208</span></a><span class="sd">        - Format struct : &lt;I s{MAX_DIMS} I I{shape_ndim}&gt;, where dtype_len is determined dynamically.</span>
</span><span id="SharedMemoryArray-209"><a href="#SharedMemoryArray-209"><span class="linenos">209</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-210"><a href="#SharedMemoryArray-210"><span class="linenos">210</span></a>        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="SharedMemoryArray-211"><a href="#SharedMemoryArray-211"><span class="linenos">211</span></a>
</span><span id="SharedMemoryArray-212"><a href="#SharedMemoryArray-212"><span class="linenos">212</span></a>        <span class="c1"># Prepare metadata</span>
</span><span id="SharedMemoryArray-213"><a href="#SharedMemoryArray-213"><span class="linenos">213</span></a>        <span class="n">dtype_bytes</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="SharedMemoryArray-214"><a href="#SharedMemoryArray-214"><span class="linenos">214</span></a>        <span class="n">dtype_len</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtype_bytes</span><span class="p">)</span>
</span><span id="SharedMemoryArray-215"><a href="#SharedMemoryArray-215"><span class="linenos">215</span></a>        <span class="n">shape_ndim</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="SharedMemoryArray-216"><a href="#SharedMemoryArray-216"><span class="linenos">216</span></a>
</span><span id="SharedMemoryArray-217"><a href="#SharedMemoryArray-217"><span class="linenos">217</span></a>        <span class="c1"># Calculate metadata size</span>
</span><span id="SharedMemoryArray-218"><a href="#SharedMemoryArray-218"><span class="linenos">218</span></a>        <span class="c1"># I for dtype_len, I for shape_ndim, I*MAX_DIMS for shape dimensions</span>
</span><span id="SharedMemoryArray-219"><a href="#SharedMemoryArray-219"><span class="linenos">219</span></a>        <span class="n">metadata_struct_format</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;= I </span><span class="si">{</span><span class="n">dtype_len</span><span class="si">}</span><span class="s1">s I </span><span class="si">{</span><span class="n">shape_ndim</span><span class="si">}</span><span class="s1">I&#39;</span>
</span><span id="SharedMemoryArray-220"><a href="#SharedMemoryArray-220"><span class="linenos">220</span></a>        <span class="n">metadata_struct_size</span>   <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">metadata_struct_format</span><span class="p">)</span>
</span><span id="SharedMemoryArray-221"><a href="#SharedMemoryArray-221"><span class="linenos">221</span></a>        <span class="n">metadata_bytes</span>         <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">metadata_struct_format</span><span class="p">,</span> <span class="n">dtype_len</span><span class="p">,</span> <span class="n">dtype_bytes</span><span class="p">,</span> <span class="n">shape_ndim</span><span class="p">,</span> <span class="o">*</span><span class="n">shape</span><span class="p">)</span>
</span><span id="SharedMemoryArray-222"><a href="#SharedMemoryArray-222"><span class="linenos">222</span></a>
</span><span id="SharedMemoryArray-223"><a href="#SharedMemoryArray-223"><span class="linenos">223</span></a>        <span class="c1"># Create shared memory</span>
</span><span id="SharedMemoryArray-224"><a href="#SharedMemoryArray-224"><span class="linenos">224</span></a>        <span class="n">data_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span> <span class="c1"># cast for windows compatibility</span>
</span><span id="SharedMemoryArray-225"><a href="#SharedMemoryArray-225"><span class="linenos">225</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SharedMemoryArray-226"><a href="#SharedMemoryArray-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm</span>  <span class="o">=</span> <span class="n">shm</span><span class="o">.</span><span class="n">SharedMemory</span><span class="p">(</span><span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">metadata_struct_size</span> <span class="o">+</span> <span class="n">data_size</span><span class="p">)</span>
</span><span id="SharedMemoryArray-227"><a href="#SharedMemoryArray-227"><span class="linenos">227</span></a>
</span><span id="SharedMemoryArray-228"><a href="#SharedMemoryArray-228"><span class="linenos">228</span></a>        <span class="c1"># Write metadata</span>
</span><span id="SharedMemoryArray-229"><a href="#SharedMemoryArray-229"><span class="linenos">229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">[:</span><span class="n">metadata_struct_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_bytes</span>
</span><span id="SharedMemoryArray-230"><a href="#SharedMemoryArray-230"><span class="linenos">230</span></a>
</span><span id="SharedMemoryArray-231"><a href="#SharedMemoryArray-231"><span class="linenos">231</span></a>        <span class="c1"># Create NumPy array (initialized to zero)</span>
</span><span id="SharedMemoryArray-232"><a href="#SharedMemoryArray-232"><span class="linenos">232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">metadata_struct_size</span><span class="p">)</span>
</span><span id="SharedMemoryArray-233"><a href="#SharedMemoryArray-233"><span class="linenos">233</span></a>
</span><span id="SharedMemoryArray-234"><a href="#SharedMemoryArray-234"><span class="linenos">234</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_map_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="SharedMemoryArray-235"><a href="#SharedMemoryArray-235"><span class="linenos">235</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-236"><a href="#SharedMemoryArray-236"><span class="linenos">236</span></a><span class="sd">        Map an existing shared memory block.</span>
</span><span id="SharedMemoryArray-237"><a href="#SharedMemoryArray-237"><span class="linenos">237</span></a>
</span><span id="SharedMemoryArray-238"><a href="#SharedMemoryArray-238"><span class="linenos">238</span></a><span class="sd">        Args:</span>
</span><span id="SharedMemoryArray-239"><a href="#SharedMemoryArray-239"><span class="linenos">239</span></a><span class="sd">            name (str): Name of the shared memory block.</span>
</span><span id="SharedMemoryArray-240"><a href="#SharedMemoryArray-240"><span class="linenos">240</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-241"><a href="#SharedMemoryArray-241"><span class="linenos">241</span></a>        <span class="c1"># Access shared memory</span>
</span><span id="SharedMemoryArray-242"><a href="#SharedMemoryArray-242"><span class="linenos">242</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SharedMemoryArray-243"><a href="#SharedMemoryArray-243"><span class="linenos">243</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading shared memory &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt;...&#39;</span><span class="p">)</span>
</span><span id="SharedMemoryArray-244"><a href="#SharedMemoryArray-244"><span class="linenos">244</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SharedMemoryArray-245"><a href="#SharedMemoryArray-245"><span class="linenos">245</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shm</span> <span class="o">=</span> <span class="n">shm</span><span class="o">.</span><span class="n">SharedMemory</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</span><span id="SharedMemoryArray-246"><a href="#SharedMemoryArray-246"><span class="linenos">246</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SharedMemoryArray-247"><a href="#SharedMemoryArray-247"><span class="linenos">247</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error loading shared memory &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SharedMemoryArray-248"><a href="#SharedMemoryArray-248"><span class="linenos">248</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading shared memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SharedMemoryArray-249"><a href="#SharedMemoryArray-249"><span class="linenos">249</span></a>        
</span><span id="SharedMemoryArray-250"><a href="#SharedMemoryArray-250"><span class="linenos">250</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shared memory &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt; loaded !&#39;</span><span class="p">)</span>
</span><span id="SharedMemoryArray-251"><a href="#SharedMemoryArray-251"><span class="linenos">251</span></a>
</span><span id="SharedMemoryArray-252"><a href="#SharedMemoryArray-252"><span class="linenos">252</span></a>        <span class="c1"># Read metadata</span>
</span><span id="SharedMemoryArray-253"><a href="#SharedMemoryArray-253"><span class="linenos">253</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SharedMemoryArray-254"><a href="#SharedMemoryArray-254"><span class="linenos">254</span></a>            <span class="c1"># Read dtype_len and shape_ndim</span>
</span><span id="SharedMemoryArray-255"><a href="#SharedMemoryArray-255"><span class="linenos">255</span></a>            <span class="n">dtype_len</span>  <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;=I&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SharedMemoryArray-256"><a href="#SharedMemoryArray-256"><span class="linenos">256</span></a>            <span class="n">offset</span>     <span class="o">=</span> <span class="mi">4</span>
</span><span id="SharedMemoryArray-257"><a href="#SharedMemoryArray-257"><span class="linenos">257</span></a>
</span><span id="SharedMemoryArray-258"><a href="#SharedMemoryArray-258"><span class="linenos">258</span></a>            <span class="n">dtype_str</span>  <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="n">dtype_len</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</span><span id="SharedMemoryArray-259"><a href="#SharedMemoryArray-259"><span class="linenos">259</span></a>            <span class="n">dtype</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype_str</span><span class="p">)</span>
</span><span id="SharedMemoryArray-260"><a href="#SharedMemoryArray-260"><span class="linenos">260</span></a>            <span class="n">offset</span>    <span class="o">+=</span> <span class="n">dtype_len</span>
</span><span id="SharedMemoryArray-261"><a href="#SharedMemoryArray-261"><span class="linenos">261</span></a>
</span><span id="SharedMemoryArray-262"><a href="#SharedMemoryArray-262"><span class="linenos">262</span></a>            <span class="n">shape_ndim</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;=I&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SharedMemoryArray-263"><a href="#SharedMemoryArray-263"><span class="linenos">263</span></a>            <span class="n">offset</span>    <span class="o">+=</span> <span class="mi">4</span>
</span><span id="SharedMemoryArray-264"><a href="#SharedMemoryArray-264"><span class="linenos">264</span></a>
</span><span id="SharedMemoryArray-265"><a href="#SharedMemoryArray-265"><span class="linenos">265</span></a>            <span class="n">shape</span>      <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;=</span><span class="si">{</span><span class="n">shape_ndim</span><span class="si">}</span><span class="s1">I&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">shape_ndim</span><span class="p">])</span>
</span><span id="SharedMemoryArray-266"><a href="#SharedMemoryArray-266"><span class="linenos">266</span></a>            <span class="n">offset</span>    <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">shape_ndim</span>
</span><span id="SharedMemoryArray-267"><a href="#SharedMemoryArray-267"><span class="linenos">267</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SharedMemoryArray-268"><a href="#SharedMemoryArray-268"><span class="linenos">268</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error loading metadata: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SharedMemoryArray-269"><a href="#SharedMemoryArray-269"><span class="linenos">269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="SharedMemoryArray-270"><a href="#SharedMemoryArray-270"><span class="linenos">270</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read metadata: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SharedMemoryArray-271"><a href="#SharedMemoryArray-271"><span class="linenos">271</span></a>        
</span><span id="SharedMemoryArray-272"><a href="#SharedMemoryArray-272"><span class="linenos">272</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shared memory &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt;, array parmeters: dtype = </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">, shape = </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SharedMemoryArray-273"><a href="#SharedMemoryArray-273"><span class="linenos">273</span></a>        <span class="n">total_size</span>   <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
</span><span id="SharedMemoryArray-274"><a href="#SharedMemoryArray-274"><span class="linenos">274</span></a>        <span class="n">aligned_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_size</span> <span class="o">/</span> <span class="n">ALLOCATIONGRANULARITY</span><span class="p">))</span> <span class="o">*</span> <span class="n">ALLOCATIONGRANULARITY</span> <span class="c1"># alignment according sys page padding</span>
</span><span id="SharedMemoryArray-275"><a href="#SharedMemoryArray-275"><span class="linenos">275</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">total_size</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">&lt;=</span> <span class="n">aligned_size</span><span class="p">:</span>
</span><span id="SharedMemoryArray-276"><a href="#SharedMemoryArray-276"><span class="linenos">276</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shared memory &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt;: size mismatch! Expected </span><span class="si">{</span><span class="n">total_size</span><span class="si">}</span><span class="s1"> bytes, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">nbytes</span><span class="si">}</span><span class="s1"> bytes&#39;</span><span class="p">)</span>
</span><span id="SharedMemoryArray-277"><a href="#SharedMemoryArray-277"><span class="linenos">277</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="SharedMemoryArray-278"><a href="#SharedMemoryArray-278"><span class="linenos">278</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shared memory size mismatch: expected </span><span class="si">{</span><span class="n">total_size</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">nbytes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SharedMemoryArray-279"><a href="#SharedMemoryArray-279"><span class="linenos">279</span></a>
</span><span id="SharedMemoryArray-280"><a href="#SharedMemoryArray-280"><span class="linenos">280</span></a>        <span class="c1"># Create NumPy array</span>
</span><span id="SharedMemoryArray-281"><a href="#SharedMemoryArray-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>
</span><span id="SharedMemoryArray-282"><a href="#SharedMemoryArray-282"><span class="linenos">282</span></a>
</span><span id="SharedMemoryArray-283"><a href="#SharedMemoryArray-283"><span class="linenos">283</span></a>        
</span><span id="SharedMemoryArray-284"><a href="#SharedMemoryArray-284"><span class="linenos">284</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shared memory &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt;: array mapped !&#39;</span><span class="p">)</span>
</span><span id="SharedMemoryArray-285"><a href="#SharedMemoryArray-285"><span class="linenos">285</span></a>
</span><span id="SharedMemoryArray-286"><a href="#SharedMemoryArray-286"><span class="linenos">286</span></a>    <span class="nd">@property</span>
</span><span id="SharedMemoryArray-287"><a href="#SharedMemoryArray-287"><span class="linenos">287</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SharedMemoryArray-288"><a href="#SharedMemoryArray-288"><span class="linenos">288</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the name of the shared memory block.&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-289"><a href="#SharedMemoryArray-289"><span class="linenos">289</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="SharedMemoryArray-290"><a href="#SharedMemoryArray-290"><span class="linenos">290</span></a>
</span><span id="SharedMemoryArray-291"><a href="#SharedMemoryArray-291"><span class="linenos">291</span></a>    <span class="nd">@property</span>
</span><span id="SharedMemoryArray-292"><a href="#SharedMemoryArray-292"><span class="linenos">292</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SharedMemoryArray-293"><a href="#SharedMemoryArray-293"><span class="linenos">293</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the shape of the array.&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-294"><a href="#SharedMemoryArray-294"><span class="linenos">294</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="SharedMemoryArray-295"><a href="#SharedMemoryArray-295"><span class="linenos">295</span></a>
</span><span id="SharedMemoryArray-296"><a href="#SharedMemoryArray-296"><span class="linenos">296</span></a>    <span class="nd">@property</span>
</span><span id="SharedMemoryArray-297"><a href="#SharedMemoryArray-297"><span class="linenos">297</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SharedMemoryArray-298"><a href="#SharedMemoryArray-298"><span class="linenos">298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the dtype of the array.&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-299"><a href="#SharedMemoryArray-299"><span class="linenos">299</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="SharedMemoryArray-300"><a href="#SharedMemoryArray-300"><span class="linenos">300</span></a>
</span><span id="SharedMemoryArray-301"><a href="#SharedMemoryArray-301"><span class="linenos">301</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SharedMemoryArray-302"><a href="#SharedMemoryArray-302"><span class="linenos">302</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Unlink (delete) the shared memory block.&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-303"><a href="#SharedMemoryArray-303"><span class="linenos">303</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="p">:</span>
</span><span id="SharedMemoryArray-304"><a href="#SharedMemoryArray-304"><span class="linenos">304</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span>  <span class="c1"># Ensure the array is deleted before closing</span>
</span><span id="SharedMemoryArray-305"><a href="#SharedMemoryArray-305"><span class="linenos">305</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SharedMemoryArray-306"><a href="#SharedMemoryArray-306"><span class="linenos">306</span></a>
</span><span id="SharedMemoryArray-307"><a href="#SharedMemoryArray-307"><span class="linenos">307</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="SharedMemoryArray-308"><a href="#SharedMemoryArray-308"><span class="linenos">308</span></a>            
</span><span id="SharedMemoryArray-309"><a href="#SharedMemoryArray-309"><span class="linenos">309</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">:</span>
</span><span id="SharedMemoryArray-310"><a href="#SharedMemoryArray-310"><span class="linenos">310</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SharedMemoryArray-311"><a href="#SharedMemoryArray-311"><span class="linenos">311</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</span><span id="SharedMemoryArray-312"><a href="#SharedMemoryArray-312"><span class="linenos">312</span></a>                
</span><span id="SharedMemoryArray-313"><a href="#SharedMemoryArray-313"><span class="linenos">313</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shm</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SharedMemoryArray-314"><a href="#SharedMemoryArray-314"><span class="linenos">314</span></a>
</span><span id="SharedMemoryArray-315"><a href="#SharedMemoryArray-315"><span class="linenos">315</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SharedMemoryArray-316"><a href="#SharedMemoryArray-316"><span class="linenos">316</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure the shared memory is closed when the object is deleted.&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray-317"><a href="#SharedMemoryArray-317"><span class="linenos">317</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Class for managing a shared memory array.</p>

<p>This class provides an interface for creating and accessing a shared memory array,
allowing multiple processes to read and write data concurrently. Uses struct for metadata
serialization in the format: dtype_len (uint32), dtype_str (str), shape_ndim (uint32),
shape_size_dim1 (uint32), ..., shape_size_dimN (uint32).</p>

<p>Attributes:
    shm (multiprocessing.shared_memory.SharedMemory): Shared memory block
    array (numpy.ndarray): Numpy array backed by shared memory</p>
</div>


                            <div id="SharedMemoryArray.__init__" class="classattr">
                                        <input id="SharedMemoryArray.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SharedMemoryArray</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">name</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">shape</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">dtype</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="SharedMemoryArray.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SharedMemoryArray.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SharedMemoryArray.__init__-168"><a href="#SharedMemoryArray.__init__-168"><span class="linenos">168</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SharedMemoryArray.__init__-169"><a href="#SharedMemoryArray.__init__-169"><span class="linenos">169</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray.__init__-170"><a href="#SharedMemoryArray.__init__-170"><span class="linenos">170</span></a><span class="sd">        Initialize the SharedMemoryArray.</span>
</span><span id="SharedMemoryArray.__init__-171"><a href="#SharedMemoryArray.__init__-171"><span class="linenos">171</span></a>
</span><span id="SharedMemoryArray.__init__-172"><a href="#SharedMemoryArray.__init__-172"><span class="linenos">172</span></a><span class="sd">        Args:</span>
</span><span id="SharedMemoryArray.__init__-173"><a href="#SharedMemoryArray.__init__-173"><span class="linenos">173</span></a><span class="sd">            name (str, optional): Name of an existing shared memory block to map.</span>
</span><span id="SharedMemoryArray.__init__-174"><a href="#SharedMemoryArray.__init__-174"><span class="linenos">174</span></a><span class="sd">            shape (tuple, optional): Shape of the array for new shared memory.</span>
</span><span id="SharedMemoryArray.__init__-175"><a href="#SharedMemoryArray.__init__-175"><span class="linenos">175</span></a><span class="sd">            dtype (numpy.dtype, optional): Data type of the array for new shared memory.</span>
</span><span id="SharedMemoryArray.__init__-176"><a href="#SharedMemoryArray.__init__-176"><span class="linenos">176</span></a>
</span><span id="SharedMemoryArray.__init__-177"><a href="#SharedMemoryArray.__init__-177"><span class="linenos">177</span></a><span class="sd">        If name is provided, maps an existing shared memory block.</span>
</span><span id="SharedMemoryArray.__init__-178"><a href="#SharedMemoryArray.__init__-178"><span class="linenos">178</span></a><span class="sd">        If shape and dtype are provided, creates a new shared memory block.</span>
</span><span id="SharedMemoryArray.__init__-179"><a href="#SharedMemoryArray.__init__-179"><span class="linenos">179</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray.__init__-180"><a href="#SharedMemoryArray.__init__-180"><span class="linenos">180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm</span>    <span class="o">=</span> <span class="kc">None</span>
</span><span id="SharedMemoryArray.__init__-181"><a href="#SharedMemoryArray.__init__-181"><span class="linenos">181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">array</span>  <span class="o">=</span> <span class="kc">None</span>
</span><span id="SharedMemoryArray.__init__-182"><a href="#SharedMemoryArray.__init__-182"><span class="linenos">182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SharedMemoryArray.__init__-183"><a href="#SharedMemoryArray.__init__-183"><span class="linenos">183</span></a>        <span class="n">metadata_struct_size</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SharedMemoryArray.__init__-184"><a href="#SharedMemoryArray.__init__-184"><span class="linenos">184</span></a>
</span><span id="SharedMemoryArray.__init__-185"><a href="#SharedMemoryArray.__init__-185"><span class="linenos">185</span></a>        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SharedMemoryArray.__init__-186"><a href="#SharedMemoryArray.__init__-186"><span class="linenos">186</span></a>            <span class="c1"># Map an existing shared memory block</span>
</span><span id="SharedMemoryArray.__init__-187"><a href="#SharedMemoryArray.__init__-187"><span class="linenos">187</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_map_existing</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="SharedMemoryArray.__init__-188"><a href="#SharedMemoryArray.__init__-188"><span class="linenos">188</span></a>        <span class="k">elif</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SharedMemoryArray.__init__-189"><a href="#SharedMemoryArray.__init__-189"><span class="linenos">189</span></a>            <span class="c1"># Create a new shared memory block</span>
</span><span id="SharedMemoryArray.__init__-190"><a href="#SharedMemoryArray.__init__-190"><span class="linenos">190</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_create_new</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="SharedMemoryArray.__init__-191"><a href="#SharedMemoryArray.__init__-191"><span class="linenos">191</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SharedMemoryArray.__init__-192"><a href="#SharedMemoryArray.__init__-192"><span class="linenos">192</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide either &#39;name&#39; or both &#39;shape&#39; and &#39;dtype&#39;&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the SharedMemoryArray.</p>

<p>Args:
    name (str, optional): Name of an existing shared memory block to map.
    shape (tuple, optional): Shape of the array for new shared memory.
    dtype (numpy.dtype, optional): Data type of the array for new shared memory.</p>

<p>If name is provided, maps an existing shared memory block.
If shape and dtype are provided, creates a new shared memory block.</p>
</div>


                            </div>
                            <div id="SharedMemoryArray.shm" class="classattr">
                                <div class="attr variable">
            <span class="name">shm</span>

        
    </div>
    <a class="headerlink" href="#SharedMemoryArray.shm"></a>
    
    

                            </div>
                            <div id="SharedMemoryArray.array" class="classattr">
                                <div class="attr variable">
            <span class="name">array</span>

        
    </div>
    <a class="headerlink" href="#SharedMemoryArray.array"></a>
    
    

                            </div>
                            <div id="SharedMemoryArray.create" class="classattr">
                                <div class="attr variable">
            <span class="name">create</span>

        
    </div>
    <a class="headerlink" href="#SharedMemoryArray.create"></a>
    
    

                            </div>
                            <div id="SharedMemoryArray.name" class="classattr">
                                        <input id="SharedMemoryArray.name-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">name</span>

                <label class="view-source-button" for="SharedMemoryArray.name-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SharedMemoryArray.name"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SharedMemoryArray.name-286"><a href="#SharedMemoryArray.name-286"><span class="linenos">286</span></a>    <span class="nd">@property</span>
</span><span id="SharedMemoryArray.name-287"><a href="#SharedMemoryArray.name-287"><span class="linenos">287</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SharedMemoryArray.name-288"><a href="#SharedMemoryArray.name-288"><span class="linenos">288</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the name of the shared memory block.&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray.name-289"><a href="#SharedMemoryArray.name-289"><span class="linenos">289</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span> <span class="k">else</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Return the name of the shared memory block.</p>
</div>


                            </div>
                            <div id="SharedMemoryArray.shape" class="classattr">
                                        <input id="SharedMemoryArray.shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">shape</span>

                <label class="view-source-button" for="SharedMemoryArray.shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SharedMemoryArray.shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SharedMemoryArray.shape-291"><a href="#SharedMemoryArray.shape-291"><span class="linenos">291</span></a>    <span class="nd">@property</span>
</span><span id="SharedMemoryArray.shape-292"><a href="#SharedMemoryArray.shape-292"><span class="linenos">292</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SharedMemoryArray.shape-293"><a href="#SharedMemoryArray.shape-293"><span class="linenos">293</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the shape of the array.&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray.shape-294"><a href="#SharedMemoryArray.shape-294"><span class="linenos">294</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Return the shape of the array.</p>
</div>


                            </div>
                            <div id="SharedMemoryArray.dtype" class="classattr">
                                        <input id="SharedMemoryArray.dtype-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">dtype</span>

                <label class="view-source-button" for="SharedMemoryArray.dtype-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SharedMemoryArray.dtype"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SharedMemoryArray.dtype-296"><a href="#SharedMemoryArray.dtype-296"><span class="linenos">296</span></a>    <span class="nd">@property</span>
</span><span id="SharedMemoryArray.dtype-297"><a href="#SharedMemoryArray.dtype-297"><span class="linenos">297</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SharedMemoryArray.dtype-298"><a href="#SharedMemoryArray.dtype-298"><span class="linenos">298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the dtype of the array.&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray.dtype-299"><a href="#SharedMemoryArray.dtype-299"><span class="linenos">299</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Return the dtype of the array.</p>
</div>


                            </div>
                            <div id="SharedMemoryArray.close" class="classattr">
                                        <input id="SharedMemoryArray.close-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">close</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SharedMemoryArray.close-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SharedMemoryArray.close"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SharedMemoryArray.close-301"><a href="#SharedMemoryArray.close-301"><span class="linenos">301</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SharedMemoryArray.close-302"><a href="#SharedMemoryArray.close-302"><span class="linenos">302</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Unlink (delete) the shared memory block.&quot;&quot;&quot;</span>
</span><span id="SharedMemoryArray.close-303"><a href="#SharedMemoryArray.close-303"><span class="linenos">303</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="p">:</span>
</span><span id="SharedMemoryArray.close-304"><a href="#SharedMemoryArray.close-304"><span class="linenos">304</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span>  <span class="c1"># Ensure the array is deleted before closing</span>
</span><span id="SharedMemoryArray.close-305"><a href="#SharedMemoryArray.close-305"><span class="linenos">305</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SharedMemoryArray.close-306"><a href="#SharedMemoryArray.close-306"><span class="linenos">306</span></a>
</span><span id="SharedMemoryArray.close-307"><a href="#SharedMemoryArray.close-307"><span class="linenos">307</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="SharedMemoryArray.close-308"><a href="#SharedMemoryArray.close-308"><span class="linenos">308</span></a>            
</span><span id="SharedMemoryArray.close-309"><a href="#SharedMemoryArray.close-309"><span class="linenos">309</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">:</span>
</span><span id="SharedMemoryArray.close-310"><a href="#SharedMemoryArray.close-310"><span class="linenos">310</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SharedMemoryArray.close-311"><a href="#SharedMemoryArray.close-311"><span class="linenos">311</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">shm</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</span><span id="SharedMemoryArray.close-312"><a href="#SharedMemoryArray.close-312"><span class="linenos">312</span></a>                
</span><span id="SharedMemoryArray.close-313"><a href="#SharedMemoryArray.close-313"><span class="linenos">313</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shm</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Unlink (delete) the shared memory block.</p>
</div>


                            </div>
                </section>
                <section id="Shm_Dtm_Loader">
                            <input id="Shm_Dtm_Loader-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Shm_Dtm_Loader</span>:

                <label class="view-source-button" for="Shm_Dtm_Loader-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Shm_Dtm_Loader"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Shm_Dtm_Loader-319"><a href="#Shm_Dtm_Loader-319"><span class="linenos">319</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Shm_Dtm_Loader</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader-320"><a href="#Shm_Dtm_Loader-320"><span class="linenos">320</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_Loader-321"><a href="#Shm_Dtm_Loader-321"><span class="linenos">321</span></a><span class="sd">    Class for loading Digital Terrain Model (DTM) data into shared memory.</span>
</span><span id="Shm_Dtm_Loader-322"><a href="#Shm_Dtm_Loader-322"><span class="linenos">322</span></a>
</span><span id="Shm_Dtm_Loader-323"><a href="#Shm_Dtm_Loader-323"><span class="linenos">323</span></a><span class="sd">    This class handles the loading of elevation data from ZIP archives into shared memory blocks</span>
</span><span id="Shm_Dtm_Loader-324"><a href="#Shm_Dtm_Loader-324"><span class="linenos">324</span></a><span class="sd">    using SharedMemoryArray, making the data accessible to other processes. It manages the lifecycle</span>
</span><span id="Shm_Dtm_Loader-325"><a href="#Shm_Dtm_Loader-325"><span class="linenos">325</span></a><span class="sd">    of shared memory, including creation, population, and cleanup.</span>
</span><span id="Shm_Dtm_Loader-326"><a href="#Shm_Dtm_Loader-326"><span class="linenos">326</span></a>
</span><span id="Shm_Dtm_Loader-327"><a href="#Shm_Dtm_Loader-327"><span class="linenos">327</span></a><span class="sd">    Attributes:</span>
</span><span id="Shm_Dtm_Loader-328"><a href="#Shm_Dtm_Loader-328"><span class="linenos">328</span></a><span class="sd">        filename (str): Path to the ZIP file containing elevation data</span>
</span><span id="Shm_Dtm_Loader-329"><a href="#Shm_Dtm_Loader-329"><span class="linenos">329</span></a><span class="sd">        tiles_data (dict): Dictionary containing SharedMemoryArray instances</span>
</span><span id="Shm_Dtm_Loader-330"><a href="#Shm_Dtm_Loader-330"><span class="linenos">330</span></a><span class="sd">        shm_names (dict): Dictionary containing shared memory block names</span>
</span><span id="Shm_Dtm_Loader-331"><a href="#Shm_Dtm_Loader-331"><span class="linenos">331</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_Loader-332"><a href="#Shm_Dtm_Loader-332"><span class="linenos">332</span></a>
</span><span id="Shm_Dtm_Loader-333"><a href="#Shm_Dtm_Loader-333"><span class="linenos">333</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader-334"><a href="#Shm_Dtm_Loader-334"><span class="linenos">334</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_Loader-335"><a href="#Shm_Dtm_Loader-335"><span class="linenos">335</span></a><span class="sd">        Initialize the Shm_Dtm_Loader with a filename.</span>
</span><span id="Shm_Dtm_Loader-336"><a href="#Shm_Dtm_Loader-336"><span class="linenos">336</span></a>
</span><span id="Shm_Dtm_Loader-337"><a href="#Shm_Dtm_Loader-337"><span class="linenos">337</span></a><span class="sd">        Args:</span>
</span><span id="Shm_Dtm_Loader-338"><a href="#Shm_Dtm_Loader-338"><span class="linenos">338</span></a><span class="sd">            filename (str): Path to the ZIP file containing elevation data</span>
</span><span id="Shm_Dtm_Loader-339"><a href="#Shm_Dtm_Loader-339"><span class="linenos">339</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_Loader-340"><a href="#Shm_Dtm_Loader-340"><span class="linenos">340</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
</span><span id="Shm_Dtm_Loader-341"><a href="#Shm_Dtm_Loader-341"><span class="linenos">341</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Shm_Dtm_Loader-342"><a href="#Shm_Dtm_Loader-342"><span class="linenos">342</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Shm_Dtm_Loader-343"><a href="#Shm_Dtm_Loader-343"><span class="linenos">343</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_dtm_file</span><span class="p">()</span>
</span><span id="Shm_Dtm_Loader-344"><a href="#Shm_Dtm_Loader-344"><span class="linenos">344</span></a>
</span><span id="Shm_Dtm_Loader-345"><a href="#Shm_Dtm_Loader-345"><span class="linenos">345</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_dtm_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Shm_Dtm_Loader-346"><a href="#Shm_Dtm_Loader-346"><span class="linenos">346</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_Loader-347"><a href="#Shm_Dtm_Loader-347"><span class="linenos">347</span></a><span class="sd">        Load tiles and metadata from a zip archive containing MessagePack-encoded data.</span>
</span><span id="Shm_Dtm_Loader-348"><a href="#Shm_Dtm_Loader-348"><span class="linenos">348</span></a>
</span><span id="Shm_Dtm_Loader-349"><a href="#Shm_Dtm_Loader-349"><span class="linenos">349</span></a><span class="sd">        This method:</span>
</span><span id="Shm_Dtm_Loader-350"><a href="#Shm_Dtm_Loader-350"><span class="linenos">350</span></a><span class="sd">        1. Validates the input filename</span>
</span><span id="Shm_Dtm_Loader-351"><a href="#Shm_Dtm_Loader-351"><span class="linenos">351</span></a><span class="sd">        2. Reads and decodes metadata from the ZIP archive</span>
</span><span id="Shm_Dtm_Loader-352"><a href="#Shm_Dtm_Loader-352"><span class="linenos">352</span></a><span class="sd">        3. Creates SharedMemoryArray instances for different data components</span>
</span><span id="Shm_Dtm_Loader-353"><a href="#Shm_Dtm_Loader-353"><span class="linenos">353</span></a><span class="sd">        4. Populates the shared memory with data from the ZIP archive</span>
</span><span id="Shm_Dtm_Loader-354"><a href="#Shm_Dtm_Loader-354"><span class="linenos">354</span></a><span class="sd">        5. Stores names of the created shared memory blocks</span>
</span><span id="Shm_Dtm_Loader-355"><a href="#Shm_Dtm_Loader-355"><span class="linenos">355</span></a>
</span><span id="Shm_Dtm_Loader-356"><a href="#Shm_Dtm_Loader-356"><span class="linenos">356</span></a><span class="sd">        Args:</span>
</span><span id="Shm_Dtm_Loader-357"><a href="#Shm_Dtm_Loader-357"><span class="linenos">357</span></a><span class="sd">            filename (str, optional): Path to the ZIP file. If provided, updates the instance filename.</span>
</span><span id="Shm_Dtm_Loader-358"><a href="#Shm_Dtm_Loader-358"><span class="linenos">358</span></a>
</span><span id="Shm_Dtm_Loader-359"><a href="#Shm_Dtm_Loader-359"><span class="linenos">359</span></a><span class="sd">        Raises:</span>
</span><span id="Shm_Dtm_Loader-360"><a href="#Shm_Dtm_Loader-360"><span class="linenos">360</span></a><span class="sd">            ValueError: If filename is not provided</span>
</span><span id="Shm_Dtm_Loader-361"><a href="#Shm_Dtm_Loader-361"><span class="linenos">361</span></a><span class="sd">            FileNotFoundError: If the ZIP file is not found</span>
</span><span id="Shm_Dtm_Loader-362"><a href="#Shm_Dtm_Loader-362"><span class="linenos">362</span></a><span class="sd">            Exception: For other errors during loading</span>
</span><span id="Shm_Dtm_Loader-363"><a href="#Shm_Dtm_Loader-363"><span class="linenos">363</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_Loader-364"><a href="#Shm_Dtm_Loader-364"><span class="linenos">364</span></a>        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader-365"><a href="#Shm_Dtm_Loader-365"><span class="linenos">365</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Shm_Dtm_Loader-366"><a href="#Shm_Dtm_Loader-366"><span class="linenos">366</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
</span><span id="Shm_Dtm_Loader-367"><a href="#Shm_Dtm_Loader-367"><span class="linenos">367</span></a>
</span><span id="Shm_Dtm_Loader-368"><a href="#Shm_Dtm_Loader-368"><span class="linenos">368</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader-369"><a href="#Shm_Dtm_Loader-369"><span class="linenos">369</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Filename not provided.&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader-370"><a href="#Shm_Dtm_Loader-370"><span class="linenos">370</span></a>
</span><span id="Shm_Dtm_Loader-371"><a href="#Shm_Dtm_Loader-371"><span class="linenos">371</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Shm_Dtm_Loader-372"><a href="#Shm_Dtm_Loader-372"><span class="linenos">372</span></a>
</span><span id="Shm_Dtm_Loader-373"><a href="#Shm_Dtm_Loader-373"><span class="linenos">373</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader-374"><a href="#Shm_Dtm_Loader-374"><span class="linenos">374</span></a>            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader-375"><a href="#Shm_Dtm_Loader-375"><span class="linenos">375</span></a>                <span class="c1"># Load and decode metadata</span>
</span><span id="Shm_Dtm_Loader-376"><a href="#Shm_Dtm_Loader-376"><span class="linenos">376</span></a>                <span class="n">metadata</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;metadata.packed&#39;</span><span class="p">))</span>
</span><span id="Shm_Dtm_Loader-377"><a href="#Shm_Dtm_Loader-377"><span class="linenos">377</span></a>                <span class="n">tiles_lon_indices_in_bands</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_lon_indices_in_bands&#39;</span><span class="p">]</span>
</span><span id="Shm_Dtm_Loader-378"><a href="#Shm_Dtm_Loader-378"><span class="linenos">378</span></a>
</span><span id="Shm_Dtm_Loader-379"><a href="#Shm_Dtm_Loader-379"><span class="linenos">379</span></a>                <span class="c1"># Create SharedMemoryArray instances for different data components</span>
</span><span id="Shm_Dtm_Loader-380"><a href="#Shm_Dtm_Loader-380"><span class="linenos">380</span></a>                <span class="n">shm_tiles_indices</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">tiles_lon_indices_in_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader-381"><a href="#Shm_Dtm_Loader-381"><span class="linenos">381</span></a>                                                      <span class="n">dtype</span><span class="o">=</span><span class="n">tiles_lon_indices_in_bands</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader-382"><a href="#Shm_Dtm_Loader-382"><span class="linenos">382</span></a>
</span><span id="Shm_Dtm_Loader-383"><a href="#Shm_Dtm_Loader-383"><span class="linenos">383</span></a>                <span class="n">shm_tiles_nrows</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader-384"><a href="#Shm_Dtm_Loader-384"><span class="linenos">384</span></a>                                                    <span class="n">dtype</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader-385"><a href="#Shm_Dtm_Loader-385"><span class="linenos">385</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">])</span>
</span><span id="Shm_Dtm_Loader-386"><a href="#Shm_Dtm_Loader-386"><span class="linenos">386</span></a>
</span><span id="Shm_Dtm_Loader-387"><a href="#Shm_Dtm_Loader-387"><span class="linenos">387</span></a>                <span class="n">shm_tiles_ncols</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader-388"><a href="#Shm_Dtm_Loader-388"><span class="linenos">388</span></a>                                                    <span class="n">dtype</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader-389"><a href="#Shm_Dtm_Loader-389"><span class="linenos">389</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">shm_tiles_ncols</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">])</span>
</span><span id="Shm_Dtm_Loader-390"><a href="#Shm_Dtm_Loader-390"><span class="linenos">390</span></a>
</span><span id="Shm_Dtm_Loader-391"><a href="#Shm_Dtm_Loader-391"><span class="linenos">391</span></a>                <span class="c1"># Calculate cumulative indices for tiles</span>
</span><span id="Shm_Dtm_Loader-392"><a href="#Shm_Dtm_Loader-392"><span class="linenos">392</span></a>                <span class="n">idx_cumul</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Shm_Dtm_Loader-393"><a href="#Shm_Dtm_Loader-393"><span class="linenos">393</span></a>                <span class="k">for</span> <span class="n">lat_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">array</span><span class="p">)):</span>
</span><span id="Shm_Dtm_Loader-394"><a href="#Shm_Dtm_Loader-394"><span class="linenos">394</span></a>                    <span class="n">band_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">shm_tiles_ncols</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="Shm_Dtm_Loader-395"><a href="#Shm_Dtm_Loader-395"><span class="linenos">395</span></a>                    <span class="n">shm_tiles_indices</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tiles_lon_indices_in_bands</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">idx_cumul</span>
</span><span id="Shm_Dtm_Loader-396"><a href="#Shm_Dtm_Loader-396"><span class="linenos">396</span></a>                    <span class="n">idx_cumul</span> <span class="o">+=</span> <span class="n">band_size</span>
</span><span id="Shm_Dtm_Loader-397"><a href="#Shm_Dtm_Loader-397"><span class="linenos">397</span></a>
</span><span id="Shm_Dtm_Loader-398"><a href="#Shm_Dtm_Loader-398"><span class="linenos">398</span></a>                <span class="n">expected_total_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx_cumul</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader-399"><a href="#Shm_Dtm_Loader-399"><span class="linenos">399</span></a>
</span><span id="Shm_Dtm_Loader-400"><a href="#Shm_Dtm_Loader-400"><span class="linenos">400</span></a>                <span class="c1"># Process latitude bands</span>
</span><span id="Shm_Dtm_Loader-401"><a href="#Shm_Dtm_Loader-401"><span class="linenos">401</span></a>                <span class="n">lat_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="Shm_Dtm_Loader-402"><a href="#Shm_Dtm_Loader-402"><span class="linenos">402</span></a>                    <span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;lat_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.packed&#39;</span><span class="p">)),</span>
</span><span id="Shm_Dtm_Loader-403"><a href="#Shm_Dtm_Loader-403"><span class="linenos">403</span></a>                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Shm_Dtm_Loader-404"><a href="#Shm_Dtm_Loader-404"><span class="linenos">404</span></a>                <span class="p">)</span>
</span><span id="Shm_Dtm_Loader-405"><a href="#Shm_Dtm_Loader-405"><span class="linenos">405</span></a>
</span><span id="Shm_Dtm_Loader-406"><a href="#Shm_Dtm_Loader-406"><span class="linenos">406</span></a>                <span class="n">band_array</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">lat_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="Shm_Dtm_Loader-407"><a href="#Shm_Dtm_Loader-407"><span class="linenos">407</span></a>                <span class="n">band_dtype</span> <span class="o">=</span> <span class="n">band_array</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="Shm_Dtm_Loader-408"><a href="#Shm_Dtm_Loader-408"><span class="linenos">408</span></a>                <span class="n">band_word_nbytes</span> <span class="o">=</span> <span class="n">band_array</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">//</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span>
</span><span id="Shm_Dtm_Loader-409"><a href="#Shm_Dtm_Loader-409"><span class="linenos">409</span></a>
</span><span id="Shm_Dtm_Loader-410"><a href="#Shm_Dtm_Loader-410"><span class="linenos">410</span></a>                <span class="c1"># Create SharedMemoryArray for the main tile data</span>
</span><span id="Shm_Dtm_Loader-411"><a href="#Shm_Dtm_Loader-411"><span class="linenos">411</span></a>                <span class="n">shm_tiles_1d_array</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">expected_total_size</span><span class="p">,),</span>
</span><span id="Shm_Dtm_Loader-412"><a href="#Shm_Dtm_Loader-412"><span class="linenos">412</span></a>                                                       <span class="n">dtype</span><span class="o">=</span><span class="n">band_dtype</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader-413"><a href="#Shm_Dtm_Loader-413"><span class="linenos">413</span></a>
</span><span id="Shm_Dtm_Loader-414"><a href="#Shm_Dtm_Loader-414"><span class="linenos">414</span></a>                <span class="c1"># Load data from each latitude band</span>
</span><span id="Shm_Dtm_Loader-415"><a href="#Shm_Dtm_Loader-415"><span class="linenos">415</span></a>                <span class="n">idx_cumul</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Shm_Dtm_Loader-416"><a href="#Shm_Dtm_Loader-416"><span class="linenos">416</span></a>                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">lat_keys</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lat_keys</span><span class="p">),</span>
</span><span id="Shm_Dtm_Loader-417"><a href="#Shm_Dtm_Loader-417"><span class="linenos">417</span></a>                               <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Loading tiles from file &lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">):</span>
</span><span id="Shm_Dtm_Loader-418"><a href="#Shm_Dtm_Loader-418"><span class="linenos">418</span></a>                    <span class="n">lat_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Shm_Dtm_Loader-419"><a href="#Shm_Dtm_Loader-419"><span class="linenos">419</span></a>                    <span class="n">band_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">shm_tiles_ncols</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="Shm_Dtm_Loader-420"><a href="#Shm_Dtm_Loader-420"><span class="linenos">420</span></a>
</span><span id="Shm_Dtm_Loader-421"><a href="#Shm_Dtm_Loader-421"><span class="linenos">421</span></a>                    <span class="n">band_array</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</span><span id="Shm_Dtm_Loader-422"><a href="#Shm_Dtm_Loader-422"><span class="linenos">422</span></a>                    <span class="k">if</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">band_size</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader-423"><a href="#Shm_Dtm_Loader-423"><span class="linenos">423</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Size mismatch for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">band_array</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">band_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader-424"><a href="#Shm_Dtm_Loader-424"><span class="linenos">424</span></a>
</span><span id="Shm_Dtm_Loader-425"><a href="#Shm_Dtm_Loader-425"><span class="linenos">425</span></a>                    <span class="k">if</span> <span class="n">idx_cumul</span> <span class="o">+</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">shm_tiles_1d_array</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader-426"><a href="#Shm_Dtm_Loader-426"><span class="linenos">426</span></a>                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Exceeded tiles_1d_array size while loading band arrays&#39;</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader-427"><a href="#Shm_Dtm_Loader-427"><span class="linenos">427</span></a>
</span><span id="Shm_Dtm_Loader-428"><a href="#Shm_Dtm_Loader-428"><span class="linenos">428</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">shm_tiles_1d_array</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">idx_cumul</span><span class="p">:</span><span class="n">idx_cumul</span> <span class="o">+</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span><span class="p">],</span> <span class="n">band_array</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader-429"><a href="#Shm_Dtm_Loader-429"><span class="linenos">429</span></a>                    <span class="n">idx_cumul</span> <span class="o">+=</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span>
</span><span id="Shm_Dtm_Loader-430"><a href="#Shm_Dtm_Loader-430"><span class="linenos">430</span></a>                    <span class="k">del</span> <span class="n">band_array</span>
</span><span id="Shm_Dtm_Loader-431"><a href="#Shm_Dtm_Loader-431"><span class="linenos">431</span></a>
</span><span id="Shm_Dtm_Loader-432"><a href="#Shm_Dtm_Loader-432"><span class="linenos">432</span></a>            <span class="c1"># Store SharedMemoryArray instances</span>
</span><span id="Shm_Dtm_Loader-433"><a href="#Shm_Dtm_Loader-433"><span class="linenos">433</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;shm_tiles_1d_array&#39;</span><span class="p">:</span> <span class="n">shm_tiles_1d_array</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader-434"><a href="#Shm_Dtm_Loader-434"><span class="linenos">434</span></a>                               <span class="s1">&#39;shm_tiles_indices&#39;</span> <span class="p">:</span> <span class="n">shm_tiles_indices</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader-435"><a href="#Shm_Dtm_Loader-435"><span class="linenos">435</span></a>                               <span class="s1">&#39;shm_tiles_nrows&#39;</span>   <span class="p">:</span> <span class="n">shm_tiles_nrows</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader-436"><a href="#Shm_Dtm_Loader-436"><span class="linenos">436</span></a>                               <span class="s1">&#39;shm_tiles_ncols&#39;</span>   <span class="p">:</span> <span class="n">shm_tiles_ncols</span><span class="p">}</span>
</span><span id="Shm_Dtm_Loader-437"><a href="#Shm_Dtm_Loader-437"><span class="linenos">437</span></a>
</span><span id="Shm_Dtm_Loader-438"><a href="#Shm_Dtm_Loader-438"><span class="linenos">438</span></a>            <span class="c1"># Store names of shared memory blocks</span>
</span><span id="Shm_Dtm_Loader-439"><a href="#Shm_Dtm_Loader-439"><span class="linenos">439</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">:</span> <span class="n">shm_tiles_1d_array</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader-440"><a href="#Shm_Dtm_Loader-440"><span class="linenos">440</span></a>                              <span class="s1">&#39;tiles_indices&#39;</span> <span class="p">:</span> <span class="n">shm_tiles_indices</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader-441"><a href="#Shm_Dtm_Loader-441"><span class="linenos">441</span></a>                              <span class="s1">&#39;tiles_nrows&#39;</span>   <span class="p">:</span> <span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader-442"><a href="#Shm_Dtm_Loader-442"><span class="linenos">442</span></a>                              <span class="s1">&#39;tiles_ncols&#39;</span>   <span class="p">:</span> <span class="n">shm_tiles_ncols</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
</span><span id="Shm_Dtm_Loader-443"><a href="#Shm_Dtm_Loader-443"><span class="linenos">443</span></a>
</span><span id="Shm_Dtm_Loader-444"><a href="#Shm_Dtm_Loader-444"><span class="linenos">444</span></a>        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader-445"><a href="#Shm_Dtm_Loader-445"><span class="linenos">445</span></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Zip file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader-446"><a href="#Shm_Dtm_Loader-446"><span class="linenos">446</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader-447"><a href="#Shm_Dtm_Loader-447"><span class="linenos">447</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading DTM file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader-448"><a href="#Shm_Dtm_Loader-448"><span class="linenos">448</span></a>
</span><span id="Shm_Dtm_Loader-449"><a href="#Shm_Dtm_Loader-449"><span class="linenos">449</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Shm_Dtm_Loader-450"><a href="#Shm_Dtm_Loader-450"><span class="linenos">450</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_Loader-451"><a href="#Shm_Dtm_Loader-451"><span class="linenos">451</span></a><span class="sd">        Clean up shared memory blocks.</span>
</span><span id="Shm_Dtm_Loader-452"><a href="#Shm_Dtm_Loader-452"><span class="linenos">452</span></a>
</span><span id="Shm_Dtm_Loader-453"><a href="#Shm_Dtm_Loader-453"><span class="linenos">453</span></a><span class="sd">        This method safely closes and unlinks all SharedMemoryArray instances that were created.</span>
</span><span id="Shm_Dtm_Loader-454"><a href="#Shm_Dtm_Loader-454"><span class="linenos">454</span></a><span class="sd">        It handles potential errors during cleanup to ensure the process doesn&#39;t fail.</span>
</span><span id="Shm_Dtm_Loader-455"><a href="#Shm_Dtm_Loader-455"><span class="linenos">455</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_Loader-456"><a href="#Shm_Dtm_Loader-456"><span class="linenos">456</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader-457"><a href="#Shm_Dtm_Loader-457"><span class="linenos">457</span></a>            <span class="k">return</span>
</span><span id="Shm_Dtm_Loader-458"><a href="#Shm_Dtm_Loader-458"><span class="linenos">458</span></a>
</span><span id="Shm_Dtm_Loader-459"><a href="#Shm_Dtm_Loader-459"><span class="linenos">459</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Shm_Dtm_Loader-460"><a href="#Shm_Dtm_Loader-460"><span class="linenos">460</span></a>            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;shm_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">):</span>
</span><span id="Shm_Dtm_Loader-461"><a href="#Shm_Dtm_Loader-461"><span class="linenos">461</span></a>                <span class="n">obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Shm_Dtm_Loader-462"><a href="#Shm_Dtm_Loader-462"><span class="linenos">462</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> closed&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader-463"><a href="#Shm_Dtm_Loader-463"><span class="linenos">463</span></a>
</span><span id="Shm_Dtm_Loader-464"><a href="#Shm_Dtm_Loader-464"><span class="linenos">464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Shm_Dtm_Loader-465"><a href="#Shm_Dtm_Loader-465"><span class="linenos">465</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Class for loading Digital Terrain Model (DTM) data into shared memory.</p>

<p>This class handles the loading of elevation data from ZIP archives into shared memory blocks
using SharedMemoryArray, making the data accessible to other processes. It manages the lifecycle
of shared memory, including creation, population, and cleanup.</p>

<p>Attributes:
    filename (str): Path to the ZIP file containing elevation data
    tiles_data (dict): Dictionary containing SharedMemoryArray instances
    shm_names (dict): Dictionary containing shared memory block names</p>
</div>


                            <div id="Shm_Dtm_Loader.__init__" class="classattr">
                                        <input id="Shm_Dtm_Loader.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Shm_Dtm_Loader</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">filename</span></span>)</span>

                <label class="view-source-button" for="Shm_Dtm_Loader.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Shm_Dtm_Loader.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Shm_Dtm_Loader.__init__-333"><a href="#Shm_Dtm_Loader.__init__-333"><span class="linenos">333</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader.__init__-334"><a href="#Shm_Dtm_Loader.__init__-334"><span class="linenos">334</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_Loader.__init__-335"><a href="#Shm_Dtm_Loader.__init__-335"><span class="linenos">335</span></a><span class="sd">        Initialize the Shm_Dtm_Loader with a filename.</span>
</span><span id="Shm_Dtm_Loader.__init__-336"><a href="#Shm_Dtm_Loader.__init__-336"><span class="linenos">336</span></a>
</span><span id="Shm_Dtm_Loader.__init__-337"><a href="#Shm_Dtm_Loader.__init__-337"><span class="linenos">337</span></a><span class="sd">        Args:</span>
</span><span id="Shm_Dtm_Loader.__init__-338"><a href="#Shm_Dtm_Loader.__init__-338"><span class="linenos">338</span></a><span class="sd">            filename (str): Path to the ZIP file containing elevation data</span>
</span><span id="Shm_Dtm_Loader.__init__-339"><a href="#Shm_Dtm_Loader.__init__-339"><span class="linenos">339</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_Loader.__init__-340"><a href="#Shm_Dtm_Loader.__init__-340"><span class="linenos">340</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
</span><span id="Shm_Dtm_Loader.__init__-341"><a href="#Shm_Dtm_Loader.__init__-341"><span class="linenos">341</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Shm_Dtm_Loader.__init__-342"><a href="#Shm_Dtm_Loader.__init__-342"><span class="linenos">342</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Shm_Dtm_Loader.__init__-343"><a href="#Shm_Dtm_Loader.__init__-343"><span class="linenos">343</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_dtm_file</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the Shm_Dtm_Loader with a filename.</p>

<p>Args:
    filename (str): Path to the ZIP file containing elevation data</p>
</div>


                            </div>
                            <div id="Shm_Dtm_Loader.filename" class="classattr">
                                <div class="attr variable">
            <span class="name">filename</span>

        
    </div>
    <a class="headerlink" href="#Shm_Dtm_Loader.filename"></a>
    
    

                            </div>
                            <div id="Shm_Dtm_Loader.tiles_data" class="classattr">
                                <div class="attr variable">
            <span class="name">tiles_data</span>

        
    </div>
    <a class="headerlink" href="#Shm_Dtm_Loader.tiles_data"></a>
    
    

                            </div>
                            <div id="Shm_Dtm_Loader.shm_names" class="classattr">
                                <div class="attr variable">
            <span class="name">shm_names</span>

        
    </div>
    <a class="headerlink" href="#Shm_Dtm_Loader.shm_names"></a>
    
    

                            </div>
                            <div id="Shm_Dtm_Loader.load_dtm_file" class="classattr">
                                        <input id="Shm_Dtm_Loader.load_dtm_file-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_dtm_file</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">filename</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Shm_Dtm_Loader.load_dtm_file-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Shm_Dtm_Loader.load_dtm_file"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Shm_Dtm_Loader.load_dtm_file-345"><a href="#Shm_Dtm_Loader.load_dtm_file-345"><span class="linenos">345</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_dtm_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-346"><a href="#Shm_Dtm_Loader.load_dtm_file-346"><span class="linenos">346</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-347"><a href="#Shm_Dtm_Loader.load_dtm_file-347"><span class="linenos">347</span></a><span class="sd">        Load tiles and metadata from a zip archive containing MessagePack-encoded data.</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-348"><a href="#Shm_Dtm_Loader.load_dtm_file-348"><span class="linenos">348</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-349"><a href="#Shm_Dtm_Loader.load_dtm_file-349"><span class="linenos">349</span></a><span class="sd">        This method:</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-350"><a href="#Shm_Dtm_Loader.load_dtm_file-350"><span class="linenos">350</span></a><span class="sd">        1. Validates the input filename</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-351"><a href="#Shm_Dtm_Loader.load_dtm_file-351"><span class="linenos">351</span></a><span class="sd">        2. Reads and decodes metadata from the ZIP archive</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-352"><a href="#Shm_Dtm_Loader.load_dtm_file-352"><span class="linenos">352</span></a><span class="sd">        3. Creates SharedMemoryArray instances for different data components</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-353"><a href="#Shm_Dtm_Loader.load_dtm_file-353"><span class="linenos">353</span></a><span class="sd">        4. Populates the shared memory with data from the ZIP archive</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-354"><a href="#Shm_Dtm_Loader.load_dtm_file-354"><span class="linenos">354</span></a><span class="sd">        5. Stores names of the created shared memory blocks</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-355"><a href="#Shm_Dtm_Loader.load_dtm_file-355"><span class="linenos">355</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-356"><a href="#Shm_Dtm_Loader.load_dtm_file-356"><span class="linenos">356</span></a><span class="sd">        Args:</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-357"><a href="#Shm_Dtm_Loader.load_dtm_file-357"><span class="linenos">357</span></a><span class="sd">            filename (str, optional): Path to the ZIP file. If provided, updates the instance filename.</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-358"><a href="#Shm_Dtm_Loader.load_dtm_file-358"><span class="linenos">358</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-359"><a href="#Shm_Dtm_Loader.load_dtm_file-359"><span class="linenos">359</span></a><span class="sd">        Raises:</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-360"><a href="#Shm_Dtm_Loader.load_dtm_file-360"><span class="linenos">360</span></a><span class="sd">            ValueError: If filename is not provided</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-361"><a href="#Shm_Dtm_Loader.load_dtm_file-361"><span class="linenos">361</span></a><span class="sd">            FileNotFoundError: If the ZIP file is not found</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-362"><a href="#Shm_Dtm_Loader.load_dtm_file-362"><span class="linenos">362</span></a><span class="sd">            Exception: For other errors during loading</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-363"><a href="#Shm_Dtm_Loader.load_dtm_file-363"><span class="linenos">363</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-364"><a href="#Shm_Dtm_Loader.load_dtm_file-364"><span class="linenos">364</span></a>        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-365"><a href="#Shm_Dtm_Loader.load_dtm_file-365"><span class="linenos">365</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-366"><a href="#Shm_Dtm_Loader.load_dtm_file-366"><span class="linenos">366</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-367"><a href="#Shm_Dtm_Loader.load_dtm_file-367"><span class="linenos">367</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-368"><a href="#Shm_Dtm_Loader.load_dtm_file-368"><span class="linenos">368</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-369"><a href="#Shm_Dtm_Loader.load_dtm_file-369"><span class="linenos">369</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Filename not provided.&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-370"><a href="#Shm_Dtm_Loader.load_dtm_file-370"><span class="linenos">370</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-371"><a href="#Shm_Dtm_Loader.load_dtm_file-371"><span class="linenos">371</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-372"><a href="#Shm_Dtm_Loader.load_dtm_file-372"><span class="linenos">372</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-373"><a href="#Shm_Dtm_Loader.load_dtm_file-373"><span class="linenos">373</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-374"><a href="#Shm_Dtm_Loader.load_dtm_file-374"><span class="linenos">374</span></a>            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-375"><a href="#Shm_Dtm_Loader.load_dtm_file-375"><span class="linenos">375</span></a>                <span class="c1"># Load and decode metadata</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-376"><a href="#Shm_Dtm_Loader.load_dtm_file-376"><span class="linenos">376</span></a>                <span class="n">metadata</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;metadata.packed&#39;</span><span class="p">))</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-377"><a href="#Shm_Dtm_Loader.load_dtm_file-377"><span class="linenos">377</span></a>                <span class="n">tiles_lon_indices_in_bands</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_lon_indices_in_bands&#39;</span><span class="p">]</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-378"><a href="#Shm_Dtm_Loader.load_dtm_file-378"><span class="linenos">378</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-379"><a href="#Shm_Dtm_Loader.load_dtm_file-379"><span class="linenos">379</span></a>                <span class="c1"># Create SharedMemoryArray instances for different data components</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-380"><a href="#Shm_Dtm_Loader.load_dtm_file-380"><span class="linenos">380</span></a>                <span class="n">shm_tiles_indices</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">tiles_lon_indices_in_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-381"><a href="#Shm_Dtm_Loader.load_dtm_file-381"><span class="linenos">381</span></a>                                                      <span class="n">dtype</span><span class="o">=</span><span class="n">tiles_lon_indices_in_bands</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-382"><a href="#Shm_Dtm_Loader.load_dtm_file-382"><span class="linenos">382</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-383"><a href="#Shm_Dtm_Loader.load_dtm_file-383"><span class="linenos">383</span></a>                <span class="n">shm_tiles_nrows</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-384"><a href="#Shm_Dtm_Loader.load_dtm_file-384"><span class="linenos">384</span></a>                                                    <span class="n">dtype</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-385"><a href="#Shm_Dtm_Loader.load_dtm_file-385"><span class="linenos">385</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">])</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-386"><a href="#Shm_Dtm_Loader.load_dtm_file-386"><span class="linenos">386</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-387"><a href="#Shm_Dtm_Loader.load_dtm_file-387"><span class="linenos">387</span></a>                <span class="n">shm_tiles_ncols</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-388"><a href="#Shm_Dtm_Loader.load_dtm_file-388"><span class="linenos">388</span></a>                                                    <span class="n">dtype</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-389"><a href="#Shm_Dtm_Loader.load_dtm_file-389"><span class="linenos">389</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">shm_tiles_ncols</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">])</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-390"><a href="#Shm_Dtm_Loader.load_dtm_file-390"><span class="linenos">390</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-391"><a href="#Shm_Dtm_Loader.load_dtm_file-391"><span class="linenos">391</span></a>                <span class="c1"># Calculate cumulative indices for tiles</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-392"><a href="#Shm_Dtm_Loader.load_dtm_file-392"><span class="linenos">392</span></a>                <span class="n">idx_cumul</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-393"><a href="#Shm_Dtm_Loader.load_dtm_file-393"><span class="linenos">393</span></a>                <span class="k">for</span> <span class="n">lat_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">array</span><span class="p">)):</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-394"><a href="#Shm_Dtm_Loader.load_dtm_file-394"><span class="linenos">394</span></a>                    <span class="n">band_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">shm_tiles_ncols</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-395"><a href="#Shm_Dtm_Loader.load_dtm_file-395"><span class="linenos">395</span></a>                    <span class="n">shm_tiles_indices</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tiles_lon_indices_in_bands</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">idx_cumul</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-396"><a href="#Shm_Dtm_Loader.load_dtm_file-396"><span class="linenos">396</span></a>                    <span class="n">idx_cumul</span> <span class="o">+=</span> <span class="n">band_size</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-397"><a href="#Shm_Dtm_Loader.load_dtm_file-397"><span class="linenos">397</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-398"><a href="#Shm_Dtm_Loader.load_dtm_file-398"><span class="linenos">398</span></a>                <span class="n">expected_total_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx_cumul</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-399"><a href="#Shm_Dtm_Loader.load_dtm_file-399"><span class="linenos">399</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-400"><a href="#Shm_Dtm_Loader.load_dtm_file-400"><span class="linenos">400</span></a>                <span class="c1"># Process latitude bands</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-401"><a href="#Shm_Dtm_Loader.load_dtm_file-401"><span class="linenos">401</span></a>                <span class="n">lat_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-402"><a href="#Shm_Dtm_Loader.load_dtm_file-402"><span class="linenos">402</span></a>                    <span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;lat_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.packed&#39;</span><span class="p">)),</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-403"><a href="#Shm_Dtm_Loader.load_dtm_file-403"><span class="linenos">403</span></a>                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-404"><a href="#Shm_Dtm_Loader.load_dtm_file-404"><span class="linenos">404</span></a>                <span class="p">)</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-405"><a href="#Shm_Dtm_Loader.load_dtm_file-405"><span class="linenos">405</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-406"><a href="#Shm_Dtm_Loader.load_dtm_file-406"><span class="linenos">406</span></a>                <span class="n">band_array</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">lat_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-407"><a href="#Shm_Dtm_Loader.load_dtm_file-407"><span class="linenos">407</span></a>                <span class="n">band_dtype</span> <span class="o">=</span> <span class="n">band_array</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-408"><a href="#Shm_Dtm_Loader.load_dtm_file-408"><span class="linenos">408</span></a>                <span class="n">band_word_nbytes</span> <span class="o">=</span> <span class="n">band_array</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">//</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-409"><a href="#Shm_Dtm_Loader.load_dtm_file-409"><span class="linenos">409</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-410"><a href="#Shm_Dtm_Loader.load_dtm_file-410"><span class="linenos">410</span></a>                <span class="c1"># Create SharedMemoryArray for the main tile data</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-411"><a href="#Shm_Dtm_Loader.load_dtm_file-411"><span class="linenos">411</span></a>                <span class="n">shm_tiles_1d_array</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">expected_total_size</span><span class="p">,),</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-412"><a href="#Shm_Dtm_Loader.load_dtm_file-412"><span class="linenos">412</span></a>                                                       <span class="n">dtype</span><span class="o">=</span><span class="n">band_dtype</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-413"><a href="#Shm_Dtm_Loader.load_dtm_file-413"><span class="linenos">413</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-414"><a href="#Shm_Dtm_Loader.load_dtm_file-414"><span class="linenos">414</span></a>                <span class="c1"># Load data from each latitude band</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-415"><a href="#Shm_Dtm_Loader.load_dtm_file-415"><span class="linenos">415</span></a>                <span class="n">idx_cumul</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-416"><a href="#Shm_Dtm_Loader.load_dtm_file-416"><span class="linenos">416</span></a>                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">lat_keys</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lat_keys</span><span class="p">),</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-417"><a href="#Shm_Dtm_Loader.load_dtm_file-417"><span class="linenos">417</span></a>                               <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Loading tiles from file &lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">):</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-418"><a href="#Shm_Dtm_Loader.load_dtm_file-418"><span class="linenos">418</span></a>                    <span class="n">lat_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-419"><a href="#Shm_Dtm_Loader.load_dtm_file-419"><span class="linenos">419</span></a>                    <span class="n">band_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">shm_tiles_ncols</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">lat_idx</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-420"><a href="#Shm_Dtm_Loader.load_dtm_file-420"><span class="linenos">420</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-421"><a href="#Shm_Dtm_Loader.load_dtm_file-421"><span class="linenos">421</span></a>                    <span class="n">band_array</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-422"><a href="#Shm_Dtm_Loader.load_dtm_file-422"><span class="linenos">422</span></a>                    <span class="k">if</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">band_size</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-423"><a href="#Shm_Dtm_Loader.load_dtm_file-423"><span class="linenos">423</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Size mismatch for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">band_array</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">band_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-424"><a href="#Shm_Dtm_Loader.load_dtm_file-424"><span class="linenos">424</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-425"><a href="#Shm_Dtm_Loader.load_dtm_file-425"><span class="linenos">425</span></a>                    <span class="k">if</span> <span class="n">idx_cumul</span> <span class="o">+</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">shm_tiles_1d_array</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-426"><a href="#Shm_Dtm_Loader.load_dtm_file-426"><span class="linenos">426</span></a>                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Exceeded tiles_1d_array size while loading band arrays&#39;</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-427"><a href="#Shm_Dtm_Loader.load_dtm_file-427"><span class="linenos">427</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-428"><a href="#Shm_Dtm_Loader.load_dtm_file-428"><span class="linenos">428</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">shm_tiles_1d_array</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">idx_cumul</span><span class="p">:</span><span class="n">idx_cumul</span> <span class="o">+</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span><span class="p">],</span> <span class="n">band_array</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-429"><a href="#Shm_Dtm_Loader.load_dtm_file-429"><span class="linenos">429</span></a>                    <span class="n">idx_cumul</span> <span class="o">+=</span> <span class="n">band_array</span><span class="o">.</span><span class="n">size</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-430"><a href="#Shm_Dtm_Loader.load_dtm_file-430"><span class="linenos">430</span></a>                    <span class="k">del</span> <span class="n">band_array</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-431"><a href="#Shm_Dtm_Loader.load_dtm_file-431"><span class="linenos">431</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-432"><a href="#Shm_Dtm_Loader.load_dtm_file-432"><span class="linenos">432</span></a>            <span class="c1"># Store SharedMemoryArray instances</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-433"><a href="#Shm_Dtm_Loader.load_dtm_file-433"><span class="linenos">433</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;shm_tiles_1d_array&#39;</span><span class="p">:</span> <span class="n">shm_tiles_1d_array</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-434"><a href="#Shm_Dtm_Loader.load_dtm_file-434"><span class="linenos">434</span></a>                               <span class="s1">&#39;shm_tiles_indices&#39;</span> <span class="p">:</span> <span class="n">shm_tiles_indices</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-435"><a href="#Shm_Dtm_Loader.load_dtm_file-435"><span class="linenos">435</span></a>                               <span class="s1">&#39;shm_tiles_nrows&#39;</span>   <span class="p">:</span> <span class="n">shm_tiles_nrows</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-436"><a href="#Shm_Dtm_Loader.load_dtm_file-436"><span class="linenos">436</span></a>                               <span class="s1">&#39;shm_tiles_ncols&#39;</span>   <span class="p">:</span> <span class="n">shm_tiles_ncols</span><span class="p">}</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-437"><a href="#Shm_Dtm_Loader.load_dtm_file-437"><span class="linenos">437</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-438"><a href="#Shm_Dtm_Loader.load_dtm_file-438"><span class="linenos">438</span></a>            <span class="c1"># Store names of shared memory blocks</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-439"><a href="#Shm_Dtm_Loader.load_dtm_file-439"><span class="linenos">439</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">:</span> <span class="n">shm_tiles_1d_array</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-440"><a href="#Shm_Dtm_Loader.load_dtm_file-440"><span class="linenos">440</span></a>                              <span class="s1">&#39;tiles_indices&#39;</span> <span class="p">:</span> <span class="n">shm_tiles_indices</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-441"><a href="#Shm_Dtm_Loader.load_dtm_file-441"><span class="linenos">441</span></a>                              <span class="s1">&#39;tiles_nrows&#39;</span>   <span class="p">:</span> <span class="n">shm_tiles_nrows</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-442"><a href="#Shm_Dtm_Loader.load_dtm_file-442"><span class="linenos">442</span></a>                              <span class="s1">&#39;tiles_ncols&#39;</span>   <span class="p">:</span> <span class="n">shm_tiles_ncols</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-443"><a href="#Shm_Dtm_Loader.load_dtm_file-443"><span class="linenos">443</span></a>
</span><span id="Shm_Dtm_Loader.load_dtm_file-444"><a href="#Shm_Dtm_Loader.load_dtm_file-444"><span class="linenos">444</span></a>        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-445"><a href="#Shm_Dtm_Loader.load_dtm_file-445"><span class="linenos">445</span></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Zip file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-446"><a href="#Shm_Dtm_Loader.load_dtm_file-446"><span class="linenos">446</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader.load_dtm_file-447"><a href="#Shm_Dtm_Loader.load_dtm_file-447"><span class="linenos">447</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading DTM file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Load tiles and metadata from a zip archive containing MessagePack-encoded data.</p>

<p>This method:</p>

<ol>
<li>Validates the input filename</li>
<li>Reads and decodes metadata from the ZIP archive</li>
<li>Creates SharedMemoryArray instances for different data components</li>
<li>Populates the shared memory with data from the ZIP archive</li>
<li>Stores names of the created shared memory blocks</li>
</ol>

<p>Args:
    filename (str, optional): Path to the ZIP file. If provided, updates the instance filename.</p>

<p>Raises:
    ValueError: If filename is not provided
    FileNotFoundError: If the ZIP file is not found
    Exception: For other errors during loading</p>
</div>


                            </div>
                            <div id="Shm_Dtm_Loader.close" class="classattr">
                                        <input id="Shm_Dtm_Loader.close-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">close</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Shm_Dtm_Loader.close-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Shm_Dtm_Loader.close"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Shm_Dtm_Loader.close-449"><a href="#Shm_Dtm_Loader.close-449"><span class="linenos">449</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Shm_Dtm_Loader.close-450"><a href="#Shm_Dtm_Loader.close-450"><span class="linenos">450</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_Loader.close-451"><a href="#Shm_Dtm_Loader.close-451"><span class="linenos">451</span></a><span class="sd">        Clean up shared memory blocks.</span>
</span><span id="Shm_Dtm_Loader.close-452"><a href="#Shm_Dtm_Loader.close-452"><span class="linenos">452</span></a>
</span><span id="Shm_Dtm_Loader.close-453"><a href="#Shm_Dtm_Loader.close-453"><span class="linenos">453</span></a><span class="sd">        This method safely closes and unlinks all SharedMemoryArray instances that were created.</span>
</span><span id="Shm_Dtm_Loader.close-454"><a href="#Shm_Dtm_Loader.close-454"><span class="linenos">454</span></a><span class="sd">        It handles potential errors during cleanup to ensure the process doesn&#39;t fail.</span>
</span><span id="Shm_Dtm_Loader.close-455"><a href="#Shm_Dtm_Loader.close-455"><span class="linenos">455</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_Loader.close-456"><a href="#Shm_Dtm_Loader.close-456"><span class="linenos">456</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Shm_Dtm_Loader.close-457"><a href="#Shm_Dtm_Loader.close-457"><span class="linenos">457</span></a>            <span class="k">return</span>
</span><span id="Shm_Dtm_Loader.close-458"><a href="#Shm_Dtm_Loader.close-458"><span class="linenos">458</span></a>
</span><span id="Shm_Dtm_Loader.close-459"><a href="#Shm_Dtm_Loader.close-459"><span class="linenos">459</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Shm_Dtm_Loader.close-460"><a href="#Shm_Dtm_Loader.close-460"><span class="linenos">460</span></a>            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;shm_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">):</span>
</span><span id="Shm_Dtm_Loader.close-461"><a href="#Shm_Dtm_Loader.close-461"><span class="linenos">461</span></a>                <span class="n">obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Shm_Dtm_Loader.close-462"><a href="#Shm_Dtm_Loader.close-462"><span class="linenos">462</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> closed&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_Loader.close-463"><a href="#Shm_Dtm_Loader.close-463"><span class="linenos">463</span></a>
</span><span id="Shm_Dtm_Loader.close-464"><a href="#Shm_Dtm_Loader.close-464"><span class="linenos">464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tiles_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Shm_Dtm_Loader.close-465"><a href="#Shm_Dtm_Loader.close-465"><span class="linenos">465</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Clean up shared memory blocks.</p>

<p>This method safely closes and unlinks all SharedMemoryArray instances that were created.
It handles potential errors during cleanup to ensure the process doesn't fail.</p>
</div>


                            </div>
                </section>
                <section id="Shm_Dtm_User">
                            <input id="Shm_Dtm_User-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Shm_Dtm_User</span>:

                <label class="view-source-button" for="Shm_Dtm_User-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Shm_Dtm_User"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Shm_Dtm_User-467"><a href="#Shm_Dtm_User-467"><span class="linenos">467</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Shm_Dtm_User</span><span class="p">:</span>
</span><span id="Shm_Dtm_User-468"><a href="#Shm_Dtm_User-468"><span class="linenos">468</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User-469"><a href="#Shm_Dtm_User-469"><span class="linenos">469</span></a><span class="sd">    Class for retrieving altitudes using shared memory blocks.</span>
</span><span id="Shm_Dtm_User-470"><a href="#Shm_Dtm_User-470"><span class="linenos">470</span></a>
</span><span id="Shm_Dtm_User-471"><a href="#Shm_Dtm_User-471"><span class="linenos">471</span></a><span class="sd">    This class connects to existing shared memory blocks created by Shm_Dtm_Loader</span>
</span><span id="Shm_Dtm_User-472"><a href="#Shm_Dtm_User-472"><span class="linenos">472</span></a><span class="sd">    using SharedMemoryArray and provides methods to retrieve altitude data for single</span>
</span><span id="Shm_Dtm_User-473"><a href="#Shm_Dtm_User-473"><span class="linenos">473</span></a><span class="sd">    coordinates or arrays of coordinates.</span>
</span><span id="Shm_Dtm_User-474"><a href="#Shm_Dtm_User-474"><span class="linenos">474</span></a>
</span><span id="Shm_Dtm_User-475"><a href="#Shm_Dtm_User-475"><span class="linenos">475</span></a><span class="sd">    Attributes:</span>
</span><span id="Shm_Dtm_User-476"><a href="#Shm_Dtm_User-476"><span class="linenos">476</span></a><span class="sd">        shm_names (dict): Dictionary containing shared memory block names</span>
</span><span id="Shm_Dtm_User-477"><a href="#Shm_Dtm_User-477"><span class="linenos">477</span></a><span class="sd">        shm_instances (dict): Dictionary containing SharedMemoryArray instances</span>
</span><span id="Shm_Dtm_User-478"><a href="#Shm_Dtm_User-478"><span class="linenos">478</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User-479"><a href="#Shm_Dtm_User-479"><span class="linenos">479</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shm_names</span><span class="p">):</span>
</span><span id="Shm_Dtm_User-480"><a href="#Shm_Dtm_User-480"><span class="linenos">480</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User-481"><a href="#Shm_Dtm_User-481"><span class="linenos">481</span></a><span class="sd">        Initialize the Shm_Dtm_User with shared memory block names.</span>
</span><span id="Shm_Dtm_User-482"><a href="#Shm_Dtm_User-482"><span class="linenos">482</span></a>
</span><span id="Shm_Dtm_User-483"><a href="#Shm_Dtm_User-483"><span class="linenos">483</span></a><span class="sd">        Args:</span>
</span><span id="Shm_Dtm_User-484"><a href="#Shm_Dtm_User-484"><span class="linenos">484</span></a><span class="sd">            shm_names (dict): Dictionary containing shared memory block names</span>
</span><span id="Shm_Dtm_User-485"><a href="#Shm_Dtm_User-485"><span class="linenos">485</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User-486"><a href="#Shm_Dtm_User-486"><span class="linenos">486</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span> <span class="o">=</span> <span class="n">shm_names</span>
</span><span id="Shm_Dtm_User-487"><a href="#Shm_Dtm_User-487"><span class="linenos">487</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Shm_Dtm_User-488"><a href="#Shm_Dtm_User-488"><span class="linenos">488</span></a>
</span><span id="Shm_Dtm_User-489"><a href="#Shm_Dtm_User-489"><span class="linenos">489</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_indices&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_nrows&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_ncols&#39;</span><span class="p">):</span>
</span><span id="Shm_Dtm_User-490"><a href="#Shm_Dtm_User-490"><span class="linenos">490</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Shm_Dtm_User-491"><a href="#Shm_Dtm_User-491"><span class="linenos">491</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading shared memory </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User-492"><a href="#Shm_Dtm_User-492"><span class="linenos">492</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span id="Shm_Dtm_User-493"><a href="#Shm_Dtm_User-493"><span class="linenos">493</span></a>            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="Shm_Dtm_User-494"><a href="#Shm_Dtm_User-494"><span class="linenos">494</span></a>                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User-495"><a href="#Shm_Dtm_User-495"><span class="linenos">495</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Shm_Dtm_User-496"><a href="#Shm_Dtm_User-496"><span class="linenos">496</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Shm_Dtm_User-497"><a href="#Shm_Dtm_User-497"><span class="linenos">497</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error accessing shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User-498"><a href="#Shm_Dtm_User-498"><span class="linenos">498</span></a>
</span><span id="Shm_Dtm_User-499"><a href="#Shm_Dtm_User-499"><span class="linenos">499</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_altitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">):</span>
</span><span id="Shm_Dtm_User-500"><a href="#Shm_Dtm_User-500"><span class="linenos">500</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User-501"><a href="#Shm_Dtm_User-501"><span class="linenos">501</span></a><span class="sd">        Get altitude for a single coordinate.</span>
</span><span id="Shm_Dtm_User-502"><a href="#Shm_Dtm_User-502"><span class="linenos">502</span></a>
</span><span id="Shm_Dtm_User-503"><a href="#Shm_Dtm_User-503"><span class="linenos">503</span></a><span class="sd">        Args:</span>
</span><span id="Shm_Dtm_User-504"><a href="#Shm_Dtm_User-504"><span class="linenos">504</span></a><span class="sd">            lon (float): Longitude in decimal degrees (-180 to 180)</span>
</span><span id="Shm_Dtm_User-505"><a href="#Shm_Dtm_User-505"><span class="linenos">505</span></a><span class="sd">            lat (float): Latitude in decimal degrees (-90 to 90)</span>
</span><span id="Shm_Dtm_User-506"><a href="#Shm_Dtm_User-506"><span class="linenos">506</span></a>
</span><span id="Shm_Dtm_User-507"><a href="#Shm_Dtm_User-507"><span class="linenos">507</span></a><span class="sd">        Returns:</span>
</span><span id="Shm_Dtm_User-508"><a href="#Shm_Dtm_User-508"><span class="linenos">508</span></a><span class="sd">            uint16: Altitude value at the specified coordinates</span>
</span><span id="Shm_Dtm_User-509"><a href="#Shm_Dtm_User-509"><span class="linenos">509</span></a>
</span><span id="Shm_Dtm_User-510"><a href="#Shm_Dtm_User-510"><span class="linenos">510</span></a><span class="sd">        Raises:</span>
</span><span id="Shm_Dtm_User-511"><a href="#Shm_Dtm_User-511"><span class="linenos">511</span></a><span class="sd">            ValueError: If coordinates are out of valid ranges</span>
</span><span id="Shm_Dtm_User-512"><a href="#Shm_Dtm_User-512"><span class="linenos">512</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User-513"><a href="#Shm_Dtm_User-513"><span class="linenos">513</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">180</span> <span class="o">&lt;=</span> <span class="n">lon</span> <span class="o">&lt;=</span> <span class="mi">180</span><span class="p">):</span>
</span><span id="Shm_Dtm_User-514"><a href="#Shm_Dtm_User-514"><span class="linenos">514</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Longitude must be between -180 and 180 degrees.&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User-515"><a href="#Shm_Dtm_User-515"><span class="linenos">515</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">lat</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">):</span>
</span><span id="Shm_Dtm_User-516"><a href="#Shm_Dtm_User-516"><span class="linenos">516</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Latitude must be between -90 and 90 degrees.&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User-517"><a href="#Shm_Dtm_User-517"><span class="linenos">517</span></a>
</span><span id="Shm_Dtm_User-518"><a href="#Shm_Dtm_User-518"><span class="linenos">518</span></a>        <span class="k">return</span> <span class="n">_get_altitude_nb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User-519"><a href="#Shm_Dtm_User-519"><span class="linenos">519</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User-520"><a href="#Shm_Dtm_User-520"><span class="linenos">520</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User-521"><a href="#Shm_Dtm_User-521"><span class="linenos">521</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User-522"><a href="#Shm_Dtm_User-522"><span class="linenos">522</span></a>                                <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
</span><span id="Shm_Dtm_User-523"><a href="#Shm_Dtm_User-523"><span class="linenos">523</span></a>
</span><span id="Shm_Dtm_User-524"><a href="#Shm_Dtm_User-524"><span class="linenos">524</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_altitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">):</span>
</span><span id="Shm_Dtm_User-525"><a href="#Shm_Dtm_User-525"><span class="linenos">525</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User-526"><a href="#Shm_Dtm_User-526"><span class="linenos">526</span></a><span class="sd">        Get altitudes for multiple coordinates.</span>
</span><span id="Shm_Dtm_User-527"><a href="#Shm_Dtm_User-527"><span class="linenos">527</span></a>
</span><span id="Shm_Dtm_User-528"><a href="#Shm_Dtm_User-528"><span class="linenos">528</span></a><span class="sd">        Args:</span>
</span><span id="Shm_Dtm_User-529"><a href="#Shm_Dtm_User-529"><span class="linenos">529</span></a><span class="sd">            lons (numpy.ndarray): Array of longitude coordinates</span>
</span><span id="Shm_Dtm_User-530"><a href="#Shm_Dtm_User-530"><span class="linenos">530</span></a><span class="sd">            lats (numpy.ndarray): Array of latitude coordinates</span>
</span><span id="Shm_Dtm_User-531"><a href="#Shm_Dtm_User-531"><span class="linenos">531</span></a>
</span><span id="Shm_Dtm_User-532"><a href="#Shm_Dtm_User-532"><span class="linenos">532</span></a><span class="sd">        Returns:</span>
</span><span id="Shm_Dtm_User-533"><a href="#Shm_Dtm_User-533"><span class="linenos">533</span></a><span class="sd">            numpy.ndarray: Array of altitude values with same shape as input coordinates</span>
</span><span id="Shm_Dtm_User-534"><a href="#Shm_Dtm_User-534"><span class="linenos">534</span></a>
</span><span id="Shm_Dtm_User-535"><a href="#Shm_Dtm_User-535"><span class="linenos">535</span></a><span class="sd">        Raises:</span>
</span><span id="Shm_Dtm_User-536"><a href="#Shm_Dtm_User-536"><span class="linenos">536</span></a><span class="sd">            ValueError: If input arrays have different shapes</span>
</span><span id="Shm_Dtm_User-537"><a href="#Shm_Dtm_User-537"><span class="linenos">537</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User-538"><a href="#Shm_Dtm_User-538"><span class="linenos">538</span></a>        <span class="k">if</span> <span class="n">lons</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">lats</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="Shm_Dtm_User-539"><a href="#Shm_Dtm_User-539"><span class="linenos">539</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;lons and lats must have the same shape.&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User-540"><a href="#Shm_Dtm_User-540"><span class="linenos">540</span></a>
</span><span id="Shm_Dtm_User-541"><a href="#Shm_Dtm_User-541"><span class="linenos">541</span></a>        <span class="k">return</span> <span class="n">get_altitudes_vect_nb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User-542"><a href="#Shm_Dtm_User-542"><span class="linenos">542</span></a>                                      <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User-543"><a href="#Shm_Dtm_User-543"><span class="linenos">543</span></a>                                      <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User-544"><a href="#Shm_Dtm_User-544"><span class="linenos">544</span></a>                                      <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User-545"><a href="#Shm_Dtm_User-545"><span class="linenos">545</span></a>                                      <span class="n">lons</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">lats</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">lons</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Shm_Dtm_User-546"><a href="#Shm_Dtm_User-546"><span class="linenos">546</span></a>
</span><span id="Shm_Dtm_User-547"><a href="#Shm_Dtm_User-547"><span class="linenos">547</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Shm_Dtm_User-548"><a href="#Shm_Dtm_User-548"><span class="linenos">548</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User-549"><a href="#Shm_Dtm_User-549"><span class="linenos">549</span></a><span class="sd">        Close shared memory blocks.</span>
</span><span id="Shm_Dtm_User-550"><a href="#Shm_Dtm_User-550"><span class="linenos">550</span></a>
</span><span id="Shm_Dtm_User-551"><a href="#Shm_Dtm_User-551"><span class="linenos">551</span></a><span class="sd">        This method safely closes all SharedMemoryArray instances.</span>
</span><span id="Shm_Dtm_User-552"><a href="#Shm_Dtm_User-552"><span class="linenos">552</span></a><span class="sd">        It handles potential errors during cleanup to ensure the process doesn&#39;t fail.</span>
</span><span id="Shm_Dtm_User-553"><a href="#Shm_Dtm_User-553"><span class="linenos">553</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User-554"><a href="#Shm_Dtm_User-554"><span class="linenos">554</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Shm_Dtm_User-555"><a href="#Shm_Dtm_User-555"><span class="linenos">555</span></a>            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Shm_Dtm_User-556"><a href="#Shm_Dtm_User-556"><span class="linenos">556</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Shm_Dtm_User-557"><a href="#Shm_Dtm_User-557"><span class="linenos">557</span></a>                    <span class="n">obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Shm_Dtm_User-558"><a href="#Shm_Dtm_User-558"><span class="linenos">558</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> closed&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User-559"><a href="#Shm_Dtm_User-559"><span class="linenos">559</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Shm_Dtm_User-560"><a href="#Shm_Dtm_User-560"><span class="linenos">560</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User-561"><a href="#Shm_Dtm_User-561"><span class="linenos">561</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Shm_Dtm_User-562"><a href="#Shm_Dtm_User-562"><span class="linenos">562</span></a>
</span><span id="Shm_Dtm_User-563"><a href="#Shm_Dtm_User-563"><span class="linenos">563</span></a>    <span class="nd">@property</span>
</span><span id="Shm_Dtm_User-564"><a href="#Shm_Dtm_User-564"><span class="linenos">564</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tiles_1d_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Shm_Dtm_User-565"><a href="#Shm_Dtm_User-565"><span class="linenos">565</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">if</span> <span class="s1">&#39;tiles_1d_array&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Shm_Dtm_User-566"><a href="#Shm_Dtm_User-566"><span class="linenos">566</span></a>
</span><span id="Shm_Dtm_User-567"><a href="#Shm_Dtm_User-567"><span class="linenos">567</span></a>    <span class="nd">@property</span>
</span><span id="Shm_Dtm_User-568"><a href="#Shm_Dtm_User-568"><span class="linenos">568</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tiles_indices_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Shm_Dtm_User-569"><a href="#Shm_Dtm_User-569"><span class="linenos">569</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">if</span> <span class="s1">&#39;tiles_indices&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Shm_Dtm_User-570"><a href="#Shm_Dtm_User-570"><span class="linenos">570</span></a>
</span><span id="Shm_Dtm_User-571"><a href="#Shm_Dtm_User-571"><span class="linenos">571</span></a>    <span class="nd">@property</span>
</span><span id="Shm_Dtm_User-572"><a href="#Shm_Dtm_User-572"><span class="linenos">572</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tiles_nrows_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Shm_Dtm_User-573"><a href="#Shm_Dtm_User-573"><span class="linenos">573</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">if</span> <span class="s1">&#39;tiles_nrows&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Shm_Dtm_User-574"><a href="#Shm_Dtm_User-574"><span class="linenos">574</span></a>
</span><span id="Shm_Dtm_User-575"><a href="#Shm_Dtm_User-575"><span class="linenos">575</span></a>    <span class="nd">@property</span>
</span><span id="Shm_Dtm_User-576"><a href="#Shm_Dtm_User-576"><span class="linenos">576</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tiles_ncols_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Shm_Dtm_User-577"><a href="#Shm_Dtm_User-577"><span class="linenos">577</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">if</span> <span class="s1">&#39;tiles_ncols&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="k">else</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Class for retrieving altitudes using shared memory blocks.</p>

<p>This class connects to existing shared memory blocks created by Shm_Dtm_Loader
using SharedMemoryArray and provides methods to retrieve altitude data for single
coordinates or arrays of coordinates.</p>

<p>Attributes:
    shm_names (dict): Dictionary containing shared memory block names
    shm_instances (dict): Dictionary containing SharedMemoryArray instances</p>
</div>


                            <div id="Shm_Dtm_User.__init__" class="classattr">
                                        <input id="Shm_Dtm_User.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Shm_Dtm_User</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">shm_names</span></span>)</span>

                <label class="view-source-button" for="Shm_Dtm_User.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Shm_Dtm_User.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Shm_Dtm_User.__init__-479"><a href="#Shm_Dtm_User.__init__-479"><span class="linenos">479</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shm_names</span><span class="p">):</span>
</span><span id="Shm_Dtm_User.__init__-480"><a href="#Shm_Dtm_User.__init__-480"><span class="linenos">480</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User.__init__-481"><a href="#Shm_Dtm_User.__init__-481"><span class="linenos">481</span></a><span class="sd">        Initialize the Shm_Dtm_User with shared memory block names.</span>
</span><span id="Shm_Dtm_User.__init__-482"><a href="#Shm_Dtm_User.__init__-482"><span class="linenos">482</span></a>
</span><span id="Shm_Dtm_User.__init__-483"><a href="#Shm_Dtm_User.__init__-483"><span class="linenos">483</span></a><span class="sd">        Args:</span>
</span><span id="Shm_Dtm_User.__init__-484"><a href="#Shm_Dtm_User.__init__-484"><span class="linenos">484</span></a><span class="sd">            shm_names (dict): Dictionary containing shared memory block names</span>
</span><span id="Shm_Dtm_User.__init__-485"><a href="#Shm_Dtm_User.__init__-485"><span class="linenos">485</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User.__init__-486"><a href="#Shm_Dtm_User.__init__-486"><span class="linenos">486</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span> <span class="o">=</span> <span class="n">shm_names</span>
</span><span id="Shm_Dtm_User.__init__-487"><a href="#Shm_Dtm_User.__init__-487"><span class="linenos">487</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Shm_Dtm_User.__init__-488"><a href="#Shm_Dtm_User.__init__-488"><span class="linenos">488</span></a>
</span><span id="Shm_Dtm_User.__init__-489"><a href="#Shm_Dtm_User.__init__-489"><span class="linenos">489</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_indices&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_nrows&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_ncols&#39;</span><span class="p">):</span>
</span><span id="Shm_Dtm_User.__init__-490"><a href="#Shm_Dtm_User.__init__-490"><span class="linenos">490</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Shm_Dtm_User.__init__-491"><a href="#Shm_Dtm_User.__init__-491"><span class="linenos">491</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading shared memory </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User.__init__-492"><a href="#Shm_Dtm_User.__init__-492"><span class="linenos">492</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">SharedMemoryArray</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shm_names</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span id="Shm_Dtm_User.__init__-493"><a href="#Shm_Dtm_User.__init__-493"><span class="linenos">493</span></a>            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="Shm_Dtm_User.__init__-494"><a href="#Shm_Dtm_User.__init__-494"><span class="linenos">494</span></a>                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User.__init__-495"><a href="#Shm_Dtm_User.__init__-495"><span class="linenos">495</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Shm_Dtm_User.__init__-496"><a href="#Shm_Dtm_User.__init__-496"><span class="linenos">496</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Shm_Dtm_User.__init__-497"><a href="#Shm_Dtm_User.__init__-497"><span class="linenos">497</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error accessing shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the Shm_Dtm_User with shared memory block names.</p>

<p>Args:
    shm_names (dict): Dictionary containing shared memory block names</p>
</div>


                            </div>
                            <div id="Shm_Dtm_User.shm_names" class="classattr">
                                <div class="attr variable">
            <span class="name">shm_names</span>

        
    </div>
    <a class="headerlink" href="#Shm_Dtm_User.shm_names"></a>
    
    

                            </div>
                            <div id="Shm_Dtm_User.shm_instances" class="classattr">
                                <div class="attr variable">
            <span class="name">shm_instances</span>

        
    </div>
    <a class="headerlink" href="#Shm_Dtm_User.shm_instances"></a>
    
    

                            </div>
                            <div id="Shm_Dtm_User.get_altitude" class="classattr">
                                        <input id="Shm_Dtm_User.get_altitude-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_altitude</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">lon</span>, </span><span class="param"><span class="n">lat</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Shm_Dtm_User.get_altitude-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Shm_Dtm_User.get_altitude"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Shm_Dtm_User.get_altitude-499"><a href="#Shm_Dtm_User.get_altitude-499"><span class="linenos">499</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_altitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">):</span>
</span><span id="Shm_Dtm_User.get_altitude-500"><a href="#Shm_Dtm_User.get_altitude-500"><span class="linenos">500</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User.get_altitude-501"><a href="#Shm_Dtm_User.get_altitude-501"><span class="linenos">501</span></a><span class="sd">        Get altitude for a single coordinate.</span>
</span><span id="Shm_Dtm_User.get_altitude-502"><a href="#Shm_Dtm_User.get_altitude-502"><span class="linenos">502</span></a>
</span><span id="Shm_Dtm_User.get_altitude-503"><a href="#Shm_Dtm_User.get_altitude-503"><span class="linenos">503</span></a><span class="sd">        Args:</span>
</span><span id="Shm_Dtm_User.get_altitude-504"><a href="#Shm_Dtm_User.get_altitude-504"><span class="linenos">504</span></a><span class="sd">            lon (float): Longitude in decimal degrees (-180 to 180)</span>
</span><span id="Shm_Dtm_User.get_altitude-505"><a href="#Shm_Dtm_User.get_altitude-505"><span class="linenos">505</span></a><span class="sd">            lat (float): Latitude in decimal degrees (-90 to 90)</span>
</span><span id="Shm_Dtm_User.get_altitude-506"><a href="#Shm_Dtm_User.get_altitude-506"><span class="linenos">506</span></a>
</span><span id="Shm_Dtm_User.get_altitude-507"><a href="#Shm_Dtm_User.get_altitude-507"><span class="linenos">507</span></a><span class="sd">        Returns:</span>
</span><span id="Shm_Dtm_User.get_altitude-508"><a href="#Shm_Dtm_User.get_altitude-508"><span class="linenos">508</span></a><span class="sd">            uint16: Altitude value at the specified coordinates</span>
</span><span id="Shm_Dtm_User.get_altitude-509"><a href="#Shm_Dtm_User.get_altitude-509"><span class="linenos">509</span></a>
</span><span id="Shm_Dtm_User.get_altitude-510"><a href="#Shm_Dtm_User.get_altitude-510"><span class="linenos">510</span></a><span class="sd">        Raises:</span>
</span><span id="Shm_Dtm_User.get_altitude-511"><a href="#Shm_Dtm_User.get_altitude-511"><span class="linenos">511</span></a><span class="sd">            ValueError: If coordinates are out of valid ranges</span>
</span><span id="Shm_Dtm_User.get_altitude-512"><a href="#Shm_Dtm_User.get_altitude-512"><span class="linenos">512</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User.get_altitude-513"><a href="#Shm_Dtm_User.get_altitude-513"><span class="linenos">513</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">180</span> <span class="o">&lt;=</span> <span class="n">lon</span> <span class="o">&lt;=</span> <span class="mi">180</span><span class="p">):</span>
</span><span id="Shm_Dtm_User.get_altitude-514"><a href="#Shm_Dtm_User.get_altitude-514"><span class="linenos">514</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Longitude must be between -180 and 180 degrees.&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User.get_altitude-515"><a href="#Shm_Dtm_User.get_altitude-515"><span class="linenos">515</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">lat</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">):</span>
</span><span id="Shm_Dtm_User.get_altitude-516"><a href="#Shm_Dtm_User.get_altitude-516"><span class="linenos">516</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Latitude must be between -90 and 90 degrees.&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User.get_altitude-517"><a href="#Shm_Dtm_User.get_altitude-517"><span class="linenos">517</span></a>
</span><span id="Shm_Dtm_User.get_altitude-518"><a href="#Shm_Dtm_User.get_altitude-518"><span class="linenos">518</span></a>        <span class="k">return</span> <span class="n">_get_altitude_nb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User.get_altitude-519"><a href="#Shm_Dtm_User.get_altitude-519"><span class="linenos">519</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User.get_altitude-520"><a href="#Shm_Dtm_User.get_altitude-520"><span class="linenos">520</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User.get_altitude-521"><a href="#Shm_Dtm_User.get_altitude-521"><span class="linenos">521</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User.get_altitude-522"><a href="#Shm_Dtm_User.get_altitude-522"><span class="linenos">522</span></a>                                <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get altitude for a single coordinate.</p>

<p>Args:
    lon (float): Longitude in decimal degrees (-180 to 180)
    lat (float): Latitude in decimal degrees (-90 to 90)</p>

<p>Returns:
    uint16: Altitude value at the specified coordinates</p>

<p>Raises:
    ValueError: If coordinates are out of valid ranges</p>
</div>


                            </div>
                            <div id="Shm_Dtm_User.get_altitudes" class="classattr">
                                        <input id="Shm_Dtm_User.get_altitudes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_altitudes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">lons</span>, </span><span class="param"><span class="n">lats</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Shm_Dtm_User.get_altitudes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Shm_Dtm_User.get_altitudes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Shm_Dtm_User.get_altitudes-524"><a href="#Shm_Dtm_User.get_altitudes-524"><span class="linenos">524</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_altitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">):</span>
</span><span id="Shm_Dtm_User.get_altitudes-525"><a href="#Shm_Dtm_User.get_altitudes-525"><span class="linenos">525</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User.get_altitudes-526"><a href="#Shm_Dtm_User.get_altitudes-526"><span class="linenos">526</span></a><span class="sd">        Get altitudes for multiple coordinates.</span>
</span><span id="Shm_Dtm_User.get_altitudes-527"><a href="#Shm_Dtm_User.get_altitudes-527"><span class="linenos">527</span></a>
</span><span id="Shm_Dtm_User.get_altitudes-528"><a href="#Shm_Dtm_User.get_altitudes-528"><span class="linenos">528</span></a><span class="sd">        Args:</span>
</span><span id="Shm_Dtm_User.get_altitudes-529"><a href="#Shm_Dtm_User.get_altitudes-529"><span class="linenos">529</span></a><span class="sd">            lons (numpy.ndarray): Array of longitude coordinates</span>
</span><span id="Shm_Dtm_User.get_altitudes-530"><a href="#Shm_Dtm_User.get_altitudes-530"><span class="linenos">530</span></a><span class="sd">            lats (numpy.ndarray): Array of latitude coordinates</span>
</span><span id="Shm_Dtm_User.get_altitudes-531"><a href="#Shm_Dtm_User.get_altitudes-531"><span class="linenos">531</span></a>
</span><span id="Shm_Dtm_User.get_altitudes-532"><a href="#Shm_Dtm_User.get_altitudes-532"><span class="linenos">532</span></a><span class="sd">        Returns:</span>
</span><span id="Shm_Dtm_User.get_altitudes-533"><a href="#Shm_Dtm_User.get_altitudes-533"><span class="linenos">533</span></a><span class="sd">            numpy.ndarray: Array of altitude values with same shape as input coordinates</span>
</span><span id="Shm_Dtm_User.get_altitudes-534"><a href="#Shm_Dtm_User.get_altitudes-534"><span class="linenos">534</span></a>
</span><span id="Shm_Dtm_User.get_altitudes-535"><a href="#Shm_Dtm_User.get_altitudes-535"><span class="linenos">535</span></a><span class="sd">        Raises:</span>
</span><span id="Shm_Dtm_User.get_altitudes-536"><a href="#Shm_Dtm_User.get_altitudes-536"><span class="linenos">536</span></a><span class="sd">            ValueError: If input arrays have different shapes</span>
</span><span id="Shm_Dtm_User.get_altitudes-537"><a href="#Shm_Dtm_User.get_altitudes-537"><span class="linenos">537</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User.get_altitudes-538"><a href="#Shm_Dtm_User.get_altitudes-538"><span class="linenos">538</span></a>        <span class="k">if</span> <span class="n">lons</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">lats</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="Shm_Dtm_User.get_altitudes-539"><a href="#Shm_Dtm_User.get_altitudes-539"><span class="linenos">539</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;lons and lats must have the same shape.&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User.get_altitudes-540"><a href="#Shm_Dtm_User.get_altitudes-540"><span class="linenos">540</span></a>
</span><span id="Shm_Dtm_User.get_altitudes-541"><a href="#Shm_Dtm_User.get_altitudes-541"><span class="linenos">541</span></a>        <span class="k">return</span> <span class="n">get_altitudes_vect_nb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User.get_altitudes-542"><a href="#Shm_Dtm_User.get_altitudes-542"><span class="linenos">542</span></a>                                      <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User.get_altitudes-543"><a href="#Shm_Dtm_User.get_altitudes-543"><span class="linenos">543</span></a>                                      <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User.get_altitudes-544"><a href="#Shm_Dtm_User.get_altitudes-544"><span class="linenos">544</span></a>                                      <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="Shm_Dtm_User.get_altitudes-545"><a href="#Shm_Dtm_User.get_altitudes-545"><span class="linenos">545</span></a>                                      <span class="n">lons</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">lats</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">lons</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get altitudes for multiple coordinates.</p>

<p>Args:
    lons (numpy.ndarray): Array of longitude coordinates
    lats (numpy.ndarray): Array of latitude coordinates</p>

<p>Returns:
    numpy.ndarray: Array of altitude values with same shape as input coordinates</p>

<p>Raises:
    ValueError: If input arrays have different shapes</p>
</div>


                            </div>
                            <div id="Shm_Dtm_User.close" class="classattr">
                                        <input id="Shm_Dtm_User.close-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">close</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Shm_Dtm_User.close-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Shm_Dtm_User.close"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Shm_Dtm_User.close-547"><a href="#Shm_Dtm_User.close-547"><span class="linenos">547</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Shm_Dtm_User.close-548"><a href="#Shm_Dtm_User.close-548"><span class="linenos">548</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User.close-549"><a href="#Shm_Dtm_User.close-549"><span class="linenos">549</span></a><span class="sd">        Close shared memory blocks.</span>
</span><span id="Shm_Dtm_User.close-550"><a href="#Shm_Dtm_User.close-550"><span class="linenos">550</span></a>
</span><span id="Shm_Dtm_User.close-551"><a href="#Shm_Dtm_User.close-551"><span class="linenos">551</span></a><span class="sd">        This method safely closes all SharedMemoryArray instances.</span>
</span><span id="Shm_Dtm_User.close-552"><a href="#Shm_Dtm_User.close-552"><span class="linenos">552</span></a><span class="sd">        It handles potential errors during cleanup to ensure the process doesn&#39;t fail.</span>
</span><span id="Shm_Dtm_User.close-553"><a href="#Shm_Dtm_User.close-553"><span class="linenos">553</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Shm_Dtm_User.close-554"><a href="#Shm_Dtm_User.close-554"><span class="linenos">554</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Shm_Dtm_User.close-555"><a href="#Shm_Dtm_User.close-555"><span class="linenos">555</span></a>            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Shm_Dtm_User.close-556"><a href="#Shm_Dtm_User.close-556"><span class="linenos">556</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Shm_Dtm_User.close-557"><a href="#Shm_Dtm_User.close-557"><span class="linenos">557</span></a>                    <span class="n">obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Shm_Dtm_User.close-558"><a href="#Shm_Dtm_User.close-558"><span class="linenos">558</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> closed&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User.close-559"><a href="#Shm_Dtm_User.close-559"><span class="linenos">559</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Shm_Dtm_User.close-560"><a href="#Shm_Dtm_User.close-560"><span class="linenos">560</span></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing shared memory block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Shm_Dtm_User.close-561"><a href="#Shm_Dtm_User.close-561"><span class="linenos">561</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="o">=</span> <span class="p">{}</span>
</span></pre></div>


            <div class="docstring"><p>Close shared memory blocks.</p>

<p>This method safely closes all SharedMemoryArray instances.
It handles potential errors during cleanup to ensure the process doesn't fail.</p>
</div>


                            </div>
                            <div id="Shm_Dtm_User.tiles_1d_array" class="classattr">
                                        <input id="Shm_Dtm_User.tiles_1d_array-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">tiles_1d_array</span>

                <label class="view-source-button" for="Shm_Dtm_User.tiles_1d_array-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Shm_Dtm_User.tiles_1d_array"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Shm_Dtm_User.tiles_1d_array-563"><a href="#Shm_Dtm_User.tiles_1d_array-563"><span class="linenos">563</span></a>    <span class="nd">@property</span>
</span><span id="Shm_Dtm_User.tiles_1d_array-564"><a href="#Shm_Dtm_User.tiles_1d_array-564"><span class="linenos">564</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tiles_1d_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Shm_Dtm_User.tiles_1d_array-565"><a href="#Shm_Dtm_User.tiles_1d_array-565"><span class="linenos">565</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">if</span> <span class="s1">&#39;tiles_1d_array&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="k">else</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                            <div id="Shm_Dtm_User.tiles_indices_array" class="classattr">
                                        <input id="Shm_Dtm_User.tiles_indices_array-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">tiles_indices_array</span>

                <label class="view-source-button" for="Shm_Dtm_User.tiles_indices_array-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Shm_Dtm_User.tiles_indices_array"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Shm_Dtm_User.tiles_indices_array-567"><a href="#Shm_Dtm_User.tiles_indices_array-567"><span class="linenos">567</span></a>    <span class="nd">@property</span>
</span><span id="Shm_Dtm_User.tiles_indices_array-568"><a href="#Shm_Dtm_User.tiles_indices_array-568"><span class="linenos">568</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tiles_indices_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Shm_Dtm_User.tiles_indices_array-569"><a href="#Shm_Dtm_User.tiles_indices_array-569"><span class="linenos">569</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">if</span> <span class="s1">&#39;tiles_indices&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="k">else</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                            <div id="Shm_Dtm_User.tiles_nrows_array" class="classattr">
                                        <input id="Shm_Dtm_User.tiles_nrows_array-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">tiles_nrows_array</span>

                <label class="view-source-button" for="Shm_Dtm_User.tiles_nrows_array-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Shm_Dtm_User.tiles_nrows_array"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Shm_Dtm_User.tiles_nrows_array-571"><a href="#Shm_Dtm_User.tiles_nrows_array-571"><span class="linenos">571</span></a>    <span class="nd">@property</span>
</span><span id="Shm_Dtm_User.tiles_nrows_array-572"><a href="#Shm_Dtm_User.tiles_nrows_array-572"><span class="linenos">572</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tiles_nrows_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Shm_Dtm_User.tiles_nrows_array-573"><a href="#Shm_Dtm_User.tiles_nrows_array-573"><span class="linenos">573</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">if</span> <span class="s1">&#39;tiles_nrows&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="k">else</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                            <div id="Shm_Dtm_User.tiles_ncols_array" class="classattr">
                                        <input id="Shm_Dtm_User.tiles_ncols_array-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">tiles_ncols_array</span>

                <label class="view-source-button" for="Shm_Dtm_User.tiles_ncols_array-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Shm_Dtm_User.tiles_ncols_array"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Shm_Dtm_User.tiles_ncols_array-575"><a href="#Shm_Dtm_User.tiles_ncols_array-575"><span class="linenos">575</span></a>    <span class="nd">@property</span>
</span><span id="Shm_Dtm_User.tiles_ncols_array-576"><a href="#Shm_Dtm_User.tiles_ncols_array-576"><span class="linenos">576</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tiles_ncols_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Shm_Dtm_User.tiles_ncols_array-577"><a href="#Shm_Dtm_User.tiles_ncols_array-577"><span class="linenos">577</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span><span class="p">[</span><span class="s1">&#39;tiles_ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">if</span> <span class="s1">&#39;tiles_ncols&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shm_instances</span> <span class="k">else</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="main">
                            <input id="main-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">main</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="main-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#main"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="main-582"><a href="#main-582"><span class="linenos">582</span></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="main-583"><a href="#main-583"><span class="linenos">583</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main function handling command line arguments and execution.&quot;&quot;&quot;</span>
</span><span id="main-584"><a href="#main-584"><span class="linenos">584</span></a>    <span class="c1"># Configure logging only when running as main script</span>
</span><span id="main-585"><a href="#main-585"><span class="linenos">585</span></a>    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
</span><span id="main-586"><a href="#main-586"><span class="linenos">586</span></a>        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
</span><span id="main-587"><a href="#main-587"><span class="linenos">587</span></a>        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(module)s</span><span class="s1"> - </span><span class="si">%(funcName)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="main-588"><a href="#main-588"><span class="linenos">588</span></a>        <span class="n">handlers</span><span class="o">=</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()]</span>
</span><span id="main-589"><a href="#main-589"><span class="linenos">589</span></a>    <span class="p">)</span>
</span><span id="main-590"><a href="#main-590"><span class="linenos">590</span></a>
</span><span id="main-591"><a href="#main-591"><span class="linenos">591</span></a>    <span class="c1"># Create main argument parser</span>
</span><span id="main-592"><a href="#main-592"><span class="linenos">592</span></a>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
</span><span id="main-593"><a href="#main-593"><span class="linenos">593</span></a>        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Load preprocessed SRTM15 tiles and retrieve altitudes for specified coordinates using shared memory.&#39;</span><span class="p">,</span>
</span><span id="main-594"><a href="#main-594"><span class="linenos">594</span></a>        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
</span><span id="main-595"><a href="#main-595"><span class="linenos">595</span></a>        <span class="n">epilog</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="main-596"><a href="#main-596"><span class="linenos">596</span></a><span class="s1">Examples:</span>
</span><span id="main-597"><a href="#main-597"><span class="linenos">597</span></a><span class="s1">  Load data and keep shared memory available:</span>
</span><span id="main-598"><a href="#main-598"><span class="linenos">598</span></a><span class="s1">    python -m Line_Of_Sight.get_altitudes_dtm_mp loader input.zip</span>
</span><span id="main-599"><a href="#main-599"><span class="linenos">599</span></a>
</span><span id="main-600"><a href="#main-600"><span class="linenos">600</span></a><span class="s1">  Get altitude using shared memory blocks:</span>
</span><span id="main-601"><a href="#main-601"><span class="linenos">601</span></a><span class="s1">    python -m Line_Of_Sight.get_altitudes_dtm_mp user --tiles_1d_array tiles_1d_array_1234 --tiles_indices tiles_indices_1234 --tiles_nrows tiles_nrows_1234 --tiles_ncols tiles_ncols_1234 --grid-size 1000 55.22 -21.40 55.83 -20.86</span>
</span><span id="main-602"><a href="#main-602"><span class="linenos">602</span></a>
</span><span id="main-603"><a href="#main-603"><span class="linenos">603</span></a><span class="s1">  Standalone mode with visualization:</span>
</span><span id="main-604"><a href="#main-604"><span class="linenos">604</span></a><span class="s1">    python -m Line_Of_Sight.get_altitudes_dtm_mp standalone input.zip --grid-size 1000 55.22 -21.40 55.83 -20.86</span>
</span><span id="main-605"><a href="#main-605"><span class="linenos">605</span></a>
</span><span id="main-606"><a href="#main-606"><span class="linenos">606</span></a><span class="s1">Note:</span>
</span><span id="main-607"><a href="#main-607"><span class="linenos">607</span></a><span class="s1">  In user mode, only shared memory block names are required, as metadata (shape and dtype)</span>
</span><span id="main-608"><a href="#main-608"><span class="linenos">608</span></a><span class="s1">  are stored within the shared memory blocks using struct.</span>
</span><span id="main-609"><a href="#main-609"><span class="linenos">609</span></a><span class="s1">        &#39;&#39;&#39;</span>
</span><span id="main-610"><a href="#main-610"><span class="linenos">610</span></a>    <span class="p">)</span>
</span><span id="main-611"><a href="#main-611"><span class="linenos">611</span></a>
</span><span id="main-612"><a href="#main-612"><span class="linenos">612</span></a>    <span class="c1"># Create subparsers for different modes</span>
</span><span id="main-613"><a href="#main-613"><span class="linenos">613</span></a>    <span class="n">subparsers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Mode to run in&#39;</span><span class="p">)</span>
</span><span id="main-614"><a href="#main-614"><span class="linenos">614</span></a>    <span class="n">parser_load</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;loader&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run in loader mode. Loads the elevation data from a ZIP file into shared memory.&#39;</span><span class="p">)</span>
</span><span id="main-615"><a href="#main-615"><span class="linenos">615</span></a>    <span class="n">parser_stnd</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;standalone&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run in standalone mode. Combines the functionality of both loader and user modes and generates a heatmap.&#39;</span><span class="p">)</span>
</span><span id="main-616"><a href="#main-616"><span class="linenos">616</span></a>    <span class="n">parser_user</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run in user mode. Uses the shared memory blocks to retrieve altitude for a single coordinate pair.&#39;</span><span class="p">)</span>
</span><span id="main-617"><a href="#main-617"><span class="linenos">617</span></a>
</span><span id="main-618"><a href="#main-618"><span class="linenos">618</span></a>    <span class="c1"># Parser for loader mode and standalone mode</span>
</span><span id="main-619"><a href="#main-619"><span class="linenos">619</span></a>    <span class="n">parser_load</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Input ZIP file name containing the elevation data.&#39;</span><span class="p">)</span>
</span><span id="main-620"><a href="#main-620"><span class="linenos">620</span></a>    <span class="n">parser_stnd</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Input ZIP file name containing the elevation data.&#39;</span><span class="p">)</span>
</span><span id="main-621"><a href="#main-621"><span class="linenos">621</span></a>
</span><span id="main-622"><a href="#main-622"><span class="linenos">622</span></a>    <span class="c1"># Parser for user mode and standalone mode</span>
</span><span id="main-623"><a href="#main-623"><span class="linenos">623</span></a>    <span class="n">parser_user</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;lonlat1&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;corner1: Longitude in decimal degrees (-180 to 180), Latitude in decimal degrees (-90 to 90)&#39;</span><span class="p">)</span>
</span><span id="main-624"><a href="#main-624"><span class="linenos">624</span></a>    <span class="n">parser_stnd</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;lonlat1&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;corner1: Longitude in decimal degrees (-180 to 180), Latitude in decimal degrees (-90 to 90)&#39;</span><span class="p">)</span>
</span><span id="main-625"><a href="#main-625"><span class="linenos">625</span></a>    
</span><span id="main-626"><a href="#main-626"><span class="linenos">626</span></a>    <span class="n">parser_user</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;lonlat2&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;corner2: Longitude in decimal degrees (-180 to 180), Latitude in decimal degrees (-90 to 90)&#39;</span><span class="p">)</span>
</span><span id="main-627"><a href="#main-627"><span class="linenos">627</span></a>    <span class="n">parser_stnd</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;lonlat2&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;corner2: Longitude in decimal degrees (-180 to 180), Latitude in decimal degrees (-90 to 90)&#39;</span><span class="p">)</span>
</span><span id="main-628"><a href="#main-628"><span class="linenos">628</span></a>    
</span><span id="main-629"><a href="#main-629"><span class="linenos">629</span></a>    <span class="n">parser_user</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--grid-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of points per axis for heatmap (default: 1000)&#39;</span><span class="p">)</span>
</span><span id="main-630"><a href="#main-630"><span class="linenos">630</span></a>    <span class="n">parser_stnd</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--grid-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of points per axis for heatmap (default: 1000)&#39;</span><span class="p">)</span>
</span><span id="main-631"><a href="#main-631"><span class="linenos">631</span></a>    
</span><span id="main-632"><a href="#main-632"><span class="linenos">632</span></a>    <span class="c1"># Parser for user mode</span>
</span><span id="main-633"><a href="#main-633"><span class="linenos">633</span></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_indices&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_nrows&#39;</span><span class="p">,</span> <span class="s1">&#39;tiles_ncols&#39;</span><span class="p">):</span>
</span><span id="main-634"><a href="#main-634"><span class="linenos">634</span></a>        <span class="n">parser_user</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Name of the shared memory block for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">. Example: &quot;tiles_1d_array_1234&quot;&#39;</span><span class="p">)</span>
</span><span id="main-635"><a href="#main-635"><span class="linenos">635</span></a>
</span><span id="main-636"><a href="#main-636"><span class="linenos">636</span></a>    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span><span id="main-637"><a href="#main-637"><span class="linenos">637</span></a>    
</span><span id="main-638"><a href="#main-638"><span class="linenos">638</span></a>    <span class="c1"># Standalone mode &amp; Loader mode: Load data into shared memory and display connection info</span>
</span><span id="main-639"><a href="#main-639"><span class="linenos">639</span></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;loader&#39;</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;standalone&#39;</span><span class="p">:</span>
</span><span id="main-640"><a href="#main-640"><span class="linenos">640</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading DTM file: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="main-641"><a href="#main-641"><span class="linenos">641</span></a>        <span class="n">shm_dtm_loader</span> <span class="o">=</span> <span class="n">Shm_Dtm_Loader</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
</span><span id="main-642"><a href="#main-642"><span class="linenos">642</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DTM file loaded successfully.&quot;</span><span class="p">)</span>
</span><span id="main-643"><a href="#main-643"><span class="linenos">643</span></a>
</span><span id="main-644"><a href="#main-644"><span class="linenos">644</span></a>    <span class="c1"># Loader mode: print information and wait for interruption then exit </span>
</span><span id="main-645"><a href="#main-645"><span class="linenos">645</span></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;loader&#39;</span><span class="p">:</span>
</span><span id="main-646"><a href="#main-646"><span class="linenos">646</span></a>        <span class="c1"># Generate example command for user mode</span>
</span><span id="main-647"><a href="#main-647"><span class="linenos">647</span></a>        <span class="n">cmd_shm_params</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">shm_dtm_loader</span><span class="o">.</span><span class="n">shm_names</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
</span><span id="main-648"><a href="#main-648"><span class="linenos">648</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Examples command for user mode:&#39;</span> <span class="o">+</span>
</span><span id="main-649"><a href="#main-649"><span class="linenos">649</span></a>        <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="main-650"><a href="#main-650"><span class="linenos">650</span></a><span class="s1">```</span>
</span><span id="main-651"><a href="#main-651"><span class="linenos">651</span></a><span class="s1">python -m Line_Of_Sight.get_altitudes_dtm_mp user </span><span class="si">{</span><span class="n">cmd_shm_params</span><span class="si">}</span><span class="s1"> -5.20 48.20 -4.60 48.60 --grid-size 100</span>
</span><span id="main-652"><a href="#main-652"><span class="linenos">652</span></a><span class="s1">python -m Line_Of_Sight.get_altitudes_dtm_mp user </span><span class="si">{</span><span class="n">cmd_shm_params</span><span class="si">}</span><span class="s1"> -17.00 27.90 -16.11 28.61</span>
</span><span id="main-653"><a href="#main-653"><span class="linenos">653</span></a><span class="s1">python -m Line_Of_Sight.get_altitudes_dtm_mp user </span><span class="si">{</span><span class="n">cmd_shm_params</span><span class="si">}</span><span class="s1"> 55.22 -21.40 55.83 -20.86</span>
</span><span id="main-654"><a href="#main-654"><span class="linenos">654</span></a><span class="s1">python -m Line_Of_Sight.get_altitudes_dtm_mp user </span><span class="si">{</span><span class="n">cmd_shm_params</span><span class="si">}</span><span class="s1"> -180 -90 180 90 --grid-size 3000</span>
</span><span id="main-655"><a href="#main-655"><span class="linenos">655</span></a><span class="s1">python -m Line_Of_Sight.line_of_sight </span><span class="si">{</span><span class="n">cmd_shm_params</span><span class="si">}</span><span class="s1"> --origin -3.2 47.5 30 --target -3.3 47.6 60</span>
</span><span id="main-656"><a href="#main-656"><span class="linenos">656</span></a><span class="s1">```&#39;&#39;&#39;</span><span class="p">)</span>
</span><span id="main-657"><a href="#main-657"><span class="linenos">657</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- Mode: loader --&#39;</span><span class="p">)</span>
</span><span id="main-658"><a href="#main-658"><span class="linenos">658</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loader mode completed. Shared memory blocks are ready for use: Press Ctrl+C to exit...&quot;</span><span class="p">)</span>
</span><span id="main-659"><a href="#main-659"><span class="linenos">659</span></a>
</span><span id="main-660"><a href="#main-660"><span class="linenos">660</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="main-661"><a href="#main-661"><span class="linenos">661</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="main-662"><a href="#main-662"><span class="linenos">662</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="main-663"><a href="#main-663"><span class="linenos">663</span></a>        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="main-664"><a href="#main-664"><span class="linenos">664</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Received keyboard interrupt.&quot;</span><span class="p">)</span>
</span><span id="main-665"><a href="#main-665"><span class="linenos">665</span></a>    
</span><span id="main-666"><a href="#main-666"><span class="linenos">666</span></a>    <span class="c1"># Standalone mode &amp; User mode: Retrieve shared memory names, Connect to shared memory and Retrieve altitudes</span>
</span><span id="main-667"><a href="#main-667"><span class="linenos">667</span></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;standalone&#39;</span><span class="p">:</span>
</span><span id="main-668"><a href="#main-668"><span class="linenos">668</span></a>        <span class="n">shm_names</span> <span class="o">=</span> <span class="n">shm_dtm_loader</span><span class="o">.</span><span class="n">shm_names</span>
</span><span id="main-669"><a href="#main-669"><span class="linenos">669</span></a>    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span><span class="p">:</span>
</span><span id="main-670"><a href="#main-670"><span class="linenos">670</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">resource_tracker</span>
</span><span id="main-671"><a href="#main-671"><span class="linenos">671</span></a>        <span class="n">resource_tracker</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span> <span class="n">rtype</span><span class="p">:</span> <span class="kc">None</span>
</span><span id="main-672"><a href="#main-672"><span class="linenos">672</span></a>
</span><span id="main-673"><a href="#main-673"><span class="linenos">673</span></a>        <span class="c1"># User mode: Connect to shared memory and retrieve altitude</span>
</span><span id="main-674"><a href="#main-674"><span class="linenos">674</span></a>        <span class="n">shm_names</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tiles_1d_array&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">tiles_1d_array</span><span class="p">,</span>
</span><span id="main-675"><a href="#main-675"><span class="linenos">675</span></a>                     <span class="s1">&#39;tiles_indices&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">tiles_indices</span><span class="p">,</span>
</span><span id="main-676"><a href="#main-676"><span class="linenos">676</span></a>                     <span class="s1">&#39;tiles_nrows&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">tiles_nrows</span><span class="p">,</span>
</span><span id="main-677"><a href="#main-677"><span class="linenos">677</span></a>                     <span class="s1">&#39;tiles_ncols&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">tiles_ncols</span><span class="p">}</span>
</span><span id="main-678"><a href="#main-678"><span class="linenos">678</span></a>
</span><span id="main-679"><a href="#main-679"><span class="linenos">679</span></a>    <span class="c1"># Standalone mode &amp; User mode: Connect to shared memory and retrieve altitude</span>
</span><span id="main-680"><a href="#main-680"><span class="linenos">680</span></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;standalone&#39;</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span><span class="p">:</span>
</span><span id="main-681"><a href="#main-681"><span class="linenos">681</span></a>        <span class="c1"># Import matplotlib only when needed for standalone and user mode</span>
</span><span id="main-682"><a href="#main-682"><span class="linenos">682</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="main-683"><a href="#main-683"><span class="linenos">683</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearSegmentedColormap</span>
</span><span id="main-684"><a href="#main-684"><span class="linenos">684</span></a>
</span><span id="main-685"><a href="#main-685"><span class="linenos">685</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="main-686"><a href="#main-686"><span class="linenos">686</span></a>            <span class="n">shm_dtm_user</span> <span class="o">=</span> <span class="n">Shm_Dtm_User</span><span class="p">(</span><span class="n">shm_names</span><span class="p">)</span>
</span><span id="main-687"><a href="#main-687"><span class="linenos">687</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Shared memory blocks loaded successfully.&quot;</span><span class="p">)</span>
</span><span id="main-688"><a href="#main-688"><span class="linenos">688</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="main-689"><a href="#main-689"><span class="linenos">689</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in mode: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="main-690"><a href="#main-690"><span class="linenos">690</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="main-691"><a href="#main-691"><span class="linenos">691</span></a>        
</span><span id="main-692"><a href="#main-692"><span class="linenos">692</span></a>        <span class="k">class</span><span class="w"> </span><span class="nc">FormatCoord</span><span class="p">:</span>
</span><span id="main-693"><a href="#main-693"><span class="linenos">693</span></a>            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">extent</span><span class="p">):</span>
</span><span id="main-694"><a href="#main-694"><span class="linenos">694</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">data</span>   <span class="o">=</span> <span class="n">data</span>
</span><span id="main-695"><a href="#main-695"><span class="linenos">695</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">extent</span>
</span><span id="main-696"><a href="#main-696"><span class="linenos">696</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nrows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="main-697"><a href="#main-697"><span class="linenos">697</span></a>
</span><span id="main-698"><a href="#main-698"><span class="linenos">698</span></a>            <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="main-699"><a href="#main-699"><span class="linenos">699</span></a>                <span class="n">col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">))</span>
</span><span id="main-700"><a href="#main-700"><span class="linenos">700</span></a>                <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrows</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">))</span>
</span><span id="main-701"><a href="#main-701"><span class="linenos">701</span></a>                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrows</span><span class="p">:</span>
</span><span id="main-702"><a href="#main-702"><span class="linenos">702</span></a>                    <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
</span><span id="main-703"><a href="#main-703"><span class="linenos">703</span></a>                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;x=</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y=</span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, value=</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, col=</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, row=</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="main-704"><a href="#main-704"><span class="linenos">704</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="main-705"><a href="#main-705"><span class="linenos">705</span></a>                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;x=</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y=</span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, value=NaN, col=</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, row=</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="main-706"><a href="#main-706"><span class="linenos">706</span></a>
</span><span id="main-707"><a href="#main-707"><span class="linenos">707</span></a>        <span class="k">for</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="ow">in</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lonlat1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat2</span><span class="p">):</span>
</span><span id="main-708"><a href="#main-708"><span class="linenos">708</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Long: </span><span class="si">{</span><span class="n">lon</span><span class="si">:</span><span class="s1">11.6f</span><span class="si">}</span><span class="s1">, Lat: </span><span class="si">{</span><span class="n">lat</span><span class="si">:</span><span class="s1">10.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="main-709"><a href="#main-709"><span class="linenos">709</span></a>            <span class="n">alt</span> <span class="o">=</span> <span class="n">shm_dtm_user</span><span class="o">.</span><span class="n">get_altitude</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
</span><span id="main-710"><a href="#main-710"><span class="linenos">710</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;alt: </span><span class="si">{</span><span class="n">alt</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">m&#39;</span><span class="p">)</span>
</span><span id="main-711"><a href="#main-711"><span class="linenos">711</span></a>        
</span><span id="main-712"><a href="#main-712"><span class="linenos">712</span></a>        <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lonlat1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lonlat2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="main-713"><a href="#main-713"><span class="linenos">713</span></a>        <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lonlat1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lonlat2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">lonlat1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="main-714"><a href="#main-714"><span class="linenos">714</span></a>
</span><span id="main-715"><a href="#main-715"><span class="linenos">715</span></a>        <span class="n">lon_stp</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_max</span> <span class="o">-</span> <span class="n">lon_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">grid_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="main-716"><a href="#main-716"><span class="linenos">716</span></a>        <span class="n">lat_stp</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_max</span> <span class="o">-</span> <span class="n">lat_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">grid_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="main-717"><a href="#main-717"><span class="linenos">717</span></a>        <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="main-718"><a href="#main-718"><span class="linenos">718</span></a>        <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="main-719"><a href="#main-719"><span class="linenos">719</span></a>        <span class="n">lons_mesh</span><span class="p">,</span> <span class="n">lats_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
</span><span id="main-720"><a href="#main-720"><span class="linenos">720</span></a>        
</span><span id="main-721"><a href="#main-721"><span class="linenos">721</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;shm_dtm_user.get_altitudes(lons_mesh, lats_mesh)&#39;</span><span class="p">)</span>
</span><span id="main-722"><a href="#main-722"><span class="linenos">722</span></a>        <span class="n">alts</span> <span class="o">=</span> <span class="n">shm_dtm_user</span><span class="o">.</span><span class="n">get_altitudes</span><span class="p">(</span><span class="n">lons_mesh</span><span class="p">,</span> <span class="n">lats_mesh</span><span class="p">)</span> <span class="c1"># Numba warmpup</span>
</span><span id="main-723"><a href="#main-723"><span class="linenos">723</span></a>        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="main-724"><a href="#main-724"><span class="linenos">724</span></a>        <span class="n">alts</span> <span class="o">=</span> <span class="n">shm_dtm_user</span><span class="o">.</span><span class="n">get_altitudes</span><span class="p">(</span><span class="n">lons_mesh</span><span class="p">,</span> <span class="n">lats_mesh</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># Get altitudes for the grid</span>
</span><span id="main-725"><a href="#main-725"><span class="linenos">725</span></a>        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="main-726"><a href="#main-726"><span class="linenos">726</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time to get altitudes: </span><span class="si">{</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>
</span><span id="main-727"><a href="#main-727"><span class="linenos">727</span></a>
</span><span id="main-728"><a href="#main-728"><span class="linenos">728</span></a>
</span><span id="main-729"><a href="#main-729"><span class="linenos">729</span></a>        <span class="c1">#relief_colors = [&quot;aquamarine&quot;, &quot;darkgreen&quot;, &quot;palegreen&quot;, &quot;green&quot;, &quot;bisque&quot;, &quot;darkgoldenrod&quot;, &quot;burlywood&quot;, &quot;saddlebrown&quot;, &quot;palegoldenrod&quot;, &quot;crimson&quot;, &quot;salmon&quot;, &quot;red&quot;]</span>
</span><span id="main-730"><a href="#main-730"><span class="linenos">730</span></a>        <span class="n">color_sea_level</span> <span class="o">=</span> <span class="s2">&quot;#2B7BBA&quot;</span>  <span class="c1"># Deep blue for sea level</span>
</span><span id="main-731"><a href="#main-731"><span class="linenos">731</span></a>        <span class="n">relief_colors</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="main-732"><a href="#main-732"><span class="linenos">732</span></a>            <span class="s2">&quot;#007000&quot;</span><span class="p">,</span>
</span><span id="main-733"><a href="#main-733"><span class="linenos">733</span></a>            <span class="s2">&quot;#6B8E00&quot;</span><span class="p">,</span>  
</span><span id="main-734"><a href="#main-734"><span class="linenos">734</span></a>            <span class="s2">&quot;#00FF00&quot;</span><span class="p">,</span>
</span><span id="main-735"><a href="#main-735"><span class="linenos">735</span></a>            <span class="s2">&quot;#FFFF00&quot;</span><span class="p">,</span>
</span><span id="main-736"><a href="#main-736"><span class="linenos">736</span></a>            <span class="s2">&quot;#CD853F&quot;</span><span class="p">,</span>
</span><span id="main-737"><a href="#main-737"><span class="linenos">737</span></a>            <span class="s2">&quot;#A0522D&quot;</span><span class="p">,</span>
</span><span id="main-738"><a href="#main-738"><span class="linenos">738</span></a>            <span class="s2">&quot;#703810&quot;</span><span class="p">,</span>
</span><span id="main-739"><a href="#main-739"><span class="linenos">739</span></a>            <span class="s2">&quot;#404040&quot;</span><span class="p">,</span>
</span><span id="main-740"><a href="#main-740"><span class="linenos">740</span></a>            <span class="s2">&quot;#808080&quot;</span><span class="p">,</span>
</span><span id="main-741"><a href="#main-741"><span class="linenos">741</span></a>            <span class="s2">&quot;#FFFFFF&quot;</span><span class="p">,</span>
</span><span id="main-742"><a href="#main-742"><span class="linenos">742</span></a>            <span class="p">]</span>
</span><span id="main-743"><a href="#main-743"><span class="linenos">743</span></a>
</span><span id="main-744"><a href="#main-744"><span class="linenos">744</span></a>        <span class="n">alt_gran</span> <span class="o">=</span> <span class="mf">20.</span>  <span class="c1"># Granularity of altitude intervals in meters</span>
</span><span id="main-745"><a href="#main-745"><span class="linenos">745</span></a>        <span class="n">alt_min</span>  <span class="o">=</span> <span class="mf">0.</span>
</span><span id="main-746"><a href="#main-746"><span class="linenos">746</span></a>        <span class="n">nb_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">relief_colors</span><span class="p">)</span> <span class="c1"># One node for each color, to be used in LinearSegmentedColormap</span>
</span><span id="main-747"><a href="#main-747"><span class="linenos">747</span></a>        <span class="n">nb_steps</span> <span class="o">=</span> <span class="n">nb_nodes</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Exclude water deep blue and one boundary color</span>
</span><span id="main-748"><a href="#main-748"><span class="linenos">748</span></a>        <span class="n">alt_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">alts</span><span class="p">)</span><span class="o">-</span><span class="n">alt_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nb_steps</span><span class="p">)</span> <span class="o">/</span> <span class="n">alt_gran</span><span class="p">)</span> <span class="o">*</span> <span class="n">alt_gran</span>
</span><span id="main-749"><a href="#main-749"><span class="linenos">749</span></a>        <span class="n">alt_max</span>  <span class="o">=</span> <span class="n">alt_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">nb_steps</span><span class="p">)</span> <span class="o">*</span> <span class="n">alt_step</span>
</span><span id="main-750"><a href="#main-750"><span class="linenos">750</span></a>
</span><span id="main-751"><a href="#main-751"><span class="linenos">751</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Altitude range        : </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">alts</span><span class="p">)</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">m to </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">alts</span><span class="p">)</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">m&#39;</span><span class="p">)</span>
</span><span id="main-752"><a href="#main-752"><span class="linenos">752</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Working altitude range: </span><span class="si">{</span><span class="n">alt_min</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">m to </span><span class="si">{</span><span class="n">alt_max</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">m&#39;</span><span class="p">)</span>
</span><span id="main-753"><a href="#main-753"><span class="linenos">753</span></a>
</span><span id="main-754"><a href="#main-754"><span class="linenos">754</span></a>        <span class="c1"># Contour_levels from 0. to max altitude corresponding to each color (except water deep blue) and each interval in relief_colors</span>
</span><span id="main-755"><a href="#main-755"><span class="linenos">755</span></a>        <span class="n">contour_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">alt_min</span><span class="p">,</span> <span class="n">alt_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">nb_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="main-756"><a href="#main-756"><span class="linenos">756</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Contour levels: </span><span class="si">{</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">level</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">contour_levels</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="main-757"><a href="#main-757"><span class="linenos">757</span></a>
</span><span id="main-758"><a href="#main-758"><span class="linenos">758</span></a>        <span class="n">nodes</span>      <span class="o">=</span> <span class="n">contour_levels</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Use every second level for the colormap nodes</span>
</span><span id="main-759"><a href="#main-759"><span class="linenos">759</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Nodes: </span><span class="si">{</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">node</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">nodes</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="main-760"><a href="#main-760"><span class="linenos">760</span></a>        <span class="n">nodes_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">nodes</span><span class="o">-</span><span class="n">nodes</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">nodes</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>  <span class="c1"># Shift nodes to start from 0</span>
</span><span id="main-761"><a href="#main-761"><span class="linenos">761</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Nodes (normalized): </span><span class="si">{</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">nodes_norm</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="main-762"><a href="#main-762"><span class="linenos">762</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes_norm</span><span class="p">)</span> <span class="o">==</span> <span class="n">nb_nodes</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Number of nodes </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes_norm</span><span class="p">)</span><span class="si">}</span><span class="s1"> does not match number of colors </span><span class="si">{</span><span class="n">nb_nodes</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="main-763"><a href="#main-763"><span class="linenos">763</span></a>        <span class="n">cmap</span>   <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;relief_cmap&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">nodes_norm</span><span class="p">,</span> <span class="n">relief_colors</span><span class="p">)))</span>
</span><span id="main-764"><a href="#main-764"><span class="linenos">764</span></a>        <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color_sea_level</span><span class="p">)</span>  <span class="c1"># Set color for NaN values</span>
</span><span id="main-765"><a href="#main-765"><span class="linenos">765</span></a>
</span><span id="main-766"><a href="#main-766"><span class="linenos">766</span></a>        <span class="c1">#alts[alts &lt;= 0.0] = np.nan  # Set invalid altitudes to NaN for better visualization</span>
</span><span id="main-767"><a href="#main-767"><span class="linenos">767</span></a>        <span class="c1">#alts_masked = np.ma.masked_array(alts, mask=(alts &lt;= 0.), fill_value=-20)</span>
</span><span id="main-768"><a href="#main-768"><span class="linenos">768</span></a>        <span class="n">alts_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alts</span><span class="p">)</span>
</span><span id="main-769"><a href="#main-769"><span class="linenos">769</span></a>        <span class="n">alts_masked</span><span class="p">[</span><span class="n">alts_masked</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># Set</span>
</span><span id="main-770"><a href="#main-770"><span class="linenos">770</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="s1">&#39;Relief&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</span><span id="main-771"><a href="#main-771"><span class="linenos">771</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">alts_masked</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">lon_min</span><span class="o">-</span><span class="n">lon_stp</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">lon_max</span><span class="o">+</span><span class="n">lon_stp</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">lat_min</span><span class="o">-</span><span class="n">lat_stp</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">lat_max</span><span class="o">+</span><span class="n">lat_stp</span><span class="o">/</span><span class="mf">2.</span><span class="p">],</span>
</span><span id="main-772"><a href="#main-772"><span class="linenos">772</span></a>                       <span class="n">vmin</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>  <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,)</span>
</span><span id="main-773"><a href="#main-773"><span class="linenos">773</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">format_coord</span> <span class="o">=</span> <span class="n">FormatCoord</span><span class="p">(</span><span class="n">alts</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">])</span>
</span><span id="main-774"><a href="#main-774"><span class="linenos">774</span></a>
</span><span id="main-775"><a href="#main-775"><span class="linenos">775</span></a>        <span class="c1"># Plot contour lines (black lines, linewidth 0.8)</span>
</span><span id="main-776"><a href="#main-776"><span class="linenos">776</span></a>        <span class="n">contours</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">lons_mesh</span><span class="p">,</span> <span class="n">lats_mesh</span><span class="p">,</span> <span class="n">alts</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">contour_levels</span><span class="p">,</span>
</span><span id="main-777"><a href="#main-777"><span class="linenos">777</span></a>                              <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;#DDDDDD&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</span><span id="main-778"><a href="#main-778"><span class="linenos">778</span></a>        <span class="c1">#contourfs = ax.contourf(lons_mesh, lats_mesh, alts, levels=contour_levels[::2],</span>
</span><span id="main-779"><a href="#main-779"><span class="linenos">779</span></a>        <span class="c1">#                      linewidths=0.2, cmap=cmap, alpha=0.5)</span>
</span><span id="main-780"><a href="#main-780"><span class="linenos">780</span></a>
</span><span id="main-781"><a href="#main-781"><span class="linenos">781</span></a>        <span class="c1"># Optionally add labels to contours</span>
</span><span id="main-782"><a href="#main-782"><span class="linenos">782</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">contours</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.0f</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="main-783"><a href="#main-783"><span class="linenos">783</span></a>        
</span><span id="main-784"><a href="#main-784"><span class="linenos">784</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">contour_levels</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Altitude (m)&#39;</span><span class="p">)</span>
</span><span id="main-785"><a href="#main-785"><span class="linenos">785</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;figure_Relief_</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">grid_size</span><span class="si">}</span><span class="s1">x</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">grid_size</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>
</span><span id="main-786"><a href="#main-786"><span class="linenos">786</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="main-787"><a href="#main-787"><span class="linenos">787</span></a>        
</span><span id="main-788"><a href="#main-788"><span class="linenos">788</span></a>        <span class="n">shm_dtm_user</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="main-789"><a href="#main-789"><span class="linenos">789</span></a>
</span><span id="main-790"><a href="#main-790"><span class="linenos">790</span></a>    <span class="c1"># Standalone mode &amp; Loader mode: Close loader shared memory</span>
</span><span id="main-791"><a href="#main-791"><span class="linenos">791</span></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;loader&#39;</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;standalone&#39;</span><span class="p">:</span>
</span><span id="main-792"><a href="#main-792"><span class="linenos">792</span></a>        <span class="n">shm_dtm_loader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Main function handling command line arguments and execution.</p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>